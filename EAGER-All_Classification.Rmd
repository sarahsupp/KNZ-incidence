---
title: "EAGER_ALL"
author: "Maya Parker-Smith"
date: "2023-08-17"
output: 
  html_document:
    smart: no
    theme: flatly
    float: yes
    css: "style.css"    
editor_options: 
  chunk_output_type: console
mainfont: Arial
mathfont: Arial
fontsize: 12pt
---

#  {.tabset .tabset-pills .tabset-fade}
```{r setup, include=FALSE}
## Clear environment 
rm(list=ls())


##Libraries
library(tidyverse)
library(cowplot)
library(bbmle)
library(lmerTest)
library(car)
library(readxl)
library(multcomp)
library(readr)
library(incidence)
library(vegan)
library(goeveg)
library(randtests)
library(reshape2)
```

# NSF - EAGER: ADD IN TITLE OF PROJECT AND SUCH

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

##Functions
In this section, I am wrting the functions that we will then apply to every dataset. This includes the "getTrends" function that will classify each species from each watershed into distinct categories, which include: 
- "Always_present" -> species at watershed is present in every year in which data was collected
- "Always_absent" -> though species was detected at other surrounding watersheds, it was never present at the specified watershed during the duration of the study
- "Random" -> species is detected sporadically for the duration of the study at watershed
- "Recurrent" -> species is detected in consecutive years (and also not detected) in a distinct pattern
- "Increasing" -> the presence of the species increases throughout the duration of the study
- "Decreasing' -> the presence of the species decreases throughout the duration of the study

```{r}

getTrends <- function(x) {
  #input (x) is a single row of a matrix where the species are rows and the columns are each year with 1/0 values (1=present, 0=absent). 
  #So you need to iterate each row separately to get the results
  # Output is a list with 6 items, that represents the classification results for a single species
  
  #create an object the same length as x that defines early vs late years
  time <- rep("late", length(x))
  time[1:(round(length(x)/2))] <- "early"
  
  # make a table that tells you how many 0s and 1s are in the early and the late halves of the time series
  z_x <- table(x,time)
  
  #find the time-series length (number of years)
  tslen <- length(x)

  # counts the number of years the species was present
  tssum <- sum(x)
 
  # create an empty vector to store results in for the next for loop
   l <- c()
  
  # identifies when a change from a 0 to a 1 or vice versa happens
  for(k in 1:(tslen-1)) {
    j <- abs(x[k+1] - x[k])
    l <- c(l, j)
    v <- sum(l)
  }
  
  # identifies if the species was present (1) or absent(0)
   # at the beginning of the timeseries
   # for our study, we generally ignore the baseline
  bsline <- x[1]
  
  # If all the values are 0, it is always absent
  if (tssum == 0) {
    p_val <- NA
    f_early <- NA
    f_late <- NA
    runsTestPV <- NA
    trend <- NA
    trendPlus <- NA
    cat <- "always_absent"
  }
  
  # if all the values are 1, it is always present
  else if (tslen == tssum) {
    p_val <- NA
    f_early <- NA
    f_late <- NA
    runsTestPV<-NA
    trend<-NA
    trendPlus<-NA
    cat<-"always_present"
  }
  
  else {
     
    #adds rownames to the z_x table
    rownames(z_x) <- c("absent","present")
    
    # get p value for the chi-squared test
    p_val <- chisq.test(z_x)$p.val
    
    # get early and late fractions
    # for each the early and the late parts of the time series:
    #    the number of years it was present divided by the number of years
    f_early <- z_x["present","early"] / sum(z_x[,1]) 
    f_late <- z_x["present","late"] / sum(z_x[,2])
   
    if((f_early > f_late) & (p_val <= 0.05)) {
      trend <- -1
      cat = "decreasing"
    }
    
    if((f_early < f_late) & (p_val <= 0.05)) {
      trend <- 1
      cat = "increasing"
    }
    
    # Chi-squared test not significant
    if(p_val > 0.05) trend<-0
    
    #conduct a runs test on the time-series
    runsPV <- tseries::runs.test(as.factor(x), alternative= "less")
    runsTestPV <- runsPV$p.value
    
    # if Chi-sq test insignif. and the runs test was significant
    if((p_val > 0.05) & (runsTestPV < 0.05)) {
      trendPlus<-10
      cat="recurrent"
    }
    
    # if chi-sq insignif. and the runs test insignif.
    if((p_val > 0.05) & (runsTestPV > 0.05)){
      trendPlus<-5
      cat="random"
    }
    
  }
  
  # for each species, record the summary statistics
  statSumm <- tibble("chiPval"=p_val, "runsPval"=runsTestPV, 
                 "trend"=trend, "bsline"=bsline, "category"=cat)
  
  return(statSumm)
} 


```

##Small-mammals (1992 - 2013)
This section is dedicated to cleaning and classifying the species for the small-mammal trapping dataset. 

Data was collected from 1981 to 2013, but we are only looking at data collected between 1992 to 2013 because bison weren't introduced to the bison plots until 1992.

Watersheds that are included in dataset: 4B, *4F*, N4D, N20B, 1D, 20B, N1B.
*italicized* = watersheds we didn't include in our analysis
Reasons:
*4F* = Removed to have equal representation of comparable treatments; there are 2 watersheds with the 4-year fire-interval + ungrazed treatment (4B and 4F), and only one watershed with the 4-year fire-interval + grazed treatment (N4D). We removed 4F because 4B is more commonly sampled in our other datasets. We did do a Bray-Curtis Dissimilarity test between 4F and 4B after standardizing for the total number of observations per watershed and found they were ~9% dissimilar.

Author: Donald Kaufman

ZIP file: knb-lter-knz.88.9

Data code: CSM01

File(s): 
- CSM011.csv -> includes info about the count of specific species at watersheds
- CSM012.csv -> includes info about the traits of the individual small mammals trapped (including the mass, sex, relative age, pregnancy status, etc.)

Summary of changes:
- During winter 1981-1982, the Konza Prairie management committee shifted treatment boundaries, so our traplines in N00D were encompassed in the new boundaries of N01D. Therefore, we established two new traplines in another treatment unit (N00B) in spring 1982.
- In autumn 1984, four new traplines were established with two traplines in 002C and two in 002D (24 total sampling lines). 
- Four more traplines were added in autumn 1985 with two in 010D and two in 001A (28 total sampling lines). 
- After 1987, summer sampling was discontinued because of the intensive labor required to close traps in the morning and open traps in late afternoon each day on each trapline in each trapping period.
- In 1988, Konza Prairie management committee changed unburned research treatments to treatments with a 20-year frequency of occurrence of fire and, therefore, 000B and N00B became 020B and N20B, respectively. 
- The treatment units (N01B and N04D) remained unburned from 1968 until spring 1988 when annual burning was initiated on N01B and the 4-year cycle was initiated on N04D.
- Spring fires occurred after our trapping session in these and other treatment units. 
- N20B was not burned in 1988, but it had been burned in 1980. 
- Before the spring sampling period in 1989, the number of traplines sampled was reduced from 28 traplines to 14; the 14 traplines remaining included two traplines in each of seven experimental treatments (001D, 004B, 004F, 020B, N01B, N04D and N20B).
- In addition, a second ungrazed 4-year fire treatment (004F) was continued to help monitor climatic effects on small mammals in prairie experiencing periodic fires
- Data for small mammals captured on traplines that were discontinued (001A, 002C, 002D, 004D, 004G, 010A and 010D) can be found in CSM06
- In May 1992, gates were opened between phase I and phase II of the bison area. N01B, N04D and N20B lie within the phase II area. 
- All sampling periods from autumn 1981 through spring 1992 on these three treatment units occurred on traplines that had not been grazed by bison.

###Small-mammals: Cleaning and organization
```{r}
#Seasonal summaries of small mammals on LTER traplines 
smammals_raw <- read_csv("Datasets_EAGER/Small_mammals/knb-lter-knz.88.9_FourteenTraplines/CSM011.csv")

#Table including the watershed info for all watersheds - this table will be used in subsequent taxa data
watershed_info <- read_excel("Datasets_EAGER/Other/Watershed Info.xlsx")


#Separating the watershed/line column into two separate columns
smammals <- separate(smammals_raw, `WATERSHED/LINE`, into = c("WATERSHED", "LINE"), sep = "-")


#Renaming columns just so that they're not all capitalized
smammals <- smammals %>% rename("Watershed_name" = "WATERSHED", 
                                "Datacode" = "DATACODE",
                                "Rectype" = "RECTYPE", 
                                "Recyear" = "RECYEAR", 
                                "Season" = "SEASON", 
                                "Line" = "LINE")

#Shortening the names of the watersheds
smammals$Watershed_name <- dplyr::recode(smammals$Watershed_name,
                                       "004F" = "4F",
                                       "004B" = "4B",
                                       "001D" = "1D",
                                       "020B" = "20B",
                                       "N20B" = "N20B",
                                       "N01B" = "N1B",
                                       "N04D" = "N4D")



#Pivoting the table so that each species per year and watershed is a different row
smammals_long <- pivot_longer(smammals, cols = 8:21, names_to = "Species", values_to = "Count")

#Renaming the species into their full names
smammals_long$Species <- dplyr::recode(smammals_long$Species,
                                     "Pm" = "Peromyscus_maniculatus",
                                     "Rmeg" = "Reithrodontomys_megalotis",
                                     "Sh" = "Sigmodon_hispidus",
                                     "Bh" = "Blarina_hylophaga",
                                     "Rmon" = "Reithrodontomys_montanus",
                                     "St" = "Spermophilus_tridecemlineatus",
                                     "Mo" = "Microtus_ochrogaster",
                                     "Pl" = "Peromyscus_leucopus",
                                     "Ch" = "Chaetodipus_hispidus",
                                     "Mm" = "Mus_musculus",
                                     "Nf" = "Neotoma_floridana",
                                     "Sc" = "Synaptomys_cooperi",
                                     "Zh" = "Zapus_hudsonius",
                                     "Cp" = "Cryptotis_parva")



#Separate the dataset from 1992 onwards. 
smammals_long <- smammals_long %>% subset(.$Recyear >= 1992)


#Since I likely won't differentiate the data based on the trap lines, I am summing the data based on just watershed
smammals_long <- smammals_long %>% group_by(Recyear, Watershed_name, 
                                            Species) %>% 
  reframe(Count = sum(Count))


# Removing the 4F watershed to make sampling between all fire/grazing treatments equal (the 4 year fire interval with no grazing combination of disturbances has two watersheds represented, while all other combinations have just one).
smammals_long <- smammals_long %>% subset(Watershed_name != "4F")



```

###Small-mammals: Presence/Absence & Classification
```{r}
#Combining the species and watershed variables so that each species per watershed per year is a unique identifier
smammals_long <- smammals_long %>% unite("Species.watershed", Species:Watershed_name, sep = ".")
smammals_long <- smammals_long %>% mutate(Recyear = as.numeric(Recyear),
                                          Count = as.numeric(Count),
                                          Species.watershed = factor(Species.watershed))
smammals_years_wide <- smammals_long %>% 
  pivot_wider(names_from = "Recyear", values_from = "Count")

#Creating a separate species.watershed dataframe to add back to the dataset after standardization
smammals_env <- smammals_years_wide[, 1]

#Standardizing by presence/absence
decostand_smammals_pa <- decostand(smammals_years_wide[, -(1)], "pa", na.rm = TRUE )

#Transforming the presence/absence data into a matrix so I can feed it to the function
smammals_pa_matrix <- as.matrix(decostand_smammals_pa)

#Applying the getTrends function to each row of the presence/absence matrix
smammals_trends <- apply(smammals_pa_matrix, 1, getTrends)

#Creating a table with the species.watershed and the Trends info. I excluded the bsline info.
smammals_classification <- tibble((smammals_env), do.call(rbind,lapply(smammals_trends,(function(v){v[c(1,2,3,5)]}))))

#Adding in the presence/absence per year data back in 
smammals_class <- smammals_classification %>% add_column(decostand_smammals_pa, .before = "chiPval")

#Separating the species and watershed variable names for graphing later
smammals_class <- smammals_class %>% separate(Species.watershed, c("Genus", "Spp", "Watershed_name")) %>% unite("Species", Genus:Spp, sep = "_")

#Pivoting longer so that each row is now a year, species, watershed, etc.
smammals_class_long <- smammals_class %>% pivot_longer(cols = "1992":"2013", 
                                                 names_to = "Recyear", 
                                                 values_to = "Presence")

```


###Small-mammals: Exploration plots
```{r}
#Joining the watershed_info dataset with the actual small mammal dataset
smammals_class_long <- left_join(smammals_class_long, watershed_info, by = "Watershed_name")


#Making variables factors
smammals_class_long <- smammals_class_long %>% mutate(Fire_interval = factor(Fire_interval),
                    Burn_season = factor(Burn_season),
                    Grazing = factor(Grazing),
                    Watershed_name = factor(Watershed_name))


#Making the zeroes in the presence column into NAs for plotting (that way they don't show up on the graph)
smammals_class_long$Presence[smammals_class_long$Presence == 0] <- NA

#Making sure the Recyear is coded as numeric 
smammals_class_long <- smammals_class_long %>% mutate(Recyear = as.numeric(Recyear))

#Reordering the fire intervals for plotting
smammals_class_long$Fire_interval <- factor(smammals_class_long$Fire_interval, 
                                           levels = c("1_year", "4_years", "20_years"))
#Reordering the grazing for plotting
smammals_class_long$Grazing <- factor(smammals_class_long$Grazing,
                                     levels = c("Ungrazed", "Bison"))
#Reordering the watersheds for plotting
smammals_class_long$Watershed_name <- factor(smammals_class_long$Watershed_name,
                                        levels = c("1D", "N1B", "4B", "N4D", "20B", "N20B"))

#Creating a graph to look at the classification by species and presence/absence by year
smammals_class_long %>% ggplot(aes(x = Recyear, y = Presence, fill = category)) + 
  geom_tile(width = .6, height = .6) + 
  facet_grid(Species~Watershed_name, switch = "y") +
  theme(text = element_text(size=7),
        axis.text.x = element_text(angle=45, hjust=1, size =7),
        axis.text.y = element_text(size=5),
        strip.text.y.left = element_text(angle = 0, size = 3),
        strip.text.x.top = element_text(size = 7)) +
  geom_vline(xintercept = 2002.5, linetype= 3) +
  labs(x = "Year", y = "Presence") +
  scale_fill_manual(values = c("NA", "black", "darkolivegreen4", "dodgerblue2", "darkorchid"))


```


##Birds (1992 - 2009)
This section is dedicated to cleaning and analyzing the bird-sampling data set. 

Data was collected from 1981 to 2009, but we are only looking at data collected between 1992 to 2009 because bison weren't introduced to the bison plots until 1992.

Watersheds that are included in dataset: N4B, N4D, 4B, 4A, *4D*, N1B, 1D, *R20A*, *R1B*, *20C*, 20B, N20B, *LA*, *SA*, *GA*. 
*italicized* = *watersheds we decided to exclude in our analysis* 
Reasons:
*4D* = This watershed turned into area SA in 1990 and was dropped.
*R20A* = Doesn't fit into the disturbance framework we are assessing; this watershed was burned yearly up till 2000 and is now burned every 20 years.
*R1B* = Similar to R20A, this doesn't fit into the disturbance framework we are assessing; this watershed was burned every 20 years till 2000 and is now burned yearly.
*20C* = Removed to have equal representation of comparable treatments; there are 2 watersheds with the 20-year fire-interval + ungrazed treatment (20B and 20C), and only one watershed with the 20-year fire-interval + grazed treatment (N20B). We removed 20C because 20B is more commonly sampled in our other datasets. We did complete a Bray-Curtis Dissimilarity test between 20B and 20C after standardizing for the total number of observations per watershed and found they were ~23% dissimilar.
*LA, SA, GA* = These are not watersheds. They are gallery forest and forest edge areas located in lower King's Creek, north fork, and upper Shane's Creek at Konza. Since they are forest locations and don't fit into the disturbance framework we are assessing, we dropped them.

Censuses are conducted two times during the year: during the first two weeks of January as a measure of wintering populations, and during the first two weeks of June as a measure of breeding populations.

Data author: Alice Boyle

ZIP file: knb-lter-knz.26.12

Data code: CBP01

File(s): CBP011.csv

Summary of changes up to 1993: 
- 1981: Transects were as presently located except no transect in N20B and there were transects in  N20C (now N01A), N20D (now part of N01B), N01C (now N02B), N01D (now part of N01B), and N04C (now N04B). 
- 1982: Transects in N20C (N01A) and N01C (N02B) were dropped, N20D was maintained in what is now N01B. N01D became the second transect in what is now N01B, and N04C transect was maintained in what is now N04B. N20B was added. 
- 1990: 004d became SA and transect was dropped.

###Birds: Cleaning and organizing
```{r}
#Read in and view bird data
birds_raw <- read_csv("Datasets_EAGER/Birds/knb-lter-knz.26.12/CBP011.csv", show_col_types = FALSE)

unique(birds_raw$WATERSHED)

#Changing classifications and names of columns
birds_all <- birds_raw %>% mutate(RECMONTH = factor(RECMONTH),
                          RECDAY = factor(RECDAY),
                          SEASON = factor(SEASON),
                          TRANSNUM = factor(TRANSNUM),
                          SPECNAME = factor(SPECNAME),
                          AOUCODE = factor(AOUCODE),
                          COMMONNAME = factor(COMMONNAME),
                          DISTANCE = as.numeric(DISTANCE),
                          COUNT = as.numeric(COUNT),
                          SEX = factor(SEX),
                          STATUS = factor(STATUS),
                          COMMENTS = as.character(COMMENTS))

#Renaming the columns so they're not all capitalized
birds_all <- birds_all %>% rename("Watershed_name" = "WATERSHED",
                          "Datacode" = "DATACODE",
                          "Recyear" = "RECYEAR",
                          "Recmonth" = "RECMONTH",
                          "Recday" = "RECDAY",
                          "Season" = "SEASON",
                          "Transect" = "TRANSNUM",
                          "Observation_number" = "OBSNUM",
                          "Species" = "SPECNAME",
                          "AOU_code" = "AOUCODE",
                          "Common_name" = "COMMONNAME",
                          "Distance" = "DISTANCE",
                          "Count" = "COUNT",
                          "Sex" = "SEX",
                          "Status" = "STATUS",
                          "Comments" = "COMMENTS",
                          "Time" = "TIME",
                          "Duration" = "DURATION",
                          "Observer" = "OBSERVER")

#Renaming the watersheds to make the names shorter
birds_all$Watershed_name <- dplyr::recode(birds_all$Watershed_name,
                                       "N04D" = "N4D",
                                       "N04B" = "N4B",
                                       "004B" = "4B",
                                       "004A" = "4A",
                                       "004D" = "4D",
                                       "N01B" = "N1B",
                                       "001D" = "1D",
                                       "R20A" = "R20A",
                                       "R01B" = "R1B",
                                       "020C" = "20C",
                                       "020B" = "20B",
                                       "L00A" = "LA",
                                       "S00A" = "SA",
                                       "G00A" = "GA",
                                       "N20B" = "N20B")


#I need to separate the dataset from 1992 onwards. 
birds <- birds_all %>% subset(.$Recyear >= 1992)


#Removing watersheds and transects I won't use for further analysis
birds <-  birds %>% subset(!(Watershed_name %in% c("4D", "R20A", "20C",
                                                     "R1B", "LA",
                                                     "GA", "SA")))

##This transect is being removed to not duplicate the number of observations at a single watershed; watershed N1B has two transects (6, 10) and all other watersheds just have one transect.
###I did do a Bray-Curtis dissimilarity test on the two different transects to make sure they were similar enough, and it looks like they are about 23% dissimilar (~77% similar)
birds <-  birds %>% subset(Transect != "10")

#Checking the lengths of the species (the 'species' variable has a lot more entries, but they are duplicates with naming variations when looking at the matching common names. So I'll use the AOU code instead.)
length(unique(birds$Species))
length(unique(birds$AOU_code))

#Also removing observations that are unspecified
birds <-  subset(birds, !(AOU_code %in% c("NONE", "VOID", "UNSP", "UNEM", "RSTO")))

#Renaming this one all lowercase entry since all other entries are all uppercase
birds$AOU_code <- dplyr::recode(birds$AOU_code,
                                "eawp" = "EAWP")

```

###Birds: Presence/Absence & Classification
```{r}

#Selecting the columns I want for further analysis 
birds_group <- birds %>% group_by(Recyear, AOU_code, Watershed_name) %>% 
  reframe(Count = sum(Count))

birds_group <- birds_group %>% unite("Species.watershed", AOU_code:Watershed_name, sep = ".")

#Pivoting the the dataset wider, so that each species is its own column
birds_years_wide <- birds_group %>% 
  pivot_wider(names_from = factor("Recyear"), values_from = "Count")


#Creating a separate species.watershed dataframe to add back to the dataset after standardization
birds_env <- birds_years_wide[, 1]


#Standardizing by presence/absence
decostand_birds_pa <- decostand(birds_years_wide[, -c(1)], "pa", na.rm = FALSE)
#Making all NA's zeroes; NA's are entries in which no data was collected, thus are absent/0
decostand_birds_pa[is.na(decostand_birds_pa)] <- 0



#Transforming the presence/absence data into a matrix so I can feed it to the function
birds_pa_matrix <- as.matrix(decostand_birds_pa)

#Applying the getTrends function to each row of the presence/absence matrix
birds_trends <- apply(birds_pa_matrix, 1, getTrends)

#Creating a table with the species.watershed and the Trends info. I excluded the bsline info.
birds_classification <- tibble((birds_env), do.call(rbind,lapply(birds_trends,(function(v){v[c(1,2,3,5)]}))))


#Adding in the presence/absence per year data back in 
birds_class <- birds_classification %>% add_column(decostand_birds_pa, .before = "chiPval")

#Separating the species and watershed variable names for graphing later
birds_class <- birds_class %>% separate(Species.watershed, c("AOU_code", "Watershed_name"))

#Pivoting longer so that each row is now a year, species, watershed, etc.
birds_class_long <- birds_class %>% pivot_longer(cols = "1992":"2009", 
                                                 names_to = "Recyear", 
                                                 values_to = "Presence")


```

###Birds: Exploration Plots
```{r}

#Joining the watershed_info dataset with the actual birds dataset
birds_class_long <- left_join(birds_class_long, watershed_info, by = "Watershed_name")

#Converting some of the variables into factors
birds_class_long <- birds_class_long %>% mutate(Fire_interval = factor(Fire_interval),
                                  Burn_season = factor(Burn_season),
                                  Grazing = factor(Grazing))

birds_graphing <- birds_class_long

#Making all presence = "0" inti NA's so they don't show up in theb graph
birds_graphing$Presence[birds_graphing$Presence == 0] <- NA

#Making the years numeric instead of characters
birds_graphing <- birds_graphing %>% mutate(Recyear = as.character(Recyear))
birds_graphing <- birds_graphing %>% mutate(Recyear = as.numeric(Recyear))

#Changing the order of the watersheds so that the grazing and non-grazing watersheds of the same burn interval are next to each other
birds_graphing$Watershed_name <- factor(birds_graphing$Watershed_name,
                                levels = c("1D", "N1B", "4A", 
                                           "4B", "N4B", "N4D", 
                                           "20B", "N20B"))


birds_graphing$category <- factor(birds_graphing$category, 
                               levels = c("always_absent", "always_present", "random", "recurrent", "increasing", "decreasing"))

birds_graphing %>% ggplot(aes(x = Recyear, y = Presence, fill = category)) + 
  geom_tile(width = .6, height = .6) + 
  facet_grid(AOU_code~Watershed_name, switch = "y") +
  theme(text = element_text(size=7),
        axis.text.x = element_text(angle=45, hjust=1, size =7),
        axis.text.y = element_text(size=5),
        strip.text.y.left = element_text(angle = 0, size = 3),
        strip.text.x.top = element_text(size = 7)) +
  scale_fill_manual(values = c("black", "dodgerblue2", "darkorchid", "darkolivegreen4", "firebrick3")) +
  labs(x = "Year", y = "Presence", fill = "Classification")


```


##Grasshoppers (2002 - 2020)
This section is dedicated to cleaning the grasshopper sweeping dataset. 

Data was collected from 1982 to 2020, but we are only looking at data from 2002 to 2020 becasue sampling at the bison plots were suspended until 2002.

Watersheds that are included: 2D, 1D, N20B, N1B, SuB, 4F, 20B, N4D, 2C, SpB, 4B, 4A, N1A, N20A.
(*italicized* = *watersheds that we are including in our analysis*).


Author: Anthony Joern

ZIP file: knb-lter-knz.29.20

Data code: CGR02

File(s): 
- CGR021.csv 
- CGR022.csv 
- CGR023.csv


Summary of changes: 
- 1982-1987: Sites were sampled at various earlier dates in addition to the late July-early August. 
- 1985:Sweeping was restricted to all sites being sampled (twice, on different dates) in late July and early August. 
- Additional watersheds (002D, 004D (now 0SpB), 004F AND 010D (now 0SuB) were added to the sampling regime for early August to provide more long-term data on the influence of fire frequency on grasshoppers. 
- Sampling on watersheds to be grazed (N01B, N04D, and N20B) was discontinued. 
- 1986: Watershed 004G (now 00WB) was temporarily added. 
- Sampling in June and early July was reduced to watersheds 001D, 004D, 010D and 020B only; too few grasshoppers are collected by sweeping in the first half of the summer for all watersheds to merit sampling. 
- 1987: Sampling in June and early July was restricted to sites 001D, 002C, 004B and 004F. 
- 1994:Fire regime changed for 004D (became 0SpB) and 010D (became 0SuB). In the years when 0SuB is burned the sweeps are done 2 weeks earlier than normal. 
- The summer burn is conducted on the first water appropriate day in late July to early August. 
- 1996: Wildfire in February, burned 004F, 0SuB, 001D and 002D. 
- 1998: 0SuB done earlier than other sites (mid-July) under the mistaken idea that the summer burns were to occur this year. 
- 2002: Grazed (bison) transects were added in N01A, N01B, N04A, N04D, N20A and N02B. An older version of the methods manual indicates that 3 lowland (Tully) sites were once done. Locations were: 001D A: T-28; 004B A: G-28; B: S-28; B: F-28; 020B A: N-29; B: N-29 
- 2011: WindMate 200 replaced previous machine used for checking wind speeds. The previous machine had limit of detection of 5mph. WindMate 200 specifications: Temperature -20 oC to 158 oF accuracy +1.8 oC to 89 mph accuracy +3%. 
- 2013: Beginning with this year, Oecanthinae spp., Gryllidae spp., Tettigoniidae spp., are being added to our list. These are not new species to Konza. We are adding them to the official listing because they are related and ecologically similar. 
- 2016: In years when SuB is burned, pre-burn and post-burn sweeps will be done. Timing for pre-burn will be mid-July and timing for post-burn will be mid-September. 
- 2018: March 14. 004B – A was burned in a wildfire. A third sweep, “C”, will be done in the vicinity of pab011 FC until 2021 when 004b is scheduled to burn per “normal” schedule.

###Grasshoppers: Cleaning and organizing
```{r}
#Second dataset is the grasshopper species counts from each set of sweeps
grasshoppers_raw <- read_csv("Datasets_EAGER/Grasshoppers/knb-lter-knz.29.20/CGR022.csv")
watershed_info <- read_excel("Datasets_EAGER/Other/Watershed Info.xlsx")
grasshopper_families <- read_excel("Datasets_EAGER/Grasshoppers/Grasshopper_families.xlsx")



#Making the variables into factors for later graphing and analysis
grasshoppers_all <- grasshoppers_raw %>% mutate(RECTYPE = factor(RECTYPE),
                                          RECMONTH = factor(RECMONTH),
                                          RECDAY = factor(RECDAY),
                                          WATERSHED = factor(WATERSHED),
                                          SOILTYPE = factor(SOILTYPE),
                                          REPSITE = factor(REPSITE),
                                          SPCODE = factor(SPCODE))

#Checking the number of unique names for different variables to then compare to the metadata
sort(unique(grasshoppers_all$SPECIES))
##Theres capitalizations in some but not others and there are some unknowns. I'll have to alphabetize it and go through to see if there are multiple spellings for the same species
sort(unique(grasshoppers_all$WATERSHED))
#There is weird capitalizations for these too... I'll have to go through and clean and probably get rid of some


#Recoding watersheds to make it consistent
grasshoppers_all <- grasshoppers_all
grasshoppers_all$WATERSHED <- dplyr::recode(grasshoppers_all$WATERSHED,
                                  "001d" = "1D",
                                  "004b" = "4B",
                                  "000b" = "B",
                                  "n04a" = "N4A",
                                  "n01b" = "N1B",
                                  "n04d" = "N4D",
                                  "n00b" = "NB",
                                  "002d" = "2D", 
                                  "004d" = "4D",
                                  "004f" = "4F",
                                  "010d" = "10D",
                                  "004g" = "4G",
                                  "002c" = "2C",
                                  "0sub" = "SuB",
                                  "020b" = "20B",
                                  "0spb" = "SpB",
                                  "n20a" = "N20A",
                                  "n20b" = "N20B",
                                  "n01a" = "N1A",
                                  "N20B" = "N20B",
                                  "002D" = "2D",
                                  "N01B" = "N1B",
                                  "001D" = "1D",
                                  "N04D" = "N4D",
                                  "004F" = "4F",
                                  "002C" = "2C",
                                  "020B" = "20B",
                                  "0SUB" = "SuB",
                                  "0SPB" = "SpB",
                                  "004B" = "4B",
                                  "N01A" = "N1A",
                                  "N04A" = "N4A",
                                  "N20A" = "N20A")



#Recoding some of the species to make it consistent
grasshoppers_all$SPECIES <- dplyr::recode(grasshoppers_all$SPECIES,
                                "ageneotett deorum" = "Ageneotettix deorum",
                                "arphia conspersa" = "Arphia conspersa",
                                "arphia simplex" = "Arphia simplex",
                                "arphia species" = "Arphia spp.",
                                "arphia spp." = "Arphia spp.",
                                "arphia xanthopte" = "Arphia xanthoptera",
                                "boopedon auriventr" = "Boopedon auriventris",
                                "boopedon gracile" = "Boopedon gracile",
                                "boopedon nubilum" = "Boopedon nubilum",
                                "brachystol magna" = "Brachystola magna", 
                                "campylacan olivacea" = "Campylacantha olivacea",
                                "chortophag viridifas" = "Chortophaga viridifasciata",
                                "encoptolop sordidus" = "Encoptolophus sordidus",
                                "encoptolop spp." = "Encoptolophus spp.",
                                "Encoptolphus spp." = "Encoptolophus spp.",
                                "encoptolop subgracil" = "Encoptolophus subgracilis",
                                "eritettix simplex" = "Eritettix simplex",
                                "hadrotetti trifascia" = "Hadrotettix trifasciatus",
                                "hesperotet species" = "Hesperotettix spp.",
                                "hesperotet speciosus" = "Hesperotettix speciosus",
                                "hesperotet spp." = "Hesperotettix spp.",
                                "hesperotet viridis" = "Hesperotettix viridis",
                                "hippiscus rugosus" = "Hippiscus rugosus",
                                "hypochlora alba" = "Hypochlora alba",
                                "melanoplus angustipe" = "Melanoplus angustipennis",
                                "melanoplus bivittatu" = "Melanoplus bivittatus",
                                "melanoplus confusus" = "Melanoplus confusus",
                                "melanoplus different" = "Melanoplus differentialis",
                                "melanoplus femurrubr" = "Melanoplus femurrubrum",
                                "melanoplus foedus" = "Melanoplus foedus",
                                "melanoplus keeleri" = "Melanoplus keeleri",
                                "melanoplus occidenta" = "Melanoplus occidentalis",
                                "melanoplus packardii" = "Melanoplus packardii",
                                "melanoplus sanguinip" = "Melanoplus sanguinipes",
                                "melanoplus scudderi" = "Melanoplus scudderi",
                                "melanoplus species" = "Melanoplus spp.",
                                "melanoplus spp." = "Melanoplus spp.",
                                "mermiria bivitatta" = "Mermiria bivittata",
                                "mermiria bivittata" = "Mermiria bivittata",
                                "mermiria picta" = "Mermiria picta",
                                "mermiria species" = "Mermiria spp.",
                                "mermiria spp." = "Mermiria spp.",
                                "oedipodinae" = "Oedipodinae spp.",
                                "opeia obscura" = "Opeia obscura",
                                "orphulella speciosa" = "Orphulella speciosa",
                                "orphullela speciosa" = "Orphulella speciosa",
                                "paratylota brunneri" = "Paratylotropidia brunneri",
                                "paratylotr brunneri" = "Paratylotropidia brunneri",
                                "pardalopho haldemani" = "Pardalophora haldemani",
                                "pardalopho apiculata" = "Pardalophora apiculata",
                                "pardalopho species" = "Pardalophora spp.",
                                "pardalopho spp." = "Pardalophora spp.",
                                "phoetaliot nebrascen" = "Phoetaliotes nebrascensis",
                                "pseudopoma brachypte" = "Pseudopomala brachyptera",
                                "Pseuodopomala brachyptera" = "Pseudopomala brachyptera",
                                "psoloessa delicatul" = "Psoloessa delicatula",
                                "schistocer lineata" = "Schistocerca lineata",
                                "schistocer obscura" = "Schistocerca obscura",
                                "syrbula admirabil" = "Syrbula admirabilis",
                                "unknown" = "Unknown",
                                "xanthippus corallipe" = "Xanthippus corallipes")

###After some exploration, I found that Hippiscus rugosa and Hippiscus ocelote are the same thing, so I will change everything to Hippiscus ocelote.
grasshoppers_all$SPECIES <- dplyr::recode(grasshoppers_all$SPECIES,
                                      "Hippiscus rugosus" = "Hippiscus ocelote")

###Also, some of the species names aren't correctly matched with their spp code, so I will fix that
 for(i in 1:nrow(grasshoppers_all)){
   if (grasshoppers_all$SPECIES[i] == "Oecanthinae spp."){grasshoppers_all$SPCODE[i] <- "56"}
   if (grasshoppers_all$SPECIES[i] == "Tettigoniidae spp."){grasshoppers_all$SPCODE[i] <- "59"}
   if (grasshoppers_all$SPECIES[i] == "Gryllidae spp."){grasshoppers_all$SPCODE[i] <- "58"}
   if (grasshoppers_all$SPECIES[i] == "Melanoplus femurrubrum"){grasshoppers_all$SPCODE[i] <- "12"}
 }

#Condensing some of the watersheds based on the metadata
grasshoppers_all$WATERSHED <- dplyr::recode(grasshoppers_all$WATERSHED,
                                   "B" = "20B",
                                   "NB" = "N20B",
                                   "2D" = "SpB",
                                   "4D" = "SpB",
                                   "4F" = "SuB",
                                   "10D" = "SuB",
                                   "4G" = "WB")


##Since the bison grazed plots weren't sampled until 2002, I am removing all data pre-2002
grasshoppers <- grasshoppers_all %>% subset(.$RECYEAR >= 2002)
#Renaming the columns so they're not all capitalized
grasshoppers <- grasshoppers %>% rename("Watershed_name" = "WATERSHED",
                              "Recyear" = "RECYEAR",
                              "Recmonth" = "RECMONTH",
                              "Recday" = "RECDAY",
                              "Species" = "SPECIES",
                              "Total" = "TOTAL",
                              "Soil_type" = "SOILTYPE",
                              "Repsite" = "REPSITE",
                              "Spp_code" = "SPCODE")
unique(grasshoppers$Watershed_name)

#Removing watersheds and transects I won't use for further analysis
grasshoppers <- grasshoppers %>%
  subset(Watershed_name %in% c("1D", "20B", "4B",
                              "N1A", "N1B", 
                              "N4A", "N4D",
                              "N20B", "N20A")) 

#Adding in the watershed information 
grasshoppers <- left_join(grasshoppers, watershed_info, by = "Watershed_name")

#Adding in family and suborder information. First I need to separate the genus and spp
grasshoppers <- grasshoppers %>% separate(Species, c("Genus", "Spp"), sep = " ")
grasshoppers <- left_join(grasshoppers, grasshopper_families, by = "Genus")
grasshoppers <- grasshoppers %>% unite("Species", Genus:Spp, sep = "_")

#Just checking the species codes and names
length(unique(grasshoppers$Spp_code))
length(unique(grasshoppers$Species))

unique(grasshoppers$Spp_code)
unique(grasshoppers$Species)

#Doing a date check to see the sampling times by year
# grasshoppers_datecheck <- grasshoppers %>% unite("Month_Day", Recmonth:Recday, sep = "-")
# grasshoppers_datecheck <- grasshoppers_datecheck %>% unite("Date", Recyear:Month_Day, sep = "-", remove = FALSE)
# grasshoppers_datecheck$Date <- ymd(grasshoppers_datecheck$Date)
# grasshoppers_datecheck <- grasshoppers_datecheck %>% group_by(Date)%>% reframe(Total = sum(Total))



#Removing the unknowns from the dataset (looks like there are 49 unknown entries, with 271 individuals)
grasshoppers <- grasshoppers %>% subset(Species != "Unknown_NA")

#Adding the family/suborder dataset to this dataset

#Making a dataset with just the suborder Caelifera. Suborder Ensifera are katydids and crickets
grasshoppers_cae <- grasshoppers %>% subset(Suborder == "Caelifera")


#Removing the entries that aren't identified to species (I need to separate genus and spp again... oops)
grasshoppers_cae <- grasshoppers_cae %>% separate(Species, c("Genus", "Spp"), sep = "_")
grasshoppers_cae <- grasshoppers_cae %>% subset(Spp != "spp.")
grasshoppers_cae <- grasshoppers_cae %>% unite("Species", Genus:Spp, sep = "_")

```

###Grasshoppers: Presence/Absence & Classification
```{r}

```


##Plants (1992 - 2022)
This section is dedicated to cleaning and analyzing the plant species composition/cover dataset. 

Data was collected from 1983 to 2022, but we are only looking at data collected between 1992 to 2022 because bison weren't introduced to the bison plots until 1992.

Watersheds that are included: FA, SuB, N4A, R1A, 2D, WB, N20B, 1D, N1A, R1B, SpA, SpB, WA, 20B, 4A, 4F, SuA, N1B, N20A, N4D.
(* = watersheds we included in our analysis).

Author: David Hartnett, Scott Collins, Zak Ratajczak

ZIP file: knb.lter.knz.69.21

Data code: PVC02

File(s): PVC021.csv

Summary of changes:
- Pasture c01b was called Texas Hog (thp) in 2009. 
- Vegetation species composition from 1983: The transects were permanently laid out in the current format of 4 transects (A-D), each with 5 plots. 
- Transect E only occurred on watershed N20B florence in 1986 and 1987. This transect is the same as the current transect D for this watershed and soil type. 
- The old transect D was abandoned in 1987 prior to bison reintroduction. 
- Seven cover classes were used to estimate species canopy coverage. 1 - 0-1% cover; 2 - 2-5% cover; 3 - 5-25% cover; 4 - 25-50% cover; 5 - 50-75%; 6 - 75-95% cover; 7 - 95-100% cover. -(Note: for the watershed r20b, no data were collected in the transect A and B in the fall of 2011 due to wildfire occurred.) 
- Transect 'E' occurred only on the N20b florence site in 1986 and 1987 and was renamed the new 'transect' in 1988. 
- The old 'D' transect was sampled from 1983 to 1987 and then abandoned when the bison fence was constructed. 
- Thus, plots d1-d5 from 1983-1987 are NOT the same d1-d5 plots in subsequent years.

###Plants: Cleaning and organizing
```{r}
plantcomp_raw <- read_csv("Datasets_EAGER/Plants/knb-lter-knz.69.21_SpeciesComposition/PVC021.csv")

watershed_info <- read_excel("Datasets_EAGER/Other/Watershed Info.xlsx")

unique(plantcomp_raw$WaterShed)

plantcomp <- plantcomp_raw %>% mutate(RecType = factor(RecType),
                                        RecMonth = factor(RecMonth),
                                        RecDay = factor(RecDay),
                                        WaterShed = factor(WaterShed),
                                        SoilType = factor(SoilType),
                                        Transect = factor(Transect),
                                        Plot = factor(Plot),
                                        SpeCode = factor(SpeCode))

#Combining the genus and species column and creating a new column. 
plantcomp1 <- unite(plantcomp, "Genus_spp", AB_genus:AB_species, sep = "_", remove = FALSE)


plantcomp1$WaterShed <- dplyr::recode(plantcomp1$WaterShed,
                                "001c" = "1C",
                                "001d" = "1D",
                                "004b" = "4B",
                                "020b" = "20B",
                                "n01b" = "N1B",
                                "n04d" = "N4D",
                                "n20b" = "N20B",
                                "002c" = "2C",
                                "002d" = "2D",
                                "004a" = "4A",
                                "004f" = "4F",
                                "n04a" = "N4A",
                                "n20a" = "N20A",
                                "020d" = "20D",
                                "n01a" = "N1A",
                                "00wb" = "WB",
                                "0spa" = "SpA",
                                "0spb" = "SpB",
                                "00fa" = "FA",
                                "00fb" = "FB",
                                "00wa" = "WA",
                                "0sua" = "SuA",
                                "0sub" = "SuB",
                                "001a" = "1A",
                                "020a" = "20A",
                                "r01a" = "R1A",
                                "r01b" = "R1B",
                                "r20a" = "R20A",
                                "r20b" = "R20B",
                                "n02a" = "N2A",
                                "n02b" = "N2B")

unique(plantcomp1$WaterShed)

plantcomp1 <- plantcomp1 %>% rename("Watershed_name" = "WaterShed",
                              "Recyear" = "RecYear",
                              "Recmonth" = "RecMonth",
                              "Recday" = "RecDay")


plantcomp2 <- plantcomp1
plantcomp2 <- plantcomp2 %>% subset(.$Recyear >= 1993)


#Removing watersheds and transects I won't use for further analysis
plantcomp3 <- plantcomp2

plantcomp3 <- plantcomp3 %>%
  subset(Watershed_name %in% c("1A", "1C", "1D",
                               "2C", "2D",
                              "4A", "4B", "4F",
                              "20A", "20B", "20D",
                              "N1A", "N1B",
                              "N2A", "N2B",
                              "N4A", "N4D",
                              "N20A", "N20B")) 

plantcomp3 <- left_join(plantcomp3, watershed_info, by = "Watershed_name")
sort(unique(plantcomp3$Genus_spp))
length(unique(plantcomp3$SpeCode))


plantcomp4 <- plantcomp3 

plantcomp4 <- subset(plantcomp4,!(Genus_spp %in% c("annual_forb", "carex_spp.", "cyperu_spp.", 
                                                   "euphor_spp.", "symphy_spp.")))


plantcomp4 <- plantcomp4 %>% unite("Month_Day", Recmonth:Recday, sep = "-")

plantcomp4 <- plantcomp4 %>% unite("Date", Recyear:Month_Day, sep = "-", remove = FALSE)

plantcomp4$Date <- ymd(plantcomp4$Date)
datecheck <- plantcomp4 %>% group_by(Date)%>% reframe(Cover = sum(Cover))

```

###Plants: Presence/Absence & Classification
```{r}

```


