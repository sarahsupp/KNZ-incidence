---
title: "E1_AllTaxa_Analysis"
author: "Maya Parker-Smith"
date: "2023-11-13"
output: 
 html_document:
    smart: no
    theme: flatly
    float: yes
    css: "style.css"    
editor_options: 
  chunk_output_type: console
mainfont: Arial
mathfont: Arial
fontsize: 12pt
---

Creates tabs in the HTML document \# {.tabset .tabset-pills .tabset-fade}

```{r setup, include=FALSE}
#Clear environment
rm(list=ls())

#Read in necessary libraries
library(tidyverse)
library(boot)
library(broom)
library(cowplot)
library(ggpubr)
library(lme4)
library(MASS)
library(multcomp)
library(purrr)
library(readxl)
library(tseries)
library(vegan)

#Call our custom functions for classification and analysis
source("classify_functions.R")
```

#Read in Data Tables This includes the watersheds tables and the species-level data for the 4 taxa.

```{r}
watershed_info <- read_excel("Datasets/Watershed_data/Watershed_info.xlsx")

#Reading in the cleaned taxa data sets
E0_smammals <- read_csv("Datasets/E0_cleaned_data/E0_smammals.csv")
E0_grasshoppers <- read_csv("Datasets/E0_cleaned_data/E0_grasshoppers.csv")
E0_birds<- read_csv("Datasets/E0_cleaned_data/E0_birds.csv")
E0_plants <- read_csv("Datasets/E0_cleaned_data/E0_plants.csv")
```

# Clean Data to Classified Incidence for All Taxa

This Rmarkdown is for taking the clean datasets for all 4 taxa (small-mammals, grasshoppers, birds, and plants) and using the incidence classification method to categorize each species. This file also estimates composition change (Jaccard dissimilarity) and richness change (linear model) over time.

## Brief overview of Classification

Incidence Classification categories include:

-   **"No_change-absent"** \<- though species was detected at other surrounding watersheds, it was absent at specified watershed for the duration of the time series.
-   **"Rare"** \<- Species was present at specified watershed for between 1-10% of years in the duration of the time series.
-   **"No_change-present"** \<- species at watershed is present in \>=90% of years in which data was collected.
-   **"Increasing"** \<- the presence of the species increases throughout the duration of the study (it is absent during the beginning of the study, but appears towards the end of the study)
-   **"Decreasing"** \<- the presence of the species decreases throughout the duration of the study (it is present during the beginning of the study, but then disappears towards the end of the study)
-   **"Recurrent"** \<- species is detected in consecutive years and is followed by the absence of the species for a period of time, in a distinct pattern. Species must at least two instances of presences followed by absences.
-   **"Random"** \<- species is detected sporadically for the duration of the study at watershed

Abundance Classification categories include:

-   **"No_change-absent"** \<- though species was detected at other surrounding watersheds, it was absent at specified watershed for the duration of the time series (\# years present = 0).
-   **"Rare"** \<- Species was present at specified watershed for between 1-10% of years in the duration of the time series. Abundance will not be classified.
-   **"No_change-increasing"** \<- species at watershed is above average abundance in \>=90% of years in which data was collected. #CHECKME: is this even possible?
-   **"No_change-decreasing"** \<- species at watershed is below average abundance in \>=90% of years in which data was collected. #CHECKME: is this even possible?
-   **"Increasing"** \<- the second half of the study contains most of the above average records of the species (it is mostly below average during the beginning of the study)
-   **"Decreasing"** \<- the second half of the study contains most of the below average records of the species (it is mostly above average during the beginning of the study)
-   **"Recurrent"** \<- species abundance fluctuations appear to be clumped into consecutive years, with distinct periods of above average and below average abundances.
-   **"Random"** \<- species abundance fluctuates in an unpredictable pattern for the duration of the study.

#----------------------------------------------------------------------------------

# Determining Species Incidence Classification

## Small-mammals (1992 - 2013) {.tabset}

### Small-mammals: Presence/ Absence & Incidence Classification

For this section, I am reorganizing the cleaned small-mammal data and reformatting it into a presence/absence matrix. This matrix will then run through the getTrends3.0 function to get the incidence classifications for each species at each watershed.

Conduct the **incidence classification** method
```{r smammals incidence classification}

# Sum the data based on watershed
# Here, we won't differentiate the data based on the trap lines or season
smammals <- E0_smammals %>% 
  group_by(Recyear, Watershed_name, Species) %>% 
  reframe(Count = sum(Count))

#Combine the species & watershed variables to create a unique identifier
smammals <- smammals %>% unite("Species.watershed", Species:Watershed_name, sep = ".", remove = FALSE)

#Pivot the table so that each year is a column and each row is the 'species.watershed' variable
smammals_years_wide <- smammals %>% 
  pivot_wider(names_from = "Recyear", values_from = "Count")

#Create a separate species.watershed dataframe to add back to the dataset after standardization
smammals_env <- smammals_years_wide[, 1:3]

#Standardize by presence/absence
decostand_smammals_pa <- decostand(smammals_years_wide[, -(1:3)], "pa", na.rm = TRUE )

#Transform the presence/absence data into a matrix so I can feed it to the function
smammals_pa_matrix <- as.matrix(decostand_smammals_pa)

#Apply the getTrends3.0 function to each row of the presence/absence matrix
smammals_trends <- apply(smammals_pa_matrix, 1, getTrends3.0) 

# Create a table with the species.watershed and the getTrends info. 
#   puts everything back into a dataframe format
#   1-10 stands for the number of rows in the output tibble from getTrends3.0
smammals_classification <- tibble((smammals_env),                            do.call(rbind,lapply(smammals_trends,(function(v){v[c(1:10)]}))))

#Add back in the presence/absence per year data
smammals_classification <- smammals_classification %>% add_column(decostand_smammals_pa)

# Write results to file
write_csv(smammals_classification, "Datasets/E1_output_data/E1_smammals/E1_smammals_classified.csv")
```

Conduct the **abundance classification** method
```{r smammals abundance classification}
#use the wide format count data as input; convert to matrix format and remove labels
smammals_years_matrix <- as.matrix(smammals_years_wide[, -(1:3)])

# input matrix into label_abundance method
# returns a new matrix where 0=below average, 1=above or equal to average
#   final column = proportion of years the species was absence (proportion of zeros)
abund_matrix <- smammals_years_matrix %>%
  as.data.frame() %>%
  mutate(row_id = row_number()) %>%
  split(.$row_id) %>%
  map(~ label_abundance(as.numeric(.x[ , -ncol(.x)]))) %>%
  do.call(rbind, .)

#input abund_matrix into getAbundTrends function, apply to each row of the converted matrix
smammals_abun_trends <- apply(abund_matrix, 1, getAbundTrends) 

#Create table with the getAbunTrends results annotated with species & watershed labels
#   labels from smammals_env, created earlier
smammals_abun_classification <- tibble((smammals_env), do.call(rbind,lapply(smammals_abun_trends,(function(v){v[c(1:9)]}))))

# Write to file
write_csv(smammals_abun_classification, "Datasets/E1_output_data/E1_smammals/E1_smammals_classified_abund.csv")
```

## Grasshoppers (2002 - 2020) {.tabset}

### Grasshoppers: Presence/ Absence & Incidence Classification

For this section, I am reorganizing the grasshopper data and reformatting it into a presence/absence matrix. This matrix will then be ran through the getTrends3.0 function to get the incidence classifications for each species at each watershed.

Conduct the **incidence classification** method
```{r grasshoppers incidence classification}
# Sum the data based on watershed
# Here, we won't differentiate the data based on the trap lines or season
grasshoppers <- E0_grasshoppers %>% 
  group_by(Recyear, Watershed_name, Species) %>% 
  reframe(Count = sum(Total)) %>% 
  unite("Species.watershed", Species:Watershed_name, sep = ".", remove = FALSE)

#Pivot the table so that each year is a column and each row is the 'species.watershed' variable
# years where the species was not detected should appear as NA, and are converted to zero
grasshoppers_years_wide <- grasshoppers %>% 
  pivot_wider(names_from = "Recyear", values_from = "Count") %>%
  mutate(across(4:22, ~replace_na(.,0)))

#Create a separate species.watershed dataframe to add back to the dataset after standardization
grasshoppers_env <- grasshoppers_years_wide[, 1:3]

#Standardize by presence/absence
decostand_grasshoppers_pa <- decostand(grasshoppers_years_wide[, -c(1:3)], "pa", na.rm = FALSE)

#Transform the presence/absence data into a matrix so I can feed it to the function
grasshoppers_pa_matrix <- as.matrix(decostand_grasshoppers_pa)

#Apply the getTrends3.0 function to each row of the presence/absence matrix
grasshoppers_trends <- apply(grasshoppers_pa_matrix, 1, getTrends3.0)

# Create a table with the species.watershed and the getTrends info. 
#   puts everything back into a dataframe format
#   1-10 stands for the number of rows in the output tibble from getTrends3.0
grasshoppers_classification <- tibble((grasshoppers_env), do.call(rbind,lapply(grasshoppers_trends,(function(v){v[c(1:10)]}))))

#Add back in the presence/absence per year data
grasshoppers_classification <- grasshoppers_classification %>% add_column(decostand_grasshoppers_pa)

# Write to file
write_csv(grasshoppers_classification, "Datasets/E1_output_data/E1_grasshoppers/E1_grasshoppers_classified.csv")
```

Conduct the **abundance classification** method
```{r grasshoppers abundance classification}
#use the wide format count data as input; convert to matrix format and remove labels
grasshoppers_years_matrix <- as.matrix(grasshoppers_years_wide[, -(1:3)])

# input matrix into label_abundance method
# returns a new matrix where 0=below average, 1=above or equal to average
#   final column = proportion of years the species was absence (proportion of zeros)
abund_matrix <- grasshoppers_years_matrix %>%
  as.data.frame() %>%
  mutate(row_id = row_number()) %>%
  split(.$row_id) %>%
  map(~ label_abundance(as.numeric(.x[ , -ncol(.x)]))) %>%
  do.call(rbind, .)

#input abund_matrix into getAbundTrends function, apply to each row of the converted matrix
grasshoppers_abun_trends <- apply(abund_matrix, 1, getAbundTrends) 

#Create table with the getAbunTrends results annotated with species & watershed labels
#   labels from grasshoppers_env, created earlier
grasshoppers_abun_classification <- tibble((grasshoppers_env), do.call(rbind,lapply(grasshoppers_abun_trends,(function(v){v[c(1:9)]}))))

# Write to file
write_csv(grasshoppers_abun_classification, "Datasets/E1_output_data/E1_grasshoppers/E1_grasshoppers_classified_abund.csv")
```

## Birds (1992 - 2009) {.tabset}

### Birds: Presence/ Absence & Incidence Classification

For this section, I am reorganizing the grasshopper data and reformatting it into a presence/absence matrix. This matrix will then be ran through the getTrends3.0 function to get the incidence classifications for each species at each watershed.

Conduct the **incidence classification** method
```{r birds incidence classification}
# Sum the data based on watershed
# Here, we won't differentiate the data based on the trap lines or season
birds <- E0_birds %>% 
  group_by(Recyear, Watershed_name, AOU_code) %>% 
  reframe(Count = sum(Count)) %>%
  unite("species.watershed", AOU_code:Watershed_name, sep=".", remove=FALSE)

#Pivot the table so that each year is a column and each row is the 'species.watershed' variable
# years where the species was not detected should appear as NA, and are converted to zero
birds_years_wide <- birds %>% 
  pivot_wider(names_from = "Recyear", values_from = "Count") %>%
  mutate(across(4:21, ~replace_na(.,0)))

#Create a separate species.watershed dataframe to add back to the dataset after standardization
birds_env <- birds_years_wide[, 1:3]

#Standardize by presence/absence
decostand_birds_pa <- decostand(birds_years_wide[, -c(1:3)], "pa", na.rm = FALSE)

#Transform the presence/absence data into a matrix so I can feed it to the function
birds_pa_matrix <- as.matrix(decostand_birds_pa)

#Apply the getTrends3.0 function to each row of the presence/absence matrix
birds_trends <- apply(birds_pa_matrix, 1, getTrends3.0)

# Create a table with the species.watershed and the getTrends info. 
#   puts everything back into a dataframe format
#   1-10 stands for the number of rows in the output tibble from getTrends3.0
birds_classification <- tibble((birds_env), do.call(rbind,lapply(birds_trends,(function(v){v[c(1:10)]}))))

#Add back in the presence/absence per year data
birds_classification <- birds_classification %>% add_column(decostand_birds_pa)

# Write to file
write_csv(birds_classification, "Datasets/E1_output_data/E1_birds/E1_birds_classified.csv")
```

Conduct the **abundance classification** method
```{r birds abundance classification}
#use the wide format count data as input; convert to matrix format and remove labels
birds_years_matrix <- as.matrix(birds_years_wide[, -(1:3)])

# input matrix into label_abundance method
# returns a new matrix where 0=below average, 1=above or equal to average
#   final column = proportion of years the species was absence (proportion of zeros)
abund_matrix <- birds_years_matrix %>%
  as.data.frame() %>%
  mutate(row_id = row_number()) %>%
  split(.$row_id) %>%
  map(~ label_abundance(as.numeric(.x[ , -ncol(.x)]))) %>%
  do.call(rbind, .)

#input abund_matrix into getAbundTrends function, apply to each row of the converted matrix
birds_abun_trends <- apply(abund_matrix, 1, getAbundTrends) 

#Create table with the getAbunTrends results annotated with species & watershed labels
#   labels from birds_env, created earlier
birds_abun_classification <- tibble((birds_env), do.call(rbind,lapply(birds_abun_trends,(function(v){v[c(1:9)]}))))

# Write to file
write_csv(birds_abun_classification,
          "Datasets/E1_output_data/E1_birds/E1_birds_classified_abund.csv")
```


## Plants (1992 - 2022) {.tabset}

### Plants: Presence/ Absence & Incidence Classification

For this section, I am reorganizing the bird data and reformatting it into a presence/absence matrix. This matrix will then be ran through the getTrends3.0 function to get the classifications for each species at each watershed.

**Note**: Plant data does not collect abundance as counts, but uses cover instead. 
It is recorded  on a scale of 1-7 where: 
  - 1 = <1% cover
  - 2 = 1-5% cover
  - 3 = 5-25% cover
  - 4 = 25-50% cover
  - 5 = 50-75% cover
  - 6 = 75-95% cover
  - 7 = 95-100% cover

Conduct the **incidence classification** method
```{r plants incidence classification}

# Average the data based on watershed (not using SUM because it's cover, not count, data)
# Here, we won't differentiate the data based on the trap lines or season
# NOTE: Count isn't meaningful here, but it can be converted into pres/abs later
plants <- E0_plants %>% 
  group_by(Recyear, Watershed_name, Genus_spp) %>% 
  reframe(Count = mean(Cover)) %>%
  unite("species.watershed", Genus_spp:Watershed_name, sep=".", remove=FALSE)

#Pivot the table so that each year is a column and each row is the 'species.watershed' variable
# years where the species was not detected should appear as NA, and are converted to zero
plants_years_wide <- plants %>% 
  pivot_wider(names_from = "Recyear", values_from = "Count") %>%
  mutate(across(4:34, ~replace_na(.,0)))

#Create a separate species.watershed dataframe to add back to the dataset after standardization
plants_env <- plants_years_wide[, 1:3]

#Standardize by presence/absence
decostand_plants_pa <- decostand(plants_years_wide[, -c(1:3)], "pa", na.rm = FALSE)

#Transform the presence/absence data into a matrix so I can feed it to the function
plants_pa_matrix <- as.matrix(decostand_plants_pa)

#Apply the getTrends3.0 function to each row of the presence/absence matrix
plants_trends <- apply(plants_pa_matrix, 1, getTrends3.0)

# Create a table with the species.watershed and the getTrends info. 
#   puts everything back into a dataframe format
#   1-10 stands for the number of rows in the output tibble from getTrends3.0
plants_classification <- tibble((plants_env), do.call(rbind,lapply(plants_trends,(function(v){v[c(1:10)]}))))

#Add back in the presence/absence per year data
plants_classification <- plants_classification %>% add_column(decostand_plants_pa)

# Write to file
write_csv(plants_classification, "Datasets/E1_output_data/E1_plants/E1_plants_classified.csv")
```

#TODO START HERE
#FIXME: What is the best way to deal with cover classes here? It's an ordinal variable? Can it be used for bray-curtis or any non-p/a analysis?
Maybe it still works for the abundance class, since we're only looking for above vs below average abundance as the comparison? May need to tweak the code a bit...
Conduct the **abundance classification** method
```{r plants abundance classification}
```

## Summary statistics on classification (all taxa) {.tabset}
This section makes some basic summaries of the incidence classification results.

#### Small mammals

**Compare the incidence classification results across species and watersheds**

How often did species "switch" their classifications versus stay consistent across sites?
```{r smammals_summstat}

# Make a table that counts how many times each species was classified  particular way
smammals_abun_class_summary <- smammals_abun_classification %>% 
  group_by(Species, classification) %>% 
  summarize(total_count=n(),.groups = 'drop')

# Make a table that counts how many classifications each species had (across 6 watersheds) 
smammals_class.switch1 <- smammals_classification %>% 
  group_by(Species) %>%
  summarize(count = n_distinct(classification))

# plot as a bar graph
smammals_class.switch1 %>% ggplot(aes(x = count)) + 
  #geom_histogram(binwidth = 0.5) + 
  geom_bar() +
  theme_bw() +
  geom_text(x=3.5, y=7, label= 
              "Species that switch classification at least once = 12/14 (86%)") +
  labs(x = "Number of times a species switched classification", 
       title = "Small-mammals: incidence classification switches")
```

Were species classified differently across the 6 watersheds?
```{r}
# Make a table that shows how each species was categorized, and how many times (across 6 watersheds) 
smammals_class.switch2 <- smammals_classification %>%
  group_by(Species, classification) %>%
  summarize(count = n_distinct(Watershed_name))
#view(smammals_class.switch2)

smammals_class.switch2_wide <- smammals_class.switch2 %>% pivot_wider(names_from = classification, values_from = count)
#view(smammals_class.switch2_wide)
```

How frequent were the each of the classifications across the watersheds?
```{r}
# Make a table that shows how many species were in each classification, by watershed 
smammals_class.switch3 <- smammals_classification %>%
  group_by(Watershed_name, classification) %>%
  summarize(count = n_distinct(Species))
#view(smammals_class.switch3)

smammals_class.switch3_wide <- smammals_class.switch3 %>% pivot_wider(names_from = classification, values_from = count)
view(smammals_class.switch3_wide)
```

#### Grasshoppers

**Compare the incidence classification results across species and watersheds**

How often did species "switch" their classifications versus stay consistent across sites?
```{r grasshoppers_summstat}

# Make a table that counts how many times each species was classified  particular way
grasshoppers_abun_class_summary <- grasshoppers_abun_classification %>% 
  group_by(Species, classification) %>% 
  summarize(total_count=n(),.groups = 'drop')

# Make a table that counts how many classifications each species had (across 6 watersheds) 
grasshoppers_class.switch1 <- grasshoppers_classification %>% 
  group_by(Species) %>%
  summarize(count = n_distinct(classification))

# plot as a bar graph
grasshoppers_class.switch1 %>% ggplot(aes(x = count)) + 
  #geom_histogram(binwidth = 0.5) + 
  geom_bar() +
  theme_bw() +
  geom_text(x=3.5, y=7, label= 
              "Species that switch classification at least once = 20/34 (88%)") +
  labs(x = "Number of times a species switched classification", 
       title = "Grasshoppers: incidence classification switches")
```

Were species classified differently across the 6 watersheds?
```{r}
# Make a table that shows how each species was categorized, and how many times (across 6 watersheds) 
grasshoppers_class.switch2 <- grasshoppers_classification %>%
  group_by(Species, classification) %>%
  summarize(count = n_distinct(Watershed_name))
#view(grasshoppers_class.switch2)

grasshoppers_class.switch2_wide <- grasshoppers_class.switch2 %>% 
  pivot_wider(names_from = classification, values_from = count)
#view(grasshoppers_class.switch2_wide)
```

How frequent were the each of the classifications across the watersheds?
```{r}
# Make a table that shows how many species were in each classification, by watershed 
grasshoppers_class.switch3 <- grasshoppers_classification %>%
  group_by(Watershed_name, classification) %>%
  summarize(count = n_distinct(Species))
#view(grasshoppers_class.switch3)

grasshoppers_class.switch3_wide <- grasshoppers_class.switch3 %>% 
  pivot_wider(names_from = classification, values_from = count)
view(grasshoppers_class.switch3_wide)
```

#### Birds
TODO

#### Plants
TODO


## Dissimilarity from baseline year and between watersheds (all taxa) {.tabset}

This section is for conducting dissimilarity tests between watersheds for the small-mammal dataset.

These dissimilarity tests will include Jaccard's and Bray comparison for: - the first year to each subsequent year of the time series, within watersheds - across watersheds, within each year separately

Is dissimilarity increasing through time? Is the rate of composition change different according to treatment?

#### Small mammal Composition

Save results for **Small mammal composition dissimilarity**
```{r}
# prepare the count data into wide format with merged column for watershed_year
smammals_count_allyears <- smammals %>% 
  group_by(Watershed_name, Species, Recyear) %>% 
  reframe(Total = (Count)) %>% 
  pivot_wider(names_from = "Species", values_from = "Total", 
              values_fn = function(x) paste(sum(x))) %>%
  unite("Watershed_year", Watershed_name:Recyear, sep = "_")

# small mammal dissimilarity estimates
sm_jacc <- compute_dissimilarity(smammals_count_allyears, method="jaccard", baseline_year = 1992)
sm_bray <- compute_dissimilarity(smammals_count_allyears, method="bray", baseline_year = 1992)

# merge and write results
sm_baseline <- merge(sm_jacc[1], sm_bray[1])
sm_watershed <- merge(sm_jacc[2], sm_bray[2])

##Save to file
write.csv(sm_baseline, "Datasets/E1_output_data/E1_smammals/E1_smammals_dissimilarity_year1toN.csv")

write.csv(sm_watershed, "Datasets/E1_output_data/E1_smammals/E1_smammals_dissimilarity_watersheds.csv")
```

#### Grasshopper Composition

Save results for **Grasshopper composition dissimilarity**
```{r}
# prepare the count data into wide format with merged column for watershed_year
grasshoppers_count_allyears <- grasshoppers %>% 
  group_by(Watershed_name, Species, Recyear) %>% 
  reframe(Total = (Count)) %>% 
  pivot_wider(names_from = "Species", values_from = "Total", 
              values_fn = function(x) paste(sum(x))) %>%
  unite("Watershed_year", Watershed_name:Recyear, sep = "_") %>%
  replace(is.na(.), "0")

# find the first year of the study
year1 <- min(grasshoppers$Recyear)

# grasshopper dissimilarity estimates
gh_jacc <- compute_dissimilarity(grasshoppers_count_allyears, method="jaccard", baseline_year = year1)
gh_bray <- compute_dissimilarity(grasshoppers_count_allyears, method="bray", baseline_year = year1)

# merge and write results
gh_baseline <- merge(gh_jacc[1], gh_bray[1])
gh_watershed <- merge(gh_jacc[2], gh_bray[2])

##Save to file
write.csv(gh_baseline, "Datasets/E1_output_data/E1_grasshoppers/E1_grasshoppers_dissimilarity_year1toN.csv")

write.csv(gh_watershed, "Datasets/E1_output_data/E1_grasshoppers/E1_grasshoppers_dissimilarity_watersheds.csv")
```

#### Bird Composition

Save results for **Bird composition dissimilarity**
```{r}
# prepare the count data into wide format with merged column for watershed_year
## First, populating the dataset with NA's by grouping the dataset by Watershed and Species, then pivoting wider. I found if I subsetted by watershed from the 'birds' dataset first, then there would be species missing since not all species were at every watershed. 
birds_count_allyears <- birds %>% 
  group_by(Watershed_name, AOU_code, Recyear) %>% 
  reframe(Total = (Count)) %>% 
  pivot_wider(names_from = "AOU_code", values_from = "Total",
              values_fn = function(x) paste(sum(x))) %>%
  unite("Watershed_year", Watershed_name:Recyear, sep="_") %>%
  replace(is.na(.),"0")

# find the first year of the study
year1 <- min(birds$Recyear)

# bird dissimilarity estimates
bd_jacc <- compute_dissimilarity(birds_count_allyears, method="jaccard", baseline_year = year1)
bd_bray <- compute_dissimilarity(birds_count_allyears, method="bray", baseline_year = year1)

# merge and write results
bd_baseline <- merge(bd_jacc[1], bd_bray[1])
bd_watershed <- merge(bd_jacc[2], bd_bray[2])

##Save to file
write.csv(bd_baseline, "Datasets/E1_output_data/E1_birds/E1_birds_dissimilarity_year1toN.csv")

write.csv(bd_watershed, "Datasets/E1_output_data/E1_birds/E1_birds_dissimilarity_watersheds.csv")
```

#### Plant Composition

#TODO: WORK ON NEXT; COVER CLASSES
Jaccard likely OK, but Bray-curtis may need rethinking
Save results for **Plant composition dissimilarity**
```{r}
#FIXME: What will need to be handled differently for plants? Using percent cover, not count; use mean percent cover instead? something else? Check with KNZ data manager and recent pubs?
```


#TODO: START HERE AGAIN
# TODO: BEGIN AGAIN - THIS TIME WRITE A FUNCTION THAT CAN STREAMLINE THE RICHNESS ANALYSIS ACROSS TAXA

## Species Richness change over time (all taxa) {.tabset}

#### Small mammals

```{r smammals richness}

# Take the table already created for the species presence/absence matrix, then 
#   add in the year and watershed information back in, then 
#   pivot the data into a long format,
#   where 'Recyear' column is a numeric column, and 
#   the 'Watershed_name' column into a factor
smammals_sprich <- decostand_smammals_pa %>% 
  add_column(smammals_env) %>% 
  pivot_longer(cols = "1992":"2013", 
               names_to = "Recyear", 
               values_to = "Presence") %>% 
  mutate(Recyear = as.numeric(Recyear),
         Watershed_name = factor(Watershed_name))


#Sum the presences of each species at each watershed and year to get a value for species richness
smammals_sprich <- smammals_sprich %>% 
  group_by(Watershed_name, Recyear) %>% 
  reframe(Richness = sum(Presence))

#Pivot the dataset 
smammals_sprich_wide <- smammals_sprich %>% 
  pivot_wider(names_from = "Recyear", 
              values_from = "Richness")

#Use 'purr' to run the model. The gather function get the values we need, and the group_by function makes sure the values are grouped by 'Watershed_name'. 
#   'n' is the row number, which translates to the year (1992 = 1, 1993 = 2... 2022 = 31). 
#   The arrange function orders the data by 'Watershed_name' and row number. 
#   The nest function nests all the data (year/row number, and richness) into a single column, while each row is a watershed. 
#   The rest of the code runs the linear models for each row, and creates new columns with the outputs.
smammals_sprich_lm <- smammals_sprich_wide %>%
  gather('year', 'value', -Watershed_name) %>%
  group_by(Watershed_name) %>%
  mutate(n = row_number()) %>%
  arrange(Watershed_name, n) %>%
  nest() %>%
  mutate(model = map(data, fit_model)) %>%
  mutate(slope = map_dbl(model, get_slope)) %>%
  mutate(p_value = map_dbl(model, get_p_value)) %>%
  mutate(rsquared = map_dbl(model, get_rsq))

# eliminate the list type before writing to file (this is the detailed model results)
smammals_sprich_lm_short <- smammals_sprich_lm %>%
  dplyr::select(Watershed_name, slope, p_value, rsquared)

#Save richness data 
write.csv(smammals_sprich, "Datasets/E1_output_data/E1_smammals/E1_smammals_richness.csv")

#Save richness model results
write.csv(smammals_sprich_lm_short, "Datasets/E1_output_data/E1_smammals/E1_smammals_richness_lm.csv")
```

#### Grasshoppers

#### Birds

#### Plants


## Abundance change over time (all taxa) {.tabset}


#### Small-mammals; count data

```{r small mammals abundnce}
#make a version of the wide dataset without the extra columns, for the linear model analysis
smammals_spabund <- smammals_years_wide %>% 
  dplyr::select(-Watershed_name, -Species, -Common_name)

#Use 'purr' to run the model. The gather function get the values we need, and the group_by function makes sure the values are grouped by 'Watershed_name'. 
#   'n' is the row number, which translates to the year (1992 = 1, 1993 = 2... 2022 = 31). 
#   The arrange function orders the data by 'Watershed_name' and row number. 
#   The nest function nests all the data (year/row number, and richness) into a single column, while each row is a watershed. 
#   The rest of the code runs the linear models for each row, and creates new columns with the outputs.
smammals_spabun_lm <- smammals_spabund %>%
  gather('year', 'value', -Species.watershed) %>%
  group_by(Species.watershed) %>%
  mutate(n = row_number()) %>%
  arrange(Species.watershed, n) %>%
  nest() %>%
  mutate(model = map(data, fit_model)) %>%
  mutate(slope = map_dbl(model, get_slope)) %>%
  mutate(p_value = map_dbl(model, get_p_value)) %>%
  mutate(rsquared = map_dbl(model, get_rsq))

# eliminate the list type before writing to file (this is the detailed model results)
smammals_spabun_lm_short <- smammals_spabun_lm %>%
  dplyr::select(Species.watershed, slope, p_value, rsquared) %>%
  separate(Species.watershed, c("Genus", "Spp", "Watershed_name")) %>%
  unite("Species", Genus:Spp, sep = "_") 

#Save abundance data 
write.csv(smammals_years_wide, "Datasets/E1_output_data/E1_smammals/E1_smammals_abundance.csv")

#Save abundance model results
write.csv(smammals_spabun_lm_short, "Datasets/E1_output_data/E1_smammals/E1_smammals_abundance_lm.csv")
```

#### Grasshoppers; count data

#### Birds; count data

#### Plants; percent cover data
TODO: figure out how to best deal with this data. Really shouldn't be summing it


#------------------------old code to modify, streamline, and remove: TODO

### Grasshoppers: Species Richness

```{r}

#Taking the table already created for the species presence/absence matrix, then adding in the year and watershed information back in, then pivoting the data into a long format.
grasshoppers_sprich <- decostand_grasshoppers_pa %>% 
  add_column(grasshoppers_env) %>% 
  pivot_longer(cols = "2002":"2020", 
               names_to = "Recyear", 
               values_to = "Presence")

#Mutating the 'Recyear' column into a numeric column, and the 'Watershed_name' column into a factor
grasshoppers_sprich <- grasshoppers_sprich %>% 
  mutate(Recyear = as.numeric(Recyear),
         Watershed_name = factor(Watershed_name))

#Summing the presences of each species at each watershed and year to get a number for species richness
grasshoppers_sprich <- grasshoppers_sprich %>% 
  group_by(Watershed_name, Recyear) %>% 
  reframe(Richness = sum(Presence))

#Pivoting the dataset 
grasshoppers_sprich_wide <- grasshoppers_sprich %>% 
  pivot_wider(names_from = "Recyear", 
              values_from = "Richness")

#Using 'purr' to run the model. The gather function get the values we need, and the group_by function makes sure the values are grouped by 'Watershed_name'. 'n' is the row number, which translates to the year (1992 = 1, 1993 = 2... 2022 = 31). The arrange function orders the data by 'Watershed_name' and row number. The nest function nests all the data (year/row number, and richness) into a single column, while each row is a watershed. The rest of the code runs the linear models for each row, and creates new columns with the outputs.
grasshoppers_sprich_values <- grasshoppers_sprich_wide %>%
  gather('year', 'value', -Watershed_name) %>%
  group_by(Watershed_name) %>%
  mutate(n = row_number()) %>%
  arrange(Watershed_name, n) %>%
  nest() %>%
  mutate(model = map(data, fit_model)) %>%
  mutate(slope = map_dbl(model, get_slope)) %>%
  mutate(p_value = map_dbl(model, get_p_value)) %>%
  mutate(rsquared = map_dbl(model, get_rsq))

#Selecting the columns with the relevant info I want to keep
grasshoppers_sprich_values_shortened <- grasshoppers_sprich_values %>% dplyr::select(Watershed_name, slope, p_value, rsquared)

#Combines the richness per year by watershed with the values of the model output (this is for ease of graphing later). This means the model output values by watershed('slope', 'p_value', and 'rsquared') will be repeated for each year.
grasshoppers_sprich_all <- left_join(grasshoppers_sprich, grasshoppers_sprich_values_shortened, by = "Watershed_name")


#Saving the data frame with the species richness outputs into the E1_output_data folder located in project directory 
write.csv(grasshoppers_sprich_all, "Datasets/E1_output_data/E1_grasshoppers/E1_grasshoppers_richness.csv")



#Species richness calculation
grasshoppers_sprich <- decostand_grasshoppers_pa %>% 
  add_column(grasshoppers_env) %>% pivot_longer(cols = "2002":"2020",
                                                                                       names_to = "Recyear",
     values_to = "Presence")

grasshoppers_sprich <- grasshoppers_sprich %>% mutate(Recyear = as.numeric(Recyear),
                                              Watershed_name = factor(Watershed_name))
grasshoppers_sprich$Watershed_name <- factor(grasshoppers_sprich$Watershed_name,
                                        levels = c("1D", "N1B", "4B", 
                                           "4F", "N4A", "N4D", 
                                           "20B", "N20B"))

grasshoppers_sprich <- grasshoppers_sprich %>% group_by(Watershed_name, Recyear) %>% reframe(Richness = sum(Presence))


grasshoppers_sprich %>% ggplot(aes(x = Recyear, y = Richness)) + 
  geom_point() + facet_wrap(.~Watershed_name, ncol=4) + 
  geom_smooth(method = "lm", se = FALSE) + 
  theme_bw() +
  theme(text = element_text(size=10),
        axis.text.x = element_text(angle=45, hjust=1, size =10)) +
  labs(title = "Grasshoppers Species Richness per Year and Watershed")  +
  ggpubr::stat_cor()

```







### Birds: Calculating Summary Statistics

```{r}
view(birds_classification)

birds_class.switch <- birds_classification %>% 
  group_by(AOU_code, classification) %>%
  summarize(total_count=n(),.groups = 'drop')


view(birds_class.switch)

birds_class.switch1 <- birds_classification %>% 
  group_by(AOU_code) %>%
  summarize(count = n_distinct(classification))

birds_class.switch1 %>% ggplot(aes(x = count)) + 
  geom_histogram(binwidth = 0.5) + 
  theme_bw() +
  labs(title = "birds: Classification switches",
       x = "Number of Times a Species Switched Classifications",
       y = "Count of Species")

birds_class.switch2 <- birds_classification %>%
  group_by(AOU_code, classification) %>%
  summarize(count = n_distinct(Watershed_name))

view(birds_class.switch2)

birds_class.switch2_wide <- birds_class.switch2 %>% pivot_wider(names_from = classification, values_from = count)

view(birds_class.switch2_wide)


birds_class.switch3 <- birds_classification %>%
  group_by(Watershed_name, classification) %>%
  summarize(count = n_distinct(Species))

view(birds_class.switch3)

birds_class.switch3_wide <- birds_class.switch3 %>% pivot_wider(names_from = classification, values_from = count)

view(birds_class.switch3_wide)


```

### Birds: Species Richness

```{r}

#Taking the table already created for the species presence/absence matrix, then adding in the year and watershed information back in, then pivoting the data into a long format.
birds_sprich <- decostand_birds_pa %>% 
  add_column(birds_env) %>% 
  pivot_longer(cols = "1992":"2009", 
               names_to = "Recyear", 
               values_to = "Presence")

#Mutating the 'Recyear' column into a numeric column, and the 'Watershed_name' column into a factor
birds_sprich <- birds_sprich %>% 
  mutate(Recyear = as.numeric(Recyear),
         Watershed_name = factor(Watershed_name))

#Summing the presences of each species at each watershed and year to get a number for species richness
birds_sprich <- birds_sprich %>% 
  group_by(Watershed_name, Recyear) %>% 
  reframe(Richness = sum(Presence))

#Pivoting the dataset 
birds_sprich_wide <- birds_sprich %>% 
  pivot_wider(names_from = "Recyear", 
              values_from = "Richness")

#Using 'purr' to run the model. The gather function get the values we need, and the group_by function makes sure the values are grouped by 'Watershed_name'. 'n' is the row number, which translates to the year (1992 = 1, 1993 = 2... 2022 = 31). The arrange function orders the data by 'Watershed_name' and row number. The nest function nests all the data (year/row number, and richness) into a single column, while each row is a watershed. The rest of the code runs the linear models for each row, and creates new columns with the outputs.
birds_sprich_values <- birds_sprich_wide %>%
  gather('year', 'value', -Watershed_name) %>%
  group_by(Watershed_name) %>%
  mutate(n = row_number()) %>%
  arrange(Watershed_name, n) %>%
  nest() %>%
  mutate(model = map(data, fit_model)) %>%
  mutate(slope = map_dbl(model, get_slope)) %>%
  mutate(p_value = map_dbl(model, get_p_value)) %>%
  mutate(rsquared = map_dbl(model, get_rsq))

#Selecting the columns with the relevant info I want to keep
birds_sprich_values_shortened <- birds_sprich_values %>% dplyr::select(Watershed_name, slope, p_value, rsquared)

#Combines the richness per year by watershed with the values of the model output (this is for ease of graphing later). This means the model output values by watershed('slope', 'p_value', and 'rsquared') will be repeated for each year.
birds_sprich_all <- left_join(birds_sprich, birds_sprich_values_shortened, by = "Watershed_name")


#Saving the data frame with the species richness outputs into the E1_output_data folder located in project directory 
write.csv(birds_sprich_all, "Datasets/E1_output_data/E1_birds/E1_birds_richness.csv")



birds_sprich %>% ggplot(aes(x = Recyear, y = Richness)) + 
  geom_point() + facet_wrap(.~Watershed_name, nrow=2) + 
  geom_smooth(method = "lm", se = FALSE) + 
  theme_bw() +
  theme(text = element_text(size=10),
        axis.text.x = element_text(angle=45, hjust=1, size =10)) +
  labs(title = "Birds Species Richness per Year and Watershed") + 
  ggpubr::stat_cor()

```

## Plants (1992 - 2022)

### Plants: Presence/ Absence & Incidence Classification


### Plants Dissimilarity Between Watersheds

This section is for conducting dissimilarity tests between watersheds for the plant dataset.

These dissimilarity tests will include a Jaccard's dissimilarity test for the first year of the time series, a Jaccard's dissimilarity test for the last year of the time series, a Jaccard's dissimilarity test for the overall time-series, and a Bray-Curtis dissimilarity test for the overall time-series.

```{r plants dissimilarity}


#Jaccard's dissimilarity for the first year in the time series, 1992

##Creating the needed data frame by subsetting the year 1992, then grouping the plants data frame by watershed and species and just pasting the species cover, then pivoting so that each watershed is a row and each species is a column
plants_jacc_diss_year1 <- plants %>% 
  subset(Recyear == 1992) %>%
  group_by(Watershed_name, Genus_spp) %>% 
  reframe(Total = (Cover)) %>% 
  pivot_wider(names_from = "Genus_spp", values_from = "Total", 
              values_fn = function(x) paste(sum(x)))

##Making all the values numeric instead of characters
plants_jacc_diss_year1[,-c(1)] <- plants_jacc_diss_year1[, -c(1)] %>% 
  mutate_if(is.character, as.numeric)  

##Converting all NA's into zeroes
plants_jacc_diss_year1[is.na(plants_jacc_diss_year1)] <- 0

##Standardizing the species counts by presence/absence, then conducting a Jaccard's dissimilarity test accross watersheds
plants_jacc_diss_year1 <- plants_jacc_diss_year1[, -c(1)] %>% 
  decostand(method = "pa") %>% 
  vegdist(method = "jaccard")


##Taking the matrix output of the Jaccard's dissimilarity test and adding row/column names based in the order of the watersheds in 'plants_jacc_diss_year1'
plants_jacc_diss_year1 <- as.matrix(plants_jacc_diss_year1)
dimnames(plants_jacc_diss_year1) <- list(c("1D", "20B", "4A", 
                                           "4B", "N1B", "N20B", 
                                           "N4A", "N4D"), 
                                         c("1D", "20B", "4A", 
                                           "4B", "N1B", "N20B", 
                                           "N4A", "N4D"))

##Creating a data frame with the outputs, having the watershed pairs as rows (one column is the first watershed, the second column is the watershed it is being compared to, and the third column is contains the dissimilarity values). I will be adding outputs from other dissimilarity matricees to this data frame.
plants_diss <- as.data.frame.table(as.matrix(plants_jacc_diss_year1))
#Renaming the column name for the dissimilarity outputs since I'll be adding to this data frame later on
plants_diss <- plants_diss %>% rename("JaccDiss_year1" = "Freq")




#Jaccard's dissimilarity for the last year in the time series, 2022

##Creating the needed data frame by subsetting the year 2022, then grouping the plants data frame by watershed and species and just pasting the species cover, then pivoting so that each watershed is a row and each species is a column
plants_jacc_diss_year31 <- plants %>% 
  subset(Recyear == 2022) %>%
  group_by(Watershed_name, Genus_spp) %>% 
  reframe(Total = (Cover)) %>% 
  pivot_wider(names_from = "Genus_spp", values_from = "Total", 
              values_fn = function(x) paste(sum(x)))

##Making all the values numeric instead of characters
plants_jacc_diss_year31[,-c(1)] <- plants_jacc_diss_year31[, -c(1)] %>% 
  mutate_if(is.character, as.numeric)  

##Converting all NA's to zeroes
plants_jacc_diss_year31[is.na(plants_jacc_diss_year31)] <- 0

##Standardizing the species counts by presence/absence, then conducting a Jaccard's dissimilarity test accross watersheds
plants_jacc_diss_year31 <- plants_jacc_diss_year31[, -c(1)] %>% 
  decostand(method = "pa") %>% 
  vegdist(method = "jaccard")

##Taking the matrix output of the Jaccard's dissimilarity test and adding row/column names based in the order of the watersheds in 'plants_jacc_diss_year19'
plants_jacc_diss_year31 <- as.matrix(plants_jacc_diss_year31)
dimnames(plants_jacc_diss_year31) <- list(c("1D", "20B", "4A", 
                                           "4B", "N1B", "N20B", 
                                           "N4A", "N4D"), 
                                         c("1D", "20B", "4A", 
                                           "4B", "N1B", "N20B", 
                                           "N4A", "N4D"))

##Converting the matrix into a data frame
plants_diss_year31 <- as.data.frame.table(as.matrix(plants_jacc_diss_year31))

##Joining the dissimilarity data frame for year 19 to the overall dissimilarity data frame. Var1 and Var2 are the pairs of watersheds. I'll change this later on when I am done adding to this data frame.
plants_diss <- left_join(plants_diss, 
                        plants_diss_year31, 
                        by = c("Var1", "Var2"))
#Renaming the dissimilarity output column to 'JaccDiss_year19' for clarity
plants_diss <- plants_diss %>% rename("JaccDiss_year31" = "Freq")




#Jaccard's Dissimilarity on the overall plants dataset, summing the individual species cover by watershed

##Transforming the cover estimates into discrete numbers based on the cover categories mid-way points (THIS IS ALL FOR THE BRAY-CURTIS CALCULATION LATER!): 
#1 = <1% cover = 0.5 individuals
#2 = 1-5% cover = 3 individuals
#3 = 5-25% cover = 15 individuals
#4 = 25-50% cover = 37.5 individuals
#5 = 50-75% cover = 62.5 individuals
#6 = 75-95% cover = 85 individuals
#7 = 95-100% cover = 97.5 individuals

plants_diss_overall <- E0_plants
plants_diss_overall <- plants_diss_overall %>% mutate(Cover_transformed = NA)
for (pp in 1:nrow(plants_diss_overall)){
  if (plants_diss_overall$Cover[pp] == 1){plants_diss_overall$Cover_transformed[pp] <- 0.5}
  if (plants_diss_overall$Cover[pp] == 2){plants_diss_overall$Cover_transformed[pp] <- 3}
  if (plants_diss_overall$Cover[pp] == 3){plants_diss_overall$Cover_transformed[pp] <- 15}
  if (plants_diss_overall$Cover[pp] == 4){plants_diss_overall$Cover_transformed[pp] <- 37.5}
  if (plants_diss_overall$Cover[pp] == 5){plants_diss_overall$Cover_transformed[pp] <- 62.5}
  if (plants_diss_overall$Cover[pp] == 6){plants_diss_overall$Cover_transformed[pp] <- 85}
  if (plants_diss_overall$Cover[pp] == 7){plants_diss_overall$Cover_transformed[pp] <- 97.5}
}

#Selecting the columns I want for the dissimilarity tests
plants_diss_overall <- plants_diss_overall %>% 
  group_by(Recyear, Genus_spp, Watershed_name) %>% 
  reframe(Cover = sum(Cover_transformed))


##Grouping the plants data frame by watershed and species and summing the species cover through the years, then pivoting so that each watershed is a row and each species is a column
plants_diss_overall <- plants_diss_overall %>%  
  group_by(Watershed_name, Genus_spp) %>% 
  reframe(Total = sum(Cover)) %>% 
  pivot_wider(names_from = "Genus_spp", values_from = "Total", 
              values_fn = function(x) paste(sum(x)))

##Making all the values numeric instead of characters
plants_diss_overall[,-c(1)] <- plants_diss_overall[, -c(1)] %>% 
  mutate_if(is.character, as.numeric)  

##Converting all NA's into zeroes
plants_diss_overall[is.na(plants_diss_overall)] <- 0

##Standardizing the species counts by presence/absence, then conducting a Jaccard's dissimilarity test accross watersheds
plants_jacc_overall <- plants_diss_overall[, -c(1)] %>% 
  decostand(method = "pa") %>% 
  vegdist(method = "jaccard")

##Taking the matrix output of the Jaccard's dissimilarity test and adding row/column names based in the order of the watersheds in 'plants_diss_overall'
plants_jacc_overall <- as.matrix(plants_jacc_overall)
dimnames(plants_jacc_overall) <- list(c("1D", "20B", "4A", 
                                       "4B", "N1B", "N20B", 
                                       "N4A", "N4D"), 
                                     c("1D", "20B", "4A", 
                                       "4B", "N1B", "N20B", 
                                       "N4A", "N4D"))

##Transforming the dissimilarity matrix to a data frame, then adding the output to the already created data frame.
plants_jacc_overall <- as.data.frame.table(as.matrix(plants_jacc_overall))
plants_diss <- left_join(plants_diss, 
                         plants_jacc_overall, 
                         by = c("Var1", "Var2"))
##Renaming the dissimilarity output numbers to 'JaccDiss_overall'
plants_diss <- plants_diss %>% rename("JaccDiss_overall" = "Freq")




#Bray-Curtis dissimilarity for overall plants dataset, summing the individual species counts by watershed

##Standardizing for the percent abundance of each species based on the total abundance across each watershed, then conducting a Bray-Curtis dissimilarity test on the output
plants_bc_overall <- plants_diss_overall[, -c(1)] %>% 
  mutate_if(is.character, as.numeric) %>% 
  decostand(method = "total") %>% 
  vegdist(method = "bray")

#Taking the matrix output of the Bray-Curtis dissimilarity test and adding row/column names based in the order of the watersheds in 'plants_diss_overall'
plants_bc_overall <- as.matrix(plants_bc_overall)
dimnames(plants_bc_overall) <- list(c("1D", "20B", "4A", 
                                     "4B", "N1B", "N20B", 
                                     "N4A", "N4D"), 
                                   c("1D", "20B", "4A", 
                                     "4B", "N1B", "N20B", 
                                     "N4A", "N4D"))

#Transforming the dissimilarity matrix to a data frame, then adding the output to the already created data frame.
plants_bc_overall <- as.data.frame.table(as.matrix(plants_bc_overall))
plants_diss <- left_join(plants_diss, 
                         plants_bc_overall, 
                         by = c("Var1", "Var2"))
##Renaming the dissimilarity output numbers to 'BrayDiss_overall'
plants_diss <- plants_diss %>% rename("BrayDiss_overall" = "Freq")

#Renaming the 'var1' and 'var2' columns to 'watershed1' and 'watershed2'
plants_diss <- plants_diss %>% rename("Watershed1" = "Var1",
                                          "Watershed2" = "Var2")

##Saving the data frame with all dissimilarity outputs into the E1_output_data folder located in project directory 
write.csv(plants_diss, "Datasets/E1_output_data/E1_plants/E1_plants_dissimilarity.csv")




```

### Plants: Dissimilarity Between Years by Watershed

```{r}
## First, populating the dataset with NA's by grouping the dataset by Watershed and Species, then pivoting wider. I found if I subsetted by watershed from the 'birds' dataset first, then there would be species missing since not all species were at every watershed. 

plants1 <- plants %>% group_by(Watershed_name, Genus_spp, Recyear) %>% 
  reframe(Total = (Cover)) %>% 
  pivot_wider(names_from = "Genus_spp", values_from = "Total",
              values_fn = function(x) paste(sum(x))) %>%
    mutate_at(2:327, as.numeric)

## Making the NA's zeroes
plants1[is.na(plants1)] <- 0

unique(plants1$Watershed_name)

#FOR WATERSHED 1D

## Subsetting watershed "1D", the summarizing data based on the counts of species per year. Pivoting the output into a wide format so that each row is a species name and each column is a year from 1992 to 2022, and the values are the species counts per year.
plants_jaccdiss_1D <- plants1 %>% 
  subset(Watershed_name == "1D")

## Reordering the Recyear column since it is out of numerical order for some reason
plants_jaccdiss_1D$Recyear <- str_sort(plants_jaccdiss_1D$Recyear, numeric = TRUE)


## Transforming the species counts to just presence/absence values, removing the species names column from the matrix for the dissimilarity test, then running a Jaccard's dissimilarity test on the differences between years.
plants_jaccdiss_1D <- 
  plants_jaccdiss_1D[, -c(1:2)] %>% 
  decostand(method = "pa") %>% 
  vegdist(method = "jaccard")

## Having the Jaccard's dissimilarity output be coded and saved as a matrix
plants_jaccdiss_1D<- as.matrix(plants_jaccdiss_1D)
## Taking that matrix and adding in dimension names (the years of the data) to make the matrix readable.
dimnames(plants_jaccdiss_1D) <- list(c("1992", "1993", "1994", "1995", "1996", "1997", "1998", "1999", "2000", "2001", "2002", "2003", "2004", "2005", "2006", "2007", "2008", "2009", "2010", "2011", "2012", "2013", "2014", "2015", "2016", "2017", "2018", "2019", "2020", "2021", "2022"), 
                                       c("1992", "1993", "1994", "1995", "1996", "1997", "1998", "1999", "2000", "2001", "2002", "2003", "2004", "2005", "2006", "2007", "2008", "2009", "2010", "2011", "2012", "2013", "2014", "2015", "2016", "2017", "2018", "2019", "2020", "2021", "2022"))

## Transforming the Jaccard's dissimilarity matrix into a data frame and renaming the automatically created column names, so now the columns include "Year1": the first year being compared, "Year2": the year that is being compared to Var1, and "Jacc_diss": the Jaccard's dissimilarity value.
plants_jaccdiss_1D_df <- as.data.frame.table(as.matrix(plants_jaccdiss_1D)) %>%
  rename("Year1" = "Var1",
         "Year2" = "Var2" ,
         "Jacc_diss" = "Freq")


## Subsetting "1992", meaning the remaining values will be the Jaccard's dissimilarity compared to the baseline year 
plants_jaccdiss_1D_df <- plants_jaccdiss_1D_df %>% 
  subset(Year1 == "1992") %>% 
  mutate(Year2 = as.numeric(Year2))
  
## Creating a plot to show how dissimilarity in species presence compared to the baseline year for watershed 1D in the small mammals dataset
plants_jaccdiss_1D_plot <- 
  plants_jaccdiss_1D_df[-(1), ] %>% 
  ggplot(aes(x = Year2, y = Jacc_diss)) + 
  geom_point() + #alpha = 0.5, size = 4, color="#B71C1C") +
  geom_smooth(method = "lm") +
  ggpubr::stat_cor() +
  theme_bw() +
  geom_label(label="1D", 
    x=30,
    y=1.00,
    label.padding = unit(0.55, "lines"), # Rectangle size around label
    label.size = 0.6,
    color = "white", fill="black") +
  ylim(0, 1) +
  labs(y = "Jaccard's Dissimilarity", x = "")




#FOR WATERSHED N1B

## Subsetting watershed "N1B", the summarizing data based on the counts of species per year. Pivoting the output into a wide format so that each row is a species name and each column is a year from 1992 to 2013, and the values are the species counts per year.
plants_jaccdiss_N1B <- plants1 %>% 
  subset(Watershed_name == "N1B") 
## Reordering the Recyear column since it is out of numerical order for some reason
plants_jaccdiss_N1B$Recyear <- str_sort(plants_jaccdiss_N1B$Recyear, numeric = TRUE)


## Transforming the species counts to just presence/absence values, removing the species names column from the matrix for the dissimilarity test, then running a Jaccard's dissimilarity test on the differences between years.
plants_jaccdiss_N1B <- 
  plants_jaccdiss_N1B[, -c(1:2)] %>% 
  decostand(method = "pa") %>% 
  vegdist(method = "jaccard")

## Having the Jaccard's dissimilarity output be coded and saved as a matrix
plants_jaccdiss_N1B <- as.matrix(plants_jaccdiss_N1B)
## Taking that matrix and adding in dimension names (the years of the data) to make the matrix readable.
dimnames(plants_jaccdiss_N1B) <- list(c("1992", "1993", "1994", "1995", "1996", "1997", "1998", "1999", "2000", "2001", "2002", "2003", "2004", "2005", "2006", "2007", "2008", "2009", "2010", "2011", "2012", "2013", "2014", "2015", "2016", "2017", "2018", "2019", "2020", "2021", "2022"), 
                                       c("1992", "1993", "1994", "1995", "1996", "1997", "1998", "1999", "2000", "2001", "2002", "2003", "2004", "2005", "2006", "2007", "2008", "2009", "2010", "2011", "2012", "2013", "2014", "2015", "2016", "2017", "2018", "2019", "2020", "2021", "2022"))

## Transforming the Jaccard's dissimilarity matrix into a data frame and renaming the automatically created column names, so now the columns include "Year1": the first year being compared, "Year2": the year that is being compared to Var1, and "Jacc_diss": the Jaccard's dissimilarity value.
plants_jaccdiss_N1B_df <- as.data.frame.table(as.matrix(plants_jaccdiss_N1B)) %>%
  rename("Year1" = "Var1",
         "Year2" = "Var2" ,
         "Jacc_diss" = "Freq")

## Subsetting "1992", meaning the remaining values will be the Jaccard's dissimilarity compared to the baseline year 
plants_jaccdiss_N1B_df <- 
  plants_jaccdiss_N1B_df %>% 
  subset(Year1 == "1992") %>% 
  mutate(Year2 = as.numeric(Year2))
  
## Creating a plot to show how dissimilarity in species presence compared to the baseline year for watershed N1B in the small mammals dataset
plants_jaccdiss_N1B_plot <- 
  plants_jaccdiss_N1B_df[-(1), ] %>% 
  ggplot(aes(x = Year2, y = Jacc_diss)) + 
  geom_point() + # alpha = 0.5, size = 4, color = "#880E4F") +
 # geom_smooth(method = "lm") +
  ggpubr::stat_cor() +
  theme_bw() +
   geom_label(label="N1B", 
    x=30,
    y=1.00,
    label.padding = unit(0.55, "lines"), # Rectangle size around label
    label.size = 0.6,
    color = "white", fill="black") +
    ylim(0, 1) + 
  labs(y = "Jaccard's Dissimilarity", x = "Year from Baseline")


## FOR WATERSHED 4A

## Subsetting watershed "4A", the summarizing data based on the counts of species per year. Pivoting the output into a wide format so that each row is a species name and each column is a year from 1992 to 2009, and the values are the species counts per year.
plants_jaccdiss_4A <- plants1 %>% 
  subset(Watershed_name == "4A")

## Reordering the Recyear column since it is out of numerical order for some reason
plants_jaccdiss_4A$Recyear <- str_sort(plants_jaccdiss_4A$Recyear, numeric = TRUE)


## Transforming the species counts to just presence/absence values, removing the species names column from the matrix for the dissimilarity test, then running a Jaccard's dissimilarity test on the differences between years.
plants_jaccdiss_4A <- 
  plants_jaccdiss_4A[, -c(1:2)] %>% 
  decostand(method = "pa") %>% 
  vegdist(method = "jaccard")

## Having the Jaccard's dissimilarity output be coded and saved as a matrix
plants_jaccdiss_4A <- as.matrix(plants_jaccdiss_4A)

## Taking that matrix and adding in dimension names (the years of the data) to make the matrix readable.
dimnames(plants_jaccdiss_4A) <- list(c("1992", "1993", "1994", "1995", "1996", "1997", "1998", "1999", "2000", "2001", "2002", "2003", "2004", "2005", "2006", "2007", "2008", "2009", "2010", "2011", "2012", "2013", "2014", "2015", "2016", "2017", "2018", "2019", "2020", "2021", "2022"), 
                                       c("1992", "1993", "1994", "1995", "1996", "1997", "1998", "1999", "2000", "2001", "2002", "2003", "2004", "2005", "2006", "2007", "2008", "2009", "2010", "2011", "2012", "2013", "2014", "2015", "2016", "2017", "2018", "2019", "2020", "2021", "2022"))

## Transforming the Jaccard's dissimilarity matrix into a data frame and renaming the automatically created column names, so now the columns include "Year1": the first year being compared, "Year2": the year that is being compared to Var1, and "Jacc_diss": the Jaccard's dissimilarity value.
plants_jaccdiss_4A_df <- as.data.frame.table(as.matrix(plants_jaccdiss_4A))%>%
  rename("Year1" = "Var1",
         "Year2" = "Var2" ,
         "Jacc_diss" = "Freq")

## Subsetting "1992", meaning the remaining values will be the Jaccard's dissimilarity compared to the baseline year 
plants_jaccdiss_4A_df <- 
  plants_jaccdiss_4A_df %>% 
  subset(Year1 == "1992") %>% 
  mutate(Year2 = as.numeric(Year2))
  

## Creating a plot to show how dissimilarity in species presence compared to the baseline year for watershed 4F in the small mammals dataset
plants_jaccdiss_4A_plot <- 
  plants_jaccdiss_4A_df[-(1), ] %>% 
  ggplot(aes(x = Year2, y = Jacc_diss)) + 
  geom_point(alpha = 0.5, size = 4, color = "#4A148C") +
  geom_smooth(method = "lm") +
  ggpubr::stat_cor() +
  theme_bw() +
  geom_label(label="4A", 
    x=30,
    y=1.00,
    label.padding = unit(0.55, "lines"), # Rectangle size around label
    label.size = 0.6,
    color = "white",
    fill="#4A148C") +
    ylim(0, 1) + 
  labs(y = "Jaccard's Dissimilarity", x = "Year from Baseline")




## FOR WATERSHED 4B

## Subsetting watershed "4B", the summarizing data based on the counts of species per year. Pivoting the output into a wide format so that each row is a species name and each column is a year from 1992 to 2022, and the values are the species counts per year.
plants_jaccdiss_4B <- plants1 %>% 
  subset(Watershed_name == "4B") 

## Reordering the Recyear column since it is out of numerical order for some reason
plants_jaccdiss_4B$Recyear <- str_sort(plants_jaccdiss_4B$Recyear, numeric = TRUE)



## Transforming the species counts to just presence/absence values, removing the species names column from the matrix for the dissimilarity test, then running a Jaccard's dissimilarity test on the differences between years.
plants_jaccdiss_4B <- 
  plants_jaccdiss_4B[, -c(1:2)] %>% 
  decostand(method = "pa") %>% 
  vegdist(method = "jaccard")

## Having the Jaccard's dissimilarity output be coded and saved as a matrix
plants_jaccdiss_4B <- as.matrix(plants_jaccdiss_4B)

## Taking that matrix and adding in dimension names (the years of the data) to make the matrix readable.
dimnames(plants_jaccdiss_4B) <- list(c("1992", "1993", "1994", "1995", "1996", "1997", "1998", "1999", "2000", "2001", "2002", "2003", "2004", "2005", "2006", "2007", "2008", "2009", "2010", "2011", "2012", "2013", "2014", "2015", "2016", "2017", "2018", "2019", "2020", "2021", "2022"), 
                                       c("1992", "1993", "1994", "1995", "1996", "1997", "1998", "1999", "2000", "2001", "2002", "2003", "2004", "2005", "2006", "2007", "2008", "2009", "2010", "2011", "2012", "2013", "2014", "2015", "2016", "2017", "2018", "2019", "2020", "2021", "2022"))

## Transforming the Jaccard's dissimilarity matrix into a data frame and renaming the automatically created column names, so now the columns include "Year1": the first year being compared, "Year2": the year that is being compared to Var1, and "Jacc_diss": the Jaccard's dissimilarity value.
plants_jaccdiss_4B_df <- as.data.frame.table(as.matrix(plants_jaccdiss_4B))%>%
  rename("Year1" = "Var1",
         "Year2" = "Var2" ,
         "Jacc_diss" = "Freq")

## Subsetting "1992", meaning the remaining values will be the Jaccard's dissimilarity compared to the baseline year 
plants_jaccdiss_4B_df <- 
  plants_jaccdiss_4B_df %>% 
  subset(Year1 == "1992") %>% 
  mutate(Year2 = as.numeric(Year2))
  

## Creating a plot to show how dissimilarity in species presence compared to the baseline year for watershed 4B in the small mammals dataset
plants_jaccdiss_4B_plot <- 
  plants_jaccdiss_4B_df[-(1), ] %>% 
  ggplot(aes(x = Year2, y = Jacc_diss)) + 
  #geom_smooth(method = "lm") +
  ggpubr::stat_cor() +
  geom_point() + #alpha = 0.5, size = 4, color = "#311B92") +
  theme_bw() +
  geom_label(label="4B", 
    x=30,
    y=1.00,
    label.padding = unit(0.55, "lines"), # Rectangle size around label
    label.size = 0.6,
    color = "white", fill="black") +
    ylim(0, 1) + 
  labs(y = "", x = "")




#FOR WATERSHED N4A

## Subsetting watershed "N4A", the summarizing data based on the counts of species per year. Pivoting the output into a wide format so that each row is a species name and each column is a year from 1992 to 2022, and the values are the species counts per year.. 
plants_jaccdiss_N4A <- plants1 %>% 
  subset(Watershed_name == "N4A")

## Reordering the Recyear column since it is out of numerical order for some reason
plants_jaccdiss_N4A$Recyear <- str_sort(plants_jaccdiss_N4A$Recyear, numeric = TRUE)


## Transforming the species counts to just presence/absence values, removing the species names column from the matrix for the dissimilarity test, then running a Jaccard's dissimilarity test on the differences between years.
plants_jaccdiss_N4A <- 
  plants_jaccdiss_N4A[, -c(1:2)] %>% 
  decostand(method = "pa") %>% 
  vegdist(method = "jaccard")

## Having the Jaccard's dissimilarity output be coded and saved as a matrix
plants_jaccdiss_N4A<- as.matrix(plants_jaccdiss_N4A)
## Taking that matrix and adding in dimension names (the years of the data) to make the matrix readable.
dimnames(plants_jaccdiss_N4A) <- list(c("1992", "1993", "1994", "1995", "1996", "1997", "1998", "1999", "2000", "2001", "2002", "2003", "2004", "2005", "2006", "2007", "2008", "2009", "2010", "2011", "2012", "2013", "2014", "2015", "2016", "2017", "2018", "2019", "2020", "2021", "2022"), 
                                       c("1992", "1993", "1994", "1995", "1996", "1997", "1998", "1999", "2000", "2001", "2002", "2003", "2004", "2005", "2006", "2007", "2008", "2009", "2010", "2011", "2012", "2013", "2014", "2015", "2016", "2017", "2018", "2019", "2020", "2021", "2022"))

## Transforming the Jaccard's dissimilarity matrix into a data frame and renaming the automatically created column names, so now the columns include "Year1": the first year being compared, "Year2": the year that is being compared to Var1, and "Jacc_diss": the Jaccard's dissimilarity value.
plants_jaccdiss_N4A_df <- as.data.frame.table(as.matrix(plants_jaccdiss_N4A)) %>%
  rename("Year1" = "Var1",
         "Year2" = "Var2" ,
         "Jacc_diss" = "Freq")

## Subsetting "1992", meaning the remaining values will be the Jaccard's dissimilarity compared to the baseline year 
plants_jaccdiss_N4A_df <- plants_jaccdiss_N4A_df %>% 
  subset(Year1 == "1992") %>% 
  mutate(Year2 = as.numeric(Year2))

## Creating a plot to show how dissimilarity in species presence compared to the baseline year for watershed N4A in the small mammals dataset
plants_jaccdiss_N4A_plot <- 
  plants_jaccdiss_N4A_df[-(1), ] %>% 
  ggplot(aes(x = Year2, y = Jacc_diss)) + 
  geom_smooth(method = "lm") +
  ggpubr::stat_cor() +
  geom_point(alpha = 0.5, size = 4, color="#0D47A1") +
  theme_bw() +
  geom_label(label="N4A", 
    x=30,
    y=1.00,
    label.padding = unit(0.55, "lines"), # Rectangle size around label
    label.size = 0.6,
    color = "white",
    fill="#0D47A1") +
  ylim(0, 1) +
  labs(y = "", x = "Year from Baseline")




#FOR WATERSHED N4D

## Subsetting watershed "N4D", the summarizing data based on the counts of species per year. Pivoting the output into a wide format so that each row is a species name and each column is a year from 1992 to 2022, and the values are the species counts per year.
plants_jaccdiss_N4D <- plants1 %>% 
  subset(Watershed_name == "N4D")

## Reordering the Recyear column since it is out of numerical order for some reason
plants_jaccdiss_N4D$Recyear <- str_sort(plants_jaccdiss_N4D$Recyear, numeric = TRUE)


## Transforming the species counts to just presence/absence values, removing the species names column from the matrix for the dissimilarity test, then running a Jaccard's dissimilarity test on the differences between years.
plants_jaccdiss_N4D <- 
  plants_jaccdiss_N4D[, -c(1:2)] %>% 
  decostand(method = "pa") %>% 
  vegdist(method = "jaccard")

## Having the Jaccard's dissimilarity output be coded and saved as a matrix
plants_jaccdiss_N4D<- as.matrix(plants_jaccdiss_N4D)
## Taking that matrix and adding in dimension names (the years of the data) to make the matrix readable.
dimnames(plants_jaccdiss_N4D) <- list(c("1992", "1993", "1994", "1995", "1996", "1997", "1998", "1999", "2000", "2001", "2002", "2003", "2004", "2005", "2006", "2007", "2008", "2009", "2010", "2011", "2012", "2013", "2014", "2015", "2016", "2017", "2018", "2019", "2020", "2021", "2022"), 
                                       c("1992", "1993", "1994", "1995", "1996", "1997", "1998", "1999", "2000", "2001", "2002", "2003", "2004", "2005", "2006", "2007", "2008", "2009", "2010", "2011", "2012", "2013", "2014", "2015", "2016", "2017", "2018", "2019", "2020", "2021", "2022"))

## Transforming the Jaccard's dissimilarity matrix into a data frame and renaming the automatically created column names, so now the columns include "Year1": the first year being compared, "Year2": the year that is being compared to Var1, and "Jacc_diss": the Jaccard's dissimilarity value.
plants_jaccdiss_N4D_df <- as.data.frame.table(as.matrix(plants_jaccdiss_N4D)) %>%
  rename("Year1" = "Var1",
         "Year2" = "Var2" ,
         "Jacc_diss" = "Freq")

## Subsetting "1992", meaning the remaining values will be the Jaccard's dissimilarity compared to the baseline year 
plants_jaccdiss_N4D_df <- plants_jaccdiss_N4D_df %>% 
  subset(Year1 == "1992") %>% 
  mutate(Year2 = as.numeric(Year2))

## Creating a plot to show how dissimilarity in species presence compared to the baseline year for watershed N4D in the small mammals dataset
plants_jaccdiss_N4D_plot <- 
  plants_jaccdiss_N4D_df[-(1), ] %>% 
  ggplot(aes(x = Year2, y = Jacc_diss)) + 
  geom_point() + #alpha = 0.5, size = 4, color="#006064") +
  #geom_smooth(method = "lm") +
  ggpubr::stat_cor() +
  theme_bw() +
  geom_label(label="N4D", 
    x=30,
    y=1.00,
    label.padding = unit(0.55, "lines"), # Rectangle size around label
    label.size = 0.6,
    color = "white", fill="black") +
  ylim(0, 1) +
  labs(y = "", x = "Year from Baseline")




# FOR 20B

## Subsetting watershed "20B", the summarizing data based on the counts of species per year. Pivoting the output into a wide format so that each row is a species name and each column is a year from 1992 to 2022, and the values are the species counts per year.. 
plants_jaccdiss_20B <- plants1 %>% 
  subset(Watershed_name == "20B")

## Reordering the Recyear column since it is out of numerical order for some reason
plants_jaccdiss_20B$Recyear <- str_sort(plants_jaccdiss_20B$Recyear, numeric = TRUE)


## Transforming the species counts to just presence/absence values, removing the species names column from the matrix for the dissimilarity test, then running a Jaccard's dissimilarity test on the differences between years.
plants_jaccdiss_20B <- 
  plants_jaccdiss_20B[, -c(1:2)] %>% 
  decostand(method = "pa") %>% 
  vegdist(method = "jaccard")

## Having the Jaccard's dissimilarity output be coded and saved as a matrix
plants_jaccdiss_20B<- as.matrix(plants_jaccdiss_20B)
## Taking that matrix and adding in dimension names (the years of the data) to make the matrix readable.
dimnames(plants_jaccdiss_20B) <- list(c("1992", "1993", "1994", "1995", "1996", "1997", "1998", "1999", "2000", "2001", "2002", "2003", "2004", "2005", "2006", "2007", "2008", "2009", "2010", "2011", "2012", "2013", "2014", "2015", "2016", "2017", "2018", "2019", "2020", "2021", "2022"), 
                                       c("1992", "1993", "1994", "1995", "1996", "1997", "1998", "1999", "2000", "2001", "2002", "2003", "2004", "2005", "2006", "2007", "2008", "2009", "2010", "2011", "2012", "2013", "2014", "2015", "2016", "2017", "2018", "2019", "2020", "2021", "2022"))

## Transforming the Jaccard's dissimilarity matrix into a data frame, so now the columns include "Var1": the first year being compared, "Var2": the year that is being compared to Var1, and "Freq": the Jaccard's dissimilarity value.
plants_jaccdiss_20B_df <- as.data.frame.table(as.matrix(plants_jaccdiss_20B)) %>%
  rename("Year1" = "Var1",
         "Year2" = "Var2" ,
         "Jacc_diss" = "Freq")

## Subsetting "1992", meaning the remaining values will be the Jaccard's dissimilarity compared to the baseline year 
plants_jaccdiss_20B_df <- plants_jaccdiss_20B_df %>% 
  subset(Year1 == "1992") %>% 
  mutate(Year2 = as.numeric(Year2))
  
  
## Creating a plot to show how dissimilarity in species presence compared to the baseline year for watershed 20B in the small mammals dataset
plants_jaccdiss_20B_plot <- 
  plants_jaccdiss_20B_df[-(1), ] %>% 
  ggplot(aes(x = Year2, y = Jacc_diss)) + 
  geom_smooth(method = "lm") +
  ggpubr::stat_cor() +
  geom_point() + #alpha = 0.5, size = 4, color="#004D40") +
  theme_bw() +
  geom_label(label="20B", 
    x=30,
    y=1.00,
    label.padding = unit(0.55, "lines"), # Rectangle size around label
    label.size = 0.6,
    color = "white", fill="black") +
  ylim(0, 1) +
  labs(y = "", x = "")




# FOR N20B

## Subsetting watershed "N20B", the summarizing data based on the counts of species per year. Pivoting the output into a wide format so that each row is a species name and each column is a year from 1992 to 2022, and the values are the species counts per year. 
plants_jaccdiss_N20B <- plants1 %>% 
  subset(Watershed_name == "N20B")

## Reordering the Recyear column sinces it is out of numerical order for some reason
plants_jaccdiss_N20B$Recyear <- str_sort(plants_jaccdiss_N20B$Recyear, numeric = TRUE)


## Transforming the species counts to just presence/absence values, removing the species names column from the matrix for the dissimilarity test, then running a Jaccard's dissimilarity test on the differences between years.
plants_jaccdiss_N20B <- 
  plants_jaccdiss_N20B[, -c(1:2)] %>% 
  decostand(method = "pa") %>% 
  vegdist(method = "jaccard")

## Having the Jaccard's dissimilarity output be coded and saved as a matrix
plants_jaccdiss_N20B<- as.matrix(plants_jaccdiss_N20B)
## Taking that matrix and adding in dimension names (the years of the data) to make the matrix readable.
dimnames(plants_jaccdiss_N20B) <- list(c("1992", "1993", "1994", "1995", "1996", "1997", "1998", "1999", "2000", "2001", "2002", "2003", "2004", "2005", "2006", "2007", "2008", "2009", "2010", "2011", "2012", "2013", "2014", "2015", "2016", "2017", "2018", "2019", "2020", "2021", "2022"), 
                                       c("1992", "1993", "1994", "1995", "1996", "1997", "1998", "1999", "2000", "2001", "2002", "2003", "2004", "2005", "2006", "2007", "2008", "2009", "2010", "2011", "2012", "2013", "2014", "2015", "2016", "2017", "2018", "2019", "2020", "2021", "2022"))

## Transforming the Jaccard's dissimilarity matrix into a data frame, so now the columns include "Var1": the first year being compared, "Var2": the year that is being compared to Var1, and "Freq": the Jaccard's dissimilarity value.
plants_jaccdiss_N20B_df <- as.data.frame.table(as.matrix(plants_jaccdiss_N20B)) %>%
  rename("Year1" = "Var1",
         "Year2" = "Var2" ,
         "Jacc_diss" = "Freq")

## Subsetting "1992", meaning the remaining values will be the Jaccard's dissimilarity compared to the baseline year 
plants_jaccdiss_N20B_df <- plants_jaccdiss_N20B_df %>% 
  subset(Year1 == "1992") %>% 
  mutate(Year2 = as.numeric(Year2))
  
  
## Creating a plot to show how dissimilarity in species presence compared to the baseline year for watershed 20B in the small mammals dataset
plants_jaccdiss_N20B_plot <- 
  plants_jaccdiss_N20B_df[-(1), ] %>% 
  ggplot(aes(x = Year2, y = Jacc_diss)) + 
  geom_point() +#alpha = 0.5) + #, size = 4), color="#1B5E20") +
  geom_smooth(method = "lm") +
  ggpubr::stat_cor() +
  theme_bw() +
  geom_label(label="N20B", 
    x=30,
    y=1.00,
    label.padding = unit(0.55, "lines"), # Rectangle size around label
    label.size = 0.6,
    color = "white", fill="black") +
  ylim(0, 1) +
  labs(y = "", x = "Year from Baseline")


# plants_jaccdiss_1D_plot
# plants_jaccdiss_N1B_plot
# plants_jaccdiss_4A_plot
# plants_jaccdiss_4B_plot
# plants_jaccdiss_N4A_plot
# plants_jaccdiss_N4D_plot
# plants_jaccdiss_20B_plot
# plants_jaccdiss_N20B_plot


#Putting all the plots together
plot_grid(
  plants_jaccdiss_1D_plot, 
  #plants_jaccdiss_4A_plot, #not included for other taxa
  plants_jaccdiss_4B_plot,
  plants_jaccdiss_20B_plot, 
  plants_jaccdiss_N1B_plot,
  #plants_jaccdiss_N4A_plot, #not included for other taxa
  plants_jaccdiss_N4D_plot,
  plants_jaccdiss_N20B_plot,
nrow = 2,
ncol = 3
)

ggsave("Figures/plant_jaccard-diss_3xfire.png", dpi=300, width=10, height=6)
```

### Plants: Species Richness

```{r}
#Taking the table already created for the species presence/absence matrix, then adding in the year and watershed information back in, then pivoting the data into a long format.
plants_sprich <- decostand_plants_pa %>% 
  add_column(plants_env) %>% 
  pivot_longer(cols = "1992":"2022", 
               names_to = "Recyear", 
               values_to = "Presence")

#Mutating the 'Recyear' column into a numeric column, and the 'Watershed_name' column into a factor
plants_sprich <- plants_sprich %>% 
  mutate(Recyear = as.numeric(Recyear),
         Watershed_name = factor(Watershed_name))

#Summing the presences of each species at each watershed and year to get a number for species richness
plants_sprich <- plants_sprich %>% 
  group_by(Watershed_name, Recyear) %>% 
  reframe(Richness = sum(Presence))

#Pivoting the dataset 
plants_sprich_wide <- plants_sprich %>% 
  pivot_wider(names_from = "Recyear", 
              values_from = "Richness")

#Using 'purr' to run the model. The gather function get the values we need, and the group_by function makes sure the values are grouped by 'Watershed_name'. 'n' is the row number, which translates to the year (1992 = 1, 1993 = 2... 2022 = 31). The arrange function orders the data by 'Watershed_name' and row number. The nest function nests all the data (year/row number, and richness) into a single column, while each row is a watershed. The rest of the code runs the linear models for each row, and creates new columns with the outputs.
plants_sprich_values <- plants_sprich_wide %>%
  gather('year', 'value', -Watershed_name) %>%
  group_by(Watershed_name) %>%
  mutate(n = row_number()) %>%
  arrange(Watershed_name, n) %>%
  nest() %>%
  mutate(model = map(data, fit_model)) %>%
  mutate(slope = map_dbl(model, get_slope)) %>%
  mutate(p_value = map_dbl(model, get_p_value)) %>%
  mutate(rsquared = map_dbl(model, get_rsq))

#Selecting the columns with the relevant info I want to keep
plants_sprich_values_shortened <- plants_sprich_values %>% dplyr::select(Watershed_name, slope, p_value, rsquared)

#Combines the richness per year by watershed with the values of the model output (this is for ease of graphing later). This means the model output values by watershed('slope', 'p_value', and 'rsquared') will be repeated for each year.
plants_sprich_all <- left_join(plants_sprich, plants_sprich_values_shortened, by = "Watershed_name")

#Saving the data frame with the species richness outputs into the E1_output_data folder located in project directory 
write.csv(plants_sprich_all, "Datasets/E1_output_data/E1_plants/E1_plants_richness.csv")



plants_sprich$Watershed_name <- factor(plants_sprich$Watershed_name,
                                        levels = c("1D", "4A", "4B", "20B", "N1B", "N4A", "N4D", "N20B"))

plants_sprich %>% filter(Watershed_name %in% c("1D", "N1B", "4B", "N4D", "20B", "N20B")) %>% 
  ggplot(aes(x = Recyear, y = Richness)) + 
  geom_point() + facet_wrap(.~Watershed_name, nrow=2) + 
  geom_smooth(method = "lm", se = FALSE) + 
  theme_bw() +
  theme(text = element_text(size=10),
        axis.text.x = element_text(angle=45, hjust=1, size =10)) +
  labs(title = "Plant Species Richness per Year and Watershed") + 
  ggpubr::stat_cor()

ggsave("Figures/plant-richness-firex3.png", dpi=300, width=8, height=5.5)

```

### Plants: Calculating Summary Statistics

```{r}
#view(plants_classification)

plants_class.switch <- plants_classification %>%
  filter(Watershed_name %in% c("1D", "N1B", "4B", "N4D", "20B", "N20B")) %>% #KEEP this line in if you want to use just the 6 that are consistent with other taxa
  filter(classification != "No_change-absent") %>% #KEEP this line in to ignore cases where the species was absent
  group_by(Species, classification) %>%
  summarize(total_count=n(),.groups = 'drop')


#view(plants_class.switch)

plants_class.switch1 <- plants_classification %>% 
  group_by(Species) %>%
  summarize(count = n_distinct(classification))

plants_class.switch1 %>% ggplot(aes(x = count)) + 
  geom_histogram(binwidth = 0.5) + 
  theme_bw() +
  labs(title = "plants: Classification switches",
       x = "Number of Times a Species Switched Classifications",
       y = "Count of Species")

plants_class.switch2 <- plants_classification %>%
  group_by(Species, classification) %>%
  summarize(count = n_distinct(Watershed_name))

#view(plants_class.switch2)

plants_class.switch2_wide <- plants_class.switch2 %>% pivot_wider(names_from = classification, values_from = count)

view(plants_class.switch2_wide)


plants_class.switch3 <- plants_classification %>%
  group_by(Watershed_name, classification) %>%
  summarize(count = n_distinct(Species))

view(plants_class.switch3)

plants_class.switch3_wide <- plants_class.switch3 %>% pivot_wider(names_from = classification, values_from = count)

view(plants_class.switch3_wide)


```
