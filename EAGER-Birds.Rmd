---
title: "EAGER-Birds"
author: "Maya Parker-Smith"
date: "2023-05-01"
output: html_document
 smart: no
    theme: flatly
    float: yes
    css: "style.css"    
editor_options: 
  chunk_output_type: console
mainfont: Arial
mathfont: Arial
fontsize: 12pt
---

```{r setup, include=FALSE}
## Clear environment 
rm(list=ls())


##Libraries
library(tidyverse)
library(cowplot)
library(bbmle)
library(lmerTest)
library(car)
library(readxl)
library(multcomp)
library(readr)
library(incidence)
library(vegan)
library(goeveg)
library(randtests)
library(reshape2)
library(psych)


```



## Bird Sampling
This section is dedicated to cleaning the bird-sampling dataset. Data was collected from 1981 to 2009. Watersheds that are supposedly included: N4B, N4D, 4A, N1B, 1D, R20A, R1B, 20C, 20B, N20B. Censuses are conducted two times during the year: during the first two weeks of January as
a measure of wintering populations, and during the first two weeks of June as a measure of
breeding populations.

Author: Alice Boyle

ZIP file: knb-lter-knz.26.12

Data code: CBP01

File(s): CBP011.csv

Summary of All Changes Up to 1993: 
1981: Transects were as presently located except no transect in N20B and there were transects in  N20C (now N01A), N20D (now part of N01B), N01C (now N02B), N01D (now part of N01B), and N04C (now N04B). 
1982: Transects in N20C (N01A) and N01C (N02B) were dropped, N20D was maintained in what is now N01B. N01D became the second transect in what is now N01B, and N04C transect was maintained in what is now N04B. N20B was added. 
1990: 004d became SA and transect was dropped.


```{r}
#Read in and view bird data
birds_raw <- read_csv("Datasets_EAGER/Birds/knb-lter-knz.26.12/CBP011.csv")
watershed_info <- read_excel("Datasets_EAGER/Other/Watershed Info.xlsx")
View(birds_raw)

uni
unique(birds_raw$SPECNAME)
unique(birds_raw$AOUCODE)
unique(birds_raw$WATERSHED)

#Changing classifications and names of columns
birds <- birds_raw %>% mutate(RECMONTH = factor(RECMONTH),
                          RECDAY = factor(RECDAY),
                          SEASON = factor(SEASON),
                          TRANSNUM = factor(TRANSNUM),
                          WATERSHED = factor(WATERSHED),
                          SPECNAME = factor(SPECNAME),
                          AOUCODE = factor(AOUCODE),
                          COMMONNAME = factor(COMMONNAME),
                          DISTANCE = as.numeric(DISTANCE),
                          COUNT = as.numeric(COUNT),
                          SEX = factor(SEX),
                          STATUS = factor(STATUS),
                          COMMENTS = as.character(COMMENTS))


birds <- birds %>% rename("Watershed_name" = "WATERSHED",
                          "Datacode" = "DATACODE",
                          "Recyear" = "RECYEAR",
                          "Recmonth" = "RECMONTH",
                          "Recday" = "RECDAY",
                          "Season" = "SEASON",
                          "Transect" = "TRANSNUM",
                          "Observation_number" = "OBSNUM",
                          "Species" = "SPECNAME",
                          "AOU_code" = "AOUCODE",
                          "Common_name" = "COMMONNAME",
                          "Distance" = "DISTANCE",
                          "Count" = "COUNT",
                          "Sex" = "SEX",
                          "Status" = "STATUS",
                          "Comments" = "COMMENTS",
                          "Time" = "TIME",
                          "Duration" = "DURATION",
                          "Observer" = "OBSERVER")


unique(birds$Watershed_name)

birds$Watershed_name <- dplyr::recode(birds$Watershed_name,
                                       "N04D" = "N4D",
                                       "N04B" = "N4B",
                                       "004B" = "4B",
                                       "004A" = "4A",
                                       "004D" = "4D",
                                       "N01B" = "N1B",
                                       "001D" = "1D",
                                       "R20A" = "R20A",
                                       "R01B" = "R1B",
                                       "020C" = "20C",
                                       "020B" = "20B",
                                       "L00A" = "LA",
                                       "S00A" = "SA",
                                       "G00A" = "GA",
                                       "N20B" = "N20B")


length(unique(birds2$Species))

#Joining the watershed_info dataset with the actual birds dataset
birds1 <- left_join(birds, watershed_info, by = "Watershed_name")

birds1 <- birds1 %>% mutate(Fire_interval = factor(Fire_interval),
                                                    Burn_season = factor(Burn_season),
                                                    Grazing = factor(Grazing),
                                                    Watershed_name = factor(Watershed_name))


#Changing the order of the fire_interval and grazing treatments for graphing reasons later on
birds1$Fire_interval <- factor(birds1$Fire_interval, 
                               levels = c("1_year", "4_years", "20_years"))

birds1$Grazing <- factor(birds1$Grazing,
                         levels = c("Ungrazed", "Bison"))


#I need to separate the dataset from 1992 onwards. 
birds2 <- birds1 %>% subset(.$Recyear >= 1992)
birds2 <- birds2 %>% mutate(Recyear = factor(Recyear))


#Removing watersheds and transects I won't use for further analysis
birds3 <- birds2 %>%
  subset(Watershed_name %in% c("N4D", "N4B",
                               "4B", "4A", "N1B", 
                               "1D", "20C", "20B", "N20B")) 

birds3 <-  birds3 %>% subset(Transect != "10")

#Also removing observations that are just "none"
birds3 <-  birds3 %>% subset(Species != "NONE")

length(unique(birds3$Species))
length(unique(birds3$AOU_code))

```


```{r}

#Selecting the columns I want for further analysis ##NOTE: I am using the species, not the AOU code -- need to confirm with Sarah that this is okay
birds3_short <- birds3 %>% group_by(Recyear, Fire_interval, Grazing, Species) %>% 
  reframe(Count = sum(Count))

length(unique(birds3$AOUcode))


#Pivoting the the dataset wider, so that each species is its own column
birds_wide <- birds3_short %>% 
  pivot_wider(names_from = "Species", values_from = "Count", 
              values_fn = function(x) paste(sum(x)))


#Making an environment table to add back onto the presence/absence data later
birds_env <- birds_wide[, 1:3]


#Standardizing by presence/absence
decostand_pa_birds <- decostand(birds_wide[, -c(1:3)], "pa", na.rm = FALSE)
decostand_pa_birds[is.na(decostand_pa_birds)] <- 0

#adding the presence/absence dataset back with the enviornment dataset
birds_wide2 <- decostand_pa_birds %>% add_column(birds_env, .before = "BHCB")





#Pivoting the presence/absence back to a longer format

birds_long <- birds_wide2 %>% pivot_longer(cols = 4:133,
                                           names_to = "Species",
                                           values_to = "Presence")

birds_long <- birds_long %>% mutate(Species = factor(Species))

```


```{r}

#Using the wide dataset to calculate species incidence?
birds_years_wide <- birds_long %>% pivot_wider(names_from = "Recyear", values_from = "Presence")

birds_years_wide <- birds_years_wide %>% mutate(Total_Persistence = 
                                                  rowSums(birds_years_wide[, 4:21]))
view(birds_years_wide)
birds_years_wide <- birds_years_wide %>% mutate(Persistence = (Total_Persistence/18))




birds_long3 <- pivot_longer(birds_years_wide, cols = 4:21,
                     names_to = "Recyear",
                     values_to = "Presence")

birds_long3 %>% ggplot(aes(x = Recyear, y = factor(Presence), fill = factor(Presence))) + 
  geom_tile() + 
  facet_grid(Species~Grazing~Fire_interval) +
  theme(text = element_text(size=10),
        axis.text.x = element_text(angle=45, hjust=1, size =7),
        axis.text.y = element_text(size=7),
        strip.text.y.left = element_text(angle = 0)) +
  scale_fill_manual(values = c("white", "black")) 

 birds_long3 %>%  ggplot(aes(Recyear, factor(Presence), fill = factor(Presence))) +
  geom_tile(color = "gray30") +
   facet_grid(Species~Grazing~Fire_interval, switch = "y") +
   theme(text = element_text(size=7),
        axis.text.x = element_text(angle=45, hjust=1, size =7),
        axis.text.y = element_text(size=7),
        strip.text.y.left = element_text(angle = 0)) +
   coord_equal() +
  scale_fill_manual(values = c("white", "black"), guide = "none") +
  theme_minimal(base_size = 16)


```

```{r}

birds_cont <- birds_long 
birds_cont <- birds_cont %>% mutate(Presence_cont = NA,
                                    Early_late = NA,
                                    Presence = factor(Presence))




 for(j in 1:nrow(birds_cont)){
   if (birds_cont[j,5] == "1"){birds_cont[j,6] <- "Present"}
   if (birds_cont[j,5] == "0"){birds_cont[j,6] <- "Absent"}
 } 

for(i in 1:nrow(birds_cont)){
   if (birds_cont[i,1] == "1992"){birds_cont[i,7] <- "Early"}
   if (birds_cont[i,1] == "1993"){birds_cont[i,7] <- "Early"}
   if (birds_cont[i,1] == "1994"){birds_cont[i,7] <- "Early"}
   if (birds_cont[i,1] == "1995"){birds_cont[i,7] <- "Early"}
   if (birds_cont[i,1] == "1996"){birds_cont[i,7] <- "Early"}
   if (birds_cont[i,1] == "1997"){birds_cont[i,7] <- "Early"}
   if (birds_cont[i,1] == "1998"){birds_cont[i,7] <- "Early"}
   if (birds_cont[i,1] == "1999"){birds_cont[i,7] <- "Early"}
   if (birds_cont[i,1] == "2000"){birds_cont[i,7] <- "Early"}
   if (birds_cont[i,1] == "2001"){birds_cont[i,7] <- "Late"}
   if (birds_cont[i,1] == "2002"){birds_cont[i,7] <- "Late"}
   if (birds_cont[i,1] == "2003"){birds_cont[i,7] <- "Late"}
   if (birds_cont[i,1] == "2004"){birds_cont[i,7] <- "Late"}
   if (birds_cont[i,1] == "2005"){birds_cont[i,7] <- "Late"}
   if (birds_cont[i,1] == "2006"){birds_cont[i,7] <- "Late"}
   if (birds_cont[i,1] == "2007"){birds_cont[i,7] <- "Late"}
   if (birds_cont[i,1] == "2008"){birds_cont[i,7] <- "Late"}
   if (birds_cont[i,1] == "2009"){birds_cont[i,7] <- "Late"}
}





birds_cont <- birds_cont %>% mutate(Presence_cont = factor(Presence_cont),
                                                  Early_late = factor(Early_late))

summary_tbl2 <- birds_cont %>%
  group_by(Species, Fire_interval, Grazing)%>%
    dplyr::count(Presence_cont, Early_late)


summary_tbl2 <- summary_tbl2 %>% unite("Species_fire", Species:Fire_interval, sep = "_") %>% unite("Species_fire.grazing", Species_fire:Grazing, sep = ".")
summary_tbl2 <- summary_tbl2 %>% mutate(Species_fire.grazing = factor(Species_fire.grazing))

contabs <- xtabs(n ~ Presence_cont + Early_late + Species_fire.grazing, summary_tbl2)
chisqtests <- apply(contabs, 3, chisq.test)

chisq_p.values <- tibble(names(chisqtests), do.call(rbind,lapply(chisqtests,function(v){v$p.value})))
chisq_p.values$row_names <- row.names(chisq_p.values)

chisq_p.values <- chisq_p.values %>% rename("chisq_p.values" = "do.call(...)",
                                            "Species_fire.grazing" = "names(chisqtests)")




birds_long4 <- birds_long %>% 
  group_by(Recyear, Species, Fire_interval, Grazing) %>% reframe(Presence = Presence) %>%
  unite("Species_fire", Species:Fire_interval, sep = "_") %>% unite("Species_fire.grazing", Species_fire:Grazing, sep = ".")

grouped4 <- birds_long4 %>% group_by(Recyear, Species_fire.grazing) %>% reframe(Presence = Presence)


presence.tabs <- xtabs(Presence ~ Recyear + Species_fire.grazing, birds_long4)
runstests <- apply(presence.tabs, 2, runs.test)
runstest_p.values <- tibble(names(runstests), do.call(rbind,lapply(runstests,function(v){v$p.value})))
runstest_p.values <- runstest_p.values %>% rename("runstest_p.values" = "do.call(...)",
                                                  "Species_fire.grazing" = "names(runstests)")


birds_long2 <- birds_wide %>% pivot_longer(cols = 4:133,
                                           names_to = "Species",
                                           values_to = "Abundance")

birds_years_wide2 <- birds_long2 %>% pivot_wider(names_from = "Recyear", values_from = "Abundance")


birds_years_wide2 <- birds_years_wide2 %>% 
  unite("Species_fire", Species:Fire_interval, sep = "_") %>% 
  unite("Species_fire.grazing", Species_fire:Grazing, sep = ".")


birds_years_wide2 <- birds_years_wide2 %>% 
  mutate_if(is.character, ~as.numeric(as.character(.)))
birds_years_wide2[,4:21] <- as.numeric(birds_years_wide2[,4:21])

birds_years_wide2[is.na(birds_years_wide2)] <- 0

slope  <-  function(x){
    if(all(is.na(x)))
        # if x is all missing, then lm will throw an error that we want to avoid
        return(NA)
    else
        return(coef(lm~x))
}

slopes <- 
    apply(birds_years_wide2[,4:21],
          1,
          slope)

slopes_coefs <- tibble(names(runstests), do.call(rbind,lapply(runstests,function(v){v$p.value})))


merged_p.values <- merge(chisq_p.values,runstest_p.values, by = "Species_fire.grazing", all = TRUE)






```


```{r}

merged_p.values2 <- merged_p.values %>% mutate(Incidence_change = NA,
                                          Sequential_patterns = NA)

for (k in 1:nrow(merged_p.values2)){
  if (is.nan(merged_p.values2$chisq_p.values[k])) {merged_p.values2$chisq_p.values[k] <- 2}
  if (is.nan(merged_p.values2$runstest_p.values[k])) {merged_p.values2$runstest_p.values[k] <- 2}
}

merged_p.values3 <- merged_p.values2

for (kk in 1:nrow(merged_p.values3)){
  if (merged_p.values3[kk, 2] == 2){merged_p.values3[kk, 4] <- "-"}
  if (merged_p.values3[kk, 2] <= 0.05){merged_p.values3[kk, 4] <- "Significant"}
  if (merged_p.values3[kk, 2] > 0.05 & merged_p.values3[kk, 2] < 2){merged_p.values3[kk, 4] <- "NS"}
  if (merged_p.values3[kk, 3] == 2){merged_p.values3[kk, 5] <- "-"}
  if (merged_p.values3[kk, 3] <= 0.05){merged_p.values3[kk, 5] <- "Significant"}
  if (merged_p.values3[kk, 3] > 0.05 & merged_p.values3[kk, 3] < 2){merged_p.values3[kk, 5] <- "NS"}
}


class_values4 <-class_values4 %>% mutate(Classification = NA)

for (jj in 1:nrow(class_values4)){
  if (class_values4[jj, 7] == "-" & class_values4[jj, 8] == "-"){class_values4[jj, 9] <- "No_change"}
  if (class_values4[jj, 7] == "NS" & class_values4[jj, 8] == "NS"){class_values4[jj, 9] <- "Random"}
  if (class_values4[jj, 7] == "NS" & class_values4[jj, 8] == "Significant"){class_values4[jj, 9] <- "Recurrent"}
  if (class_values4[jj, 7] == "Significant" & class_values4[jj, 8] == "-"){class_values4[jj, 9] <- "Increasing"}
  if (class_values4[jj, 7] == "NS" & class_values4[jj, 8] == "-"){class_values4[jj, 9] <- "Random"}
}
  
for (ii in 1:nrow(class_values4)){
  if (class_values4[ii, 5] == 2) {class_values4$chisq_p.values[ii] <- NA}
  if (class_values4[ii, 6] == 2) {class_values4$runstest_p.values[ii] <- NA}
}



```



