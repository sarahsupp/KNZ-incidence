---
title: "EAGER-Plants"
author: "Maya Parker-Smith"
date: "2023-05-15"
output: html_document
 smart: no
    theme: flatly
    float: yes
    css: "style.css"    
editor_options: 
  chunk_output_type: console
mainfont: Arial
mathfont: Arial
fontsize: 12pt
---

```{r setup, include=FALSE}
## Clear environment 
rm(list=ls())


##Libraries
library(tidyverse)
library(cowplot)
library(bbmle)
library(lmerTest)
library(car)
library(readxl)
library(multcomp)
library(readr)
library(incidence)
library(vegan)
library(goeveg)
library(randtests)
library(reshape2)
library(lubridate)

```

##Plant Species Composition
This section is dedicated to cleaning the plant species composition/cover dataset. Data was collected from 1983 to 2022. Watersheds that are included: FA, SuB, N4A, R1A, 2D, WB, N20B, 1D, N1A, R1B, SpA, SpB, WA, 20B, 4A, 4F, SuA, N1B, N20A, N4D.

Author: David Hartnett, Scott Collins, Zak Ratajczak

ZIP file: knb.lter.knz.69.21

Data code: PVC02

File(s): PVC021.csv
 Pasture c01b was called Texas Hog (thp) in 2009. 
Vegetation species composition from 1983: The transects were permanently laid out in the current format of 4 transects (A-D), each with 5 plots. 
Transect E only occurred on watershed N20B florence in 1986 and 1987. This transect is the same as the current transect D for this watershed and soil type. 
The old transect D was abandoned in 1987 prior to bison reintroduction. 
Seven cover classes were used to estimate species canopy coverage. 1 - 0-1% cover; 2 - 2-5% cover; 3 - 5-25% cover; 4 - 25-50% cover; 5 - 50-75%; 6 - 75-95% cover; 7 - 95-100% cover. (Note: for the watershed r20b, no data were collected in the transect A and B in the fall of 2011 due to wildfire occurred.) 
Transect 'E' occurred only on the N20b florence site in 1986 and 1987 and was renamed the new 'transect' in 1988. 
The old 'D' transect was sampled from 1983 to 1987 and then abandoned when the bison fence was constructed. 
Thus, plots d1-d5 from 1983-1987 are NOT the same d1-d5 plots in subsequent years.

```{r}

plantcomp_raw <- read_csv("Datasets_EAGER/Plants/knb-lter-knz.69.21_SpeciesComposition/PVC021.csv")

watershed_info <- read_excel("Datasets_EAGER/Other/Watershed Info.xlsx")

unique(plantcomp_raw$WaterShed)

plantcomp <- plantcomp_raw %>% mutate(RecType = factor(RecType),
                                        RecMonth = factor(RecMonth),
                                        RecDay = factor(RecDay),
                                        WaterShed = factor(WaterShed),
                                        SoilType = factor(SoilType),
                                        Transect = factor(Transect),
                                        Plot = factor(Plot),
                                        SpeCode = factor(SpeCode))

#Combining the genus and species column and creating a new column. 
plantcomp1 <- unite(plantcomp, "Genus_spp", AB_genus:AB_species, sep = "_", remove = FALSE)

unique(plantcomp1$WaterShed)


plantcomp1$WaterShed <- dplyr::recode(plantcomp1$WaterShed,
                                "001c" = "1C",
                                "001d" = "1D",
                                "004b" = "4B",
                                "020b" = "20B",
                                "n01b" = "N1B",
                                "n04d" = "N4D",
                                "n20b" = "N20B",
                                "002c" = "2C",
                                "002d" = "2D",
                                "004a" = "4A",
                                "004f" = "4F",
                                "n04a" = "N4A",
                                "n20a" = "N20A",
                                "020d" = "20D",
                                "n01a" = "N1A",
                                "00wb" = "WB",
                                "0spa" = "SpA",
                                "0spb" = "SpB",
                                "00fa" = "FA",
                                "00fb" = "FB",
                                "00wa" = "WA",
                                "0sua" = "SuA",
                                "0sub" = "SuB",
                                "001a" = "1A",
                                "020a" = "20A",
                                "r01a" = "R1A",
                                "r01b" = "R1B",
                                "r20a" = "R20A",
                                "r20b" = "R20B",
                                "n02a" = "N2A",
                                "n02b" = "N2B")

unique(plantcomp1$WaterShed)

plantcomp1 <- plantcomp1 %>% rename("Watershed_name" = "WaterShed",
                              "Recyear" = "RecYear",
                              "Recmonth" = "RecMonth",
                              "Recday" = "RecDay")


plantcomp2 <- plantcomp1
plantcomp2 <- plantcomp2 %>% subset(.$Recyear >= 1993)
plantcomp2 <- plantcomp2 %>% mutate(Recyear = factor(Recyear))


#Removing watersheds and transects I won't use for further analysis
plantcomp3 <- plantcomp2

plantcomp3 <- plantcomp3 %>%
  subset(Watershed_name %in% c("1A", "1C", "1D",
                              "4A", "4B", "4F",
                              "20A", "20B", "20D",
                              "N1A", "N1B",
                              "N4A", "N4D",
                              "N20A", "N20B")) 

plantcomp3 <- left_join(plantcomp3, watershed_info, by = "Watershed_name")
sort(unique(plantcomp3$Genus_spp))
length(unique(plantcomp3$SpeCode))


plantcomp4 <- subset(plantcomp4,!(Genus_spp %in% c("annual_forb", "carex_spp.", "cyperu_spp.", 
                                                   "euphor_spp.", "symphy_spp.")))


plantcomp4 <- plantcomp4 %>% unite("Month_Day", Recmonth:Recday, sep = "-")

plantcomp4 <- plantcomp4 %>% unite("Date", Recyear:Month_Day, sep = "-", remove = FALSE)

plantcomp4$Date <- ymd(plantcomp4$Date)
datecheck <- plantcomp4 %>% group_by(Date)%>% reframe(Cover = sum(Cover))

```


```{r}
#This section is for checking the sampling amounts for certain variables/parameters

plantcomp_group1 <- plantcomp3 %>% group_by(Recyear, Watershed_name, Genus_spp) %>% 
  reframe(Cover = sum(Cover))

plantcomp_wide1 <- plantcomp_group1 %>% pivot_wider(names_from = Genus_spp, values_from = Cover)

plantcomp_count1 <- plantcomp_wide1 %>% group_by(Watershed_name) %>% 
  summarise(total_count=n(),.groups = 'drop')


#After looking at the total number of times each watershed is sampled, I decided to cut watersheds 1A, 1C, 20A, 20D, 4F, N1A, and N20A. And keep watersheds 1D, 20B, 4A, 4B, N1B, N20B, N4A, and N4D

plantcomp4 <- plantcomp4 %>% subset(Watershed_name %in% c("1D", "20B", "4A", "4B", "N1A", "N1B", "N20A", "N20B", "N4A", "N4D"))

#Checking the months the watershed were sampled in
plantcomp_group2 <- plantcomp4 %>% group_by(Recyear, Recmonth, Watershed_name, Genus_spp) %>% 
  reframe(Cover = sum(Cover))

plantcomp_wide2 <- plantcomp_group2 %>% pivot_wider(names_from = Genus_spp, values_from = Cover)

plantcomp_count2 <- plantcomp_wide2 %>% group_by(Recyear, Watershed_name) %>% 
  summarise(total_count=n(),.groups = 'drop')


plantcomp_count2 %>% ggplot(aes(x = Recyear, y = total_count)) + 
  geom_point() + 
  facet_wrap(.~Watershed_name) + 
  theme(text = element_text(size=12),
        axis.text.x = element_text(angle=45, hjust=1, size =7))

plantcomp_count2 %>% ggplot(aes(x = Recyear, y = total_count, color = Recmonth)) + 
  geom_point(position = "stack") + 
  facet_wrap(.~Watershed_name) + 
  theme(text = element_text(size=12),
        axis.text.x = element_text(angle=45, hjust=1, size =7))


plantcomp_group3 <- plantcomp5 %>% group_by(Recyear, Recmonth, Watershed_name, Genus_spp) %>% 
  reframe(Cover = sum(Cover))

plantcomp_wide3 <- plantcomp_group3 %>% pivot_wider(names_from = Genus_spp, values_from = Cover)

plantcomp_count3 <- plantcomp_wide3 %>% group_by(Watershed_name) %>% 
  summarise(total_count=n(),.groups = 'drop')


```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.

```{r}

length(unique(plantcomp4$Genus_spp))
length(unique(plantcomp4$SpeCode))


spp_grouped <- plantcomp4 %>% group_by(SpeCode, AB_genus, AB_species, Genus_spp) %>% summarise(total_count=n(),.groups = 'drop')

spp_grouped1 <- spp_grouped[order(spp_grouped$Genus_spp),]

length(unique(spp_grouped$Genus_spp))

species_tbl <- plantcomp4 %>% dplyr::select(AB_genus, AB_species, Genus_spp)


```

```{r}
#Dissimilarity matrix for watersheds
plantcomp5 <- plantcomp4 %>% group_by(Watershed_name, Fire_interval, Grazing, Genus_spp) %>% 
  reframe(Cover = sum(Cover))

plantcomp5_wide <- plantcomp5 %>% 
  pivot_wider(names_from = "Genus_spp", values_from = "Cover", 
              values_fn = function(x) paste(sum(x)))

plantcomp5_wide_env <- plantcomp5_wide[, c(1:3)]
plantcomp5_wide1 <- plantcomp5_wide[, -c(1:3)]
plantcomp5_wide1 <- plantcomp5_wide1 %>% mutate_if(is.character, as.numeric)
plantcomp5_wide1[is.na(plantcomp5_wide1)] <- 0

diss_matrix <- vegdist(plantcomp5_wide1, method = "bray")

```


