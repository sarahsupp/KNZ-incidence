---
title: "EAGER_ALL"
author: "Maya Parker-Smith"
date: "2023-08-17"
output: 
  html_document:
    smart: no
    theme: flatly
    float: yes
    css: "style.css"    
editor_options: 
  chunk_output_type: console
mainfont: Arial
mathfont: Arial
fontsize: 12pt
---

#  {.tabset .tabset-pills .tabset-fade}

```{r setup, include=FALSE}
## Clear environment 
rm(list=ls())

##Libraries
library(tidyverse)
library(cowplot)
library(bbmle)
library(lmerTest)
library(car)
library(readxl)
library(multcomp)
library(readr)
library(incidence)
library(vegan)
library(goeveg)
library(randtests)

```

# NSF - EAGER: A novel investigation of population and community temporal trajectories leveraging experimental disturbances from the Konza Prairie Long-Term Ecological Research Network site {.tabset}

##Functions
This section is dedicated to the functions that will be applied to our datasets. 

###getTrends
The "getTrends" function will classify each taxa's species from each watershed into distinct categories, which include: 
- **"Always_absent"** <- though species was detected at other surrounding watersheds, it was never present at the specified watershed during the duration of the study
- **"Always_present"** <- species at watershed is present in every year in which data was collected
- **"Random"** <- species is detected sporadically for the duration of the study at watershed
- **"Recurrent"** <- species is detected in consecutive years and is followed by the absence of the species for a period of time, in a distinct pattern
- **"Increasing"** <- the presence of the species increases throughout the duration of the study (it isn't present during the beginning of the study, but appears towards the end of the study)
- **"Decreasing"** <- the presence of the species decreases throughout the duration of the study (it is  present during the beginning of the study, but then disappears towards the end of the study)

```{r getTrends}

x<- c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)

getTrends <- function(x) {
  #input (x) is a single row of a matrix where the species are rows and the columns are each year with 1/0 values (1=present, 0=absent). 
  #So you need to iterate each row separately to get the results
  # Output is a list with 6 items, that represents the classification results for a single species
  
  #create an object the same length as x that defines early vs late years
  time <- rep("late", length(x))
  time[1:(round(length(x)/2))] <- "early"
  
  # make a table that tells you how many 0s and 1s are in the early and the late halves of the time series
  z_x <- table(x,time)
  
  #find the time-series length (number of years)
  tslen <- length(x)

  # counts the number of years the species was present
  tssum <- sum(x)
 
  # create an empty vector to store results in for the next for loop
   l <- c()
  
  # identifies when a change from a 0 to a 1 or vice versa happens
  for(k in 1:(tslen-1)) {
    j <- x[k+1] - x[k]
    l <- c(l, j)
    v <- sum(abs(l))
  }
  
  
  # If all the values are 0, it is always absent
  if (tssum == 0) {
    p_val <- NA
    f_early <- NA
    f_late <- NA
    runsTestPV <- NA
    trend <- NA
    trendPlus <- NA
    cat <- "No_change-absent"
  }
  
  # if all the values are 1, it is always present
  else if (tslen == tssum) {
    p_val <- NA
    f_early <- NA
    f_late <- NA
    runsTestPV<-NA
    trend<-NA
    trendPlus<-NA
    cat<-"No_change-present"
  }
  
   #If the time series contains changes, then we do a chi-sq test to detect any directed change in the time series.
  else {
     
    #adds rownames to the z_x table
    rownames(z_x) <- c("absent","present")
    
    # get p value for the chi-squared test
    p_val <- chisq.test(z_x)$p.val
    
    # get early and late fractions
    # for each the early and the late parts of the time series:
    #    the number of years it was present divided by the number of years
    f_early <- z_x["present","early"] / sum(z_x[,1]) 
    f_late <- z_x["present","late"] / sum(z_x[,2])
   
    if((f_early > f_late) & (p_val <= 0.05)) {
      trend <- -1
      cat = "Decreasing"
    }
    
    if((f_early < f_late) & (p_val <= 0.05)) {
      trend <- 1
      cat = "Increasing"
    }
    
    # Chi-squared test not significant
    if(p_val > 0.05) trend <- 0
    
    #conduct a runs test on the time-series
    runsPV <- tseries::runs.test(as.factor(x), alternative = "less")
    runsTestPV <- runsPV$p.value
    if (is.nan(runsTestPV)) {
      runsTestPV <- 2}
    
    # if Chi-sq test insignif. and the runs test was significant
    if((p_val > 0.05) & (runsTestPV < 0.05)) {
      trendPlus<-10
      cat="Recurrent"
    }
    
    # if chi-sq insignif. and the runs test insignif.
    if((p_val > 0.05) & (runsTestPV > 0.05)){
      trendPlus<-5
      cat="Random"
    }
  }
  
  # for each species, record the summary statistics
  statSumm <- tibble("numyears" = tslen, "numpresent" = tssum, "chi_pval"=p_val, "chi_fearly" = f_early, "chi_flate" = f_late, "runs_pval"=runsTestPV, "numtransitions" = v, "trend"=trend, "category"= as.factor(cat))
  
  return(statSumm)
} 

```

### getTrends2.0
```{r getTrends2.0}
getTrends2.0 <- function(x) {
  #input (x) is a single row of a matrix where the species are rows and the columns are each year with 1/0 values (1=present, 0=absent). 
  #So you need to iterate each row separately to get the results
  # Output is a list with 6 items, that represents the classification results for a single species
  
  #create an object the same length as x that defines early vs late years
  time <- rep("late", length(x))
  time[1:(round(length(x)/2))] <- "early"
  
  # make a table that tells you how many 0s and 1s are in the early and the late halves of the time series
  z_x <- table(x,time)
  
  #find the time-series length (number of years)
  tslen <- length(x)

  # counts the number of years the species was present
  tssum <- sum(x)
 
  # create an empty vector to store results in for the next for loop
   l <- c()
  
  # identifies when a change from a 0 to a 1 or vice versa happens
  for(k in 1:(tslen-1)) {
    j <- x[k+1] - x[k]
    l <- c(l, j)
    v <- sum(abs(l))
  }
  
  
  # If all the values are 0, it is always absent
  if ((tssum-1==0)|tssum == 0) {
    p_val <- NA
    f_early <- NA
    f_late <- NA
    runsTestPV <- NA
    trend <- NA
    trendPlus <- NA
    cat <- "No_change-absent"
  }
  
  # if all the values are 1, it is always present
  else if ((tslen+1==tssum)|tslen==tssum) {
    p_val <- NA
    f_early <- NA
    f_late <- NA
    runsTestPV<-NA
    trend<-NA
    trendPlus<-NA
    cat<-"No_change-present"
  }
  
   #If the time series contains changes, then we do a chi-sq test to detect any directed change in the time series.
  else {
     
    #adds rownames to the z_x table
    rownames(z_x) <- c("absent","present")
    
    # get p value for the chi-squared test
    p_val <- chisq.test(z_x)$p.val
    
    # get early and late fractions
    # for each the early and the late parts of the time series:
    #    the number of years it was present divided by the number of years
    f_early <- z_x["present","early"] / sum(z_x[,1]) 
    f_late <- z_x["present","late"] / sum(z_x[,2])
   
    if((f_early > f_late) & (p_val <= 0.05)) {
      trend <- -1
      cat = "Decreasing"
    }
    
    if((f_early < f_late) & (p_val <= 0.05)) {
      trend <- 1
      cat = "Increasing"
    }
    
    # Chi-squared test not significant
    if(p_val > 0.05) trend <- 0
    
    #conduct a runs test on the time-series
    runsPV <- tseries::runs.test(as.factor(x), alternative = "less")
    runsTestPV <- runsPV$p.value
    if (is.nan(runsTestPV)) {
      runsTestPV <- 2}
    
    # if Chi-sq test insignif. and the runs test was significant
    if((p_val > 0.05) & (runsTestPV < 0.05)) {
      trendPlus<-10
      cat="Recurrent"
    }
    
    # if chi-sq insignif. and the runs test insignif.
    if((p_val > 0.05) & (runsTestPV > 0.05)){
      trendPlus<-5
      cat="Random"
    }
    
  }
  
  # for each species, record the summary statistics
  statSumm <- tibble("numyears" = tslen, "numpresent" = tssum, "chi_pval"=p_val, "chi_fearly" = f_early, "chi_flate" = f_late, "runs_pval"=runsTestPV, "numtransitions" = v, "trend"=trend, "category2.0"= as.factor(cat))
  
  return(statSumm)
} 

```

### getTrends2.5
```{r getTrends2.5}
  #input (x) is a single row of a matrix where the species are rows and the columns are each year with 1/0 values (1=present, 0=absent). 
  #So you need to iterate each row separately to get the results
  # Output is a list with 6 items, that represents the classification results for a single species

getTrends2.5<- function(x) {
  #input (x) is a single row of a matrix where the species are rows and the columns are each year with 1/0 values (1=present, 0=absent). 
  #So you need to iterate each row separately to get the results
  # Output is a list with 6 items, that represents the classification results for a single species
  
  #create an object the same length as x that defines early vs late years
  time <- rep("late", length(x))
  time[1:(round(length(x)/2))] <- "early"
  
  # make a table that tells you how many 0s and 1s are in the early and the late halves of the time series
  z_x <- table(x,time)
  
  #find the time-series length (number of years)
  tslen <- length(x)

  # counts the number of years the species was present
  tssum <- sum(x)
 
  # create an empty vector to store results in for the next for loop
   l <- c()
  
  # identifies when a change from a 0 to a 1 or vice versa happens
  for(k in 1:(tslen-1)) {
    j <- x[k+1] - x[k]
    l <- c(l, j)
    v <- sum(abs(l))
  }
  
  
  # If all the values are 0, it is always absent
  if ((tssum/tslen) <= 0.05) {
    p_val <- NA
    f_early <- NA
    f_late <- NA
    runsTestPV <- NA
    trend <- NA
    trendPlus <- NA
    cat <- "No_change-absent"
  }
  
  # if all the values are 1, it is always present
  else if ((tssum/tslen) >= 0.95) {
    p_val <- NA
    f_early <- NA
    f_late <- NA
    runsTestPV<-NA
    trend<-NA
    trendPlus<-NA
    cat<-"No_change-present"
  }
  
   #If the time series contains changes, then we do a chi-sq test to detect any directed change in the time series.
  else {
     
    #adds rownames to the z_x table
    rownames(z_x) <- c("absent","present")
    
    # get p value for the chi-squared test
    p_val <- chisq.test(z_x)$p.val
    
    # get early and late fractions
    # for each the early and the late parts of the time series:
    #    the number of years it was present divided by the number of years
    f_early <- z_x["present","early"] / sum(z_x[,1]) 
    f_late <- z_x["present","late"] / sum(z_x[,2])
   
    if((f_early > f_late) & (p_val <= 0.05)) {
      trend <- -1
      cat = "Decreasing"
    }
    
    if((f_early < f_late) & (p_val <= 0.05)) {
      trend <- 1
      cat = "Increasing"
    }
    
    # Chi-squared test not significant
    if(p_val > 0.05) trend <- 0
    
    #conduct a runs test on the time-series
    runsPV <- tseries::runs.test(as.factor(x), alternative = "less")
    runsTestPV <- runsPV$p.value
    if (is.nan(runsTestPV)) {
      runsTestPV <- 2}
    
    # if Chi-sq test insignif. and the runs test was significant
    if((p_val > 0.05) & (runsTestPV < 0.05)) {
      trendPlus<-10
      cat="Recurrent"
    }
    
    # if chi-sq insignif. and the runs test insignif.
    if((p_val > 0.05) & (runsTestPV > 0.05)){
      trendPlus<-5
      cat="Random"
    }
    
  }
  
  # for each species, record the summary statistics
  statSumm <- tibble("numyears" = tslen, "numpresent" = tssum, "chiPval"=p_val, "chi_fearly" = f_early, "chi_flate" = f_late, "runsPval"=runsTestPV, "numtransitions" = v, "trend"=trend, "category2.5"= as.factor(cat))
  
  return(statSumm)
}

```

### getTrends3.0
```{r getTrends3.0}


getTrends3.0<- function(x) {
  #input (x) is a single row of a matrix where the species are rows and the columns are each year with 1/0 values (1=present, 0=absent). 
  #So you need to iterate each row separately to get the results
  # Output is a list with 6 items, that represents the classification results for a single species
  
  #create an object the same length as x that defines early vs late years
  time <- rep("late", length(x))
  time[1:(round(length(x)/2))] <- "early"
  
  # make a table that tells you how many 0s and 1s are in the early and the late halves of the time series
  z_x <- table(x,time)
  
  #find the time-series length (number of years)
  tslen <- length(x)

  # counts the number of years the species was present
  tssum <- sum(x)
 
  # create an empty vector to store results in for the next for loop
   l <- c()
  
  # identifies when a change from a 0 to a 1 or vice versa happens
  for(k in 1:(tslen-1)) {
    j <- x[k+1] - x[k]
    l <- c(l, j)
    v <- sum(abs(l))
  }
  
  
  # If all the values are 0, it is always absent
  if ((tssum/tslen) <= 0.05) {
    p_val <- NA
    f_early <- NA
    f_late <- NA
    runsTestPV <- NA
    trend <- NA
    trendPlus <- NA
    cat <- "No_change-absent"
  }
  
  # if all the values are 1, it is always present
  else if ((tssum/tslen) >= 0.95) {
    p_val <- NA
    f_early <- NA
    f_late <- NA
    runsTestPV<-NA
    trend<-NA
    trendPlus<-NA
    cat<-"No_change-present"
  }
  
   #If the time series contains changes, then we do a chi-sq test to detect any directed change in the time series.
  else {
     
    #adds rownames to the z_x table
    rownames(z_x) <- c("absent","present")
    
    # get p value for the chi-squared test
    p_val <- chisq.test(z_x)$p.val
    
    # get early and late fractions
    # for each the early and the late parts of the time series:
    #    the number of years it was present divided by the number of years
    f_early <- z_x["present","early"] / sum(z_x[,1]) 
    f_late <- z_x["present","late"] / sum(z_x[,2])
   
    if((f_early > f_late) & (p_val <= 0.05)) {
      trend <- -1
      cat = "Decreasing"
    }
    
    if((f_early < f_late) & (p_val <= 0.05)) {
      trend <- 1
      cat = "Increasing"
    }
    
    # Chi-squared test not significant
    if(p_val > 0.05) trend <- 0
    
    #conduct a runs test on the time-series
    runsPV <- tseries::runs.test(as.factor(x), alternative = "less")
    runsTestPV <- runsPV$p.value
    if (is.nan(runsTestPV)) {
      runsTestPV <- 2}
    
    # if Chi-sq test insignif. and the runs test was significant
    if((p_val > 0.05) & (runsTestPV < 0.05) & (v > 2)) {
      trendPlus<-10
      cat="Recurrent"
    }
    
    # if chi-sq insignif. and the runs test insignif.
    if((p_val > 0.05) & (runsTestPV > 0.05)|(runsTestPV < 0.05) & (v<=2)){
      trendPlus<-5
      cat="Random"
    }
    
  }
  
  # for each species, record the summary statistics
  statSumm <- tibble("numyears" = tslen, "numpresent" = tssum, "chiPval"=p_val, "chi_fearly" = f_early, "chi_flate" = f_late, "runsPval"=runsTestPV, "numtransitions" = v, "trend"=trend, "category3.0"= as.factor(cat))
  
  return(statSumm)
}


```



```{r}

x<- matrix(c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
         1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
         0,0,1,1,1,0,0,1,1,0,0,0,0,0,1,1,1,1,
         1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1),
       nrow=4, ncol=18)
x

getTrends3.0<- function(x) {
  #input (x) is a single row of a matrix where the species are rows and the columns are each year with 1/0 values (1=present, 0=absent). 
  #So you need to iterate each row separately to get the results
  # Output is a list with 6 items, that represents the classification results for a single species
  
  #create an object the same length as x that defines early vs late years
  time <- rep("late", length(x))
  time[1:(round(length(x)/2))] <- "early"
  
  # make a table that tells you how many 0s and 1s are in the early and the late halves of the time series
  z_x <- table(x,time)
  
  #find the time-series length (number of years)
  tslen <- length(x)

  # counts the number of years the species was present
  tssum <- sum(x)
 
  # create an empty vector to store results in for the next for loop
   l <- c()
  
  # identifies when a change from a 0 to a 1 or vice versa happens
  for(k in 1:(tslen-1)) {
    j <- x[k+1] - x[k]
    l <- c(l, j)
    v <- sum(abs(l))
  }
  
for(i in row(x)){  
  # If all the values are 0, it is always absent
  if ((tssum/tslen) <= 0.05) {
    p_val <- NA
    f_early <- NA
    f_late <- NA
    runsTestPV <- NA
    trend <- NA
    trendPlus <- NA
    cat <- "No_change-absent"
  }
  
  # if all the values are 1, it is always present
  else if ((tssum/tslen) >= 0.95) {
    p_val <- NA
    f_early <- NA
    f_late <- NA
    runsTestPV<-NA
    trend<-NA
    trendPlus<-NA
    cat<-"No_change-present"
  }
  next
}
  
for(j in row(x)){ 
   #If the time series contains changes, then we do a chi-sq test to detect any directed change in the time series.
    #adds rownames to the z_x table
    rownames(z_x) <- c("absent","present")
    
    # get p value for the chi-squared test
    p_val <- chisq.test(z_x)$p.val
    
    # get early and late fractions
    # for each the early and the late parts of the time series:
    #    the number of years it was present divided by the number of years
    f_early <- z_x["present","early"] / sum(z_x[,1]) 
    f_late <- z_x["present","late"] / sum(z_x[,2])
   
    if((f_early > f_late) & (p_val <= 0.05)) {
      trend <- -1
      cat = "Decreasing"
    }
    
    if((f_early < f_late) & (p_val <= 0.05)) {
      trend <- 1
      cat = "Increasing"
    }
  next
}

for (l in row(x)){
    # Chi-squared test not significant
    if(p_val > 0.05) trend <- 0
    
    #conduct a runs test on the time-series
    runsPV <- tseries::runs.test(as.factor(x), alternative = "less")
    runsTestPV <- runsPV$p.value
    if (is.nan(runsTestPV)) {
      runsTestPV <- 2}
    
    # if Chi-sq test insignif. and the runs test was significant
    if((p_val > 0.05) & (runsTestPV < 0.05) & (v > 2)) {
      trendPlus<-10
      cat="Recurrent"
    }
    
    # if chi-sq insignif. and the runs test insignif.
    else if((p_val > 0.05) & (runsTestPV > 0.05)|(runsTestPV < 0.05) & (v<=2)){
      trendPlus<-5
      cat="Random"
    }
  break
  }

  
  # for each species, record the summary statistics
  statSumm <- tibble("numyears" = tslen, "numpresent" = tssum, "chiPval"=p_val, "chi_fearly" = f_early, "chi_flate" = f_late, "runsPval"=runsTestPV, "numtransitions" = v, "trend"=trend, "category3.0"= as.factor(cat))
  
  return(statSumm)
}

apply(smammals_pa_matrix, 1, FUN = getTrends3.0)

```


###Randomization function
This is the original randomization function from Gotelli et al. to validate the accuracy of our classification functions. I need to go through this and make sure I understand what each step is.
```{r randomization}
## where t1 is the long form time series and p1 is the subset of species with the classification to be randomised


timeseries <- tibble(Year = c(1992, 1993, 1994, 
                      1995, 1996, 1997, 
                      1998, 1999, 2000, 
                      2001, 2002, 2003, 
                      2004, 2005, 2006, 
                      2007, 2008, 2009, 
                      2010, 2011, 2012, 
                      2013, 
                      1992, 1993, 1994, 
                      1995, 1996, 1997, 
                      1998, 1999, 2000, 
                      2001, 2002, 2003, 
                      2004, 2005, 2006, 
                      2007, 2008, 2009, 
                      2010, 2011, 2012, 
                      2013), 
             Presence = c(0,1,0,
                           1,1,1,
                           1,0,1,
                           1,0,0,
                           0,1,1,
                           1,1,1,
                           1,1,1,
                           1, 
                           1,1,0,
                           1,1,1,
                           1,0,1,
                           1,1,1,
                           1,1,1,
                           1,1,1,
                           1,1,1,
                           1), 
             Species = c("species1","species1","species1",
                         "species1","species1","species1",
                         "species1","species1","species1",
                         "species1","species1","species1",
                         "species1","species1","species1",
                         "species1","species1","species1",
                         "species1","species1","species1",
                         "species1", 
                         "species2","species2","species2",
                         "species2","species2","species2",
                         "species2","species2","species2",
                         "species2","species2","species2",
                         "species2","species2","species2",
                         "species2","species2","species2",
                         "species2","species2","species2",
                         "species2"))

p1 <- data.frame(Species = c("species1", "species2"))
  
### this first function takes account only of presence and absence
Randomisation <- function(timeseries){
  
  df<- tibble()
  nameRow <-c()
  
  timeseries_wide <- pivot_wider(timeseries, names_from = Year, values_from=Presence)
  nameCol<-unique(timeseries$Year)
  
  for(i in 1:length(timeseries_wide$Species)){
    x <- timeseries_wide[i,]
    species <- as.vector(timeseries_wide[i,1])
    dird <- as.vector(unique(timeseries$Species))
    if (species %in% dird) {
      nameRow <- c(nameRow, species)
      x<-x[-1]
      x[x>0]<-1
      y<-tibble(t(x))[,1]
      v<-sample(y[-1])
      z<-c(y[1], v)
      df<-rbind(df, z)
    }
    if(!sp %in% dird) {
      nameRow<-c(nameRow, sp)
      x<-x[-1]
      x[x>0]<-1
      y<-tibble(t(x))[,1]
      z<-y
      df<-rbind(df, z)
    }
  }
  
}
  
  
getRandomisation<-function(t1, p1) {
  
  df<-data.frame()
  nameRow<-c()
  
  m1<-as.data.frame(pivot_wider(t1, names_from=Year, values_from=Abundance))
  m1[is.na(m1)]<-0
  nameCol<-unique(t1$Year)
  
  for(i in 1:length(m1$Species)) {
    x<-m1[i,]
    sp<-as.vector(m1[i,1])
    dird<-as.vector(unique(p1$Species))
    if(sp %in% dird) {
      nameRow<-c(nameRow, sp)
      x<-x[-1]
      x[x>0]<-1
      y<-as.data.frame(t(x))[,1]
      v<-sample(y[-1])
      z<-c(y[1], v)
      df<-rbind(df, z)
    }
    if(!sp %in% dird) {
      nameRow<-c(nameRow, sp)
      x<-x[-1]
      x[x>0]<-1
      y<-as.data.frame(t(x))[,1]
      z<-y
      df<-rbind(df, z)
    }
  }
  
  colnames(df)<-nameCol
  rownames(df)<-nameRow
 
  nameCR<-c("Species", nameCol)
  names(df)<-nameCR
  df2<-as.data.frame(t(df))
  df3<-df2[-1,]
  names(df3)
  names(df3)<-nameRow
  
  return(df3)
}

### function to replace sample to shuffle weighted by abundance

abun_shuffle <- function() {
  
  occur_shuf <- rep(0,length(occur)) # set up an empty vector
  index <- seq_along(occur) # set up vector of indices
  presence <- sample(x=index,size=sum(occur),prob=abun) # select index values 
  occur_shuf[presence] <- 1 #assign occurrences
  return(occur_shuf)
} # end of abun_shuffle
# -------------------------------------


## revised randomisation function which now includes the vector of abundances for a time series

getAbundRandomisation<-function(t1, p1, rf1) {
  
  df<-data.frame()
  nameRow<-c()
  
  m1<-as.data.frame(pivot_wider(t1, names_from=Year, values_from=Abundance))
  m1[is.na(m1)]<-0
  nameCol<-unique(t1$Year)
  
  for(i in 1:length(m1$Species)) {
    x<-m1[i,]
    sp<-as.vector(m1[i,1])
    dird<-as.vector(unique(p1$Species))
    if(sp %in% dird) {
      nameRow<-c(nameRow, sp)
      x<-x[-1]
      x[x>0]<-1
      y<-as.data.frame(t(x))[,1]
      v<-abun_shuffle(y[-1], rf1[-1])
      z<-c(y[1], v)
      df<-rbind(df, z)
    }
    if(!sp %in% dird) {
      nameRow<-c(nameRow, sp)
      x<-x[-1]
      x[x>0]<-1
      y<-as.data.frame(t(x))[,1]
      z<-y
      df<-rbind(df, z)
    }
  }
  
  colnames(df)<-nameCol
  rownames(df)<-nameRow
  
  nameCR<-c("Species", nameCol)
  names(df)<-nameCR
  df2<-as.data.frame(t(df))
  df3<-df2[-1,]
  names(df3)
  names(df3)<-nameRow
  
  return(df3)
}
```

## Small-mammals (1992 - 2013) {.tabset}
This section is dedicated to cleaning and classifying the species for the small-mammal trapping dataset. 

Data was collected from 1981 to 2013, but we are only looking at data collected between 1992 to 2013 because bison weren't introduced to the bison plots until 1992.

---

Watersheds included in the raw dataset: 
1D, 4B, *4F*, 20B, N1B, N4D, N20B.
*italicized* = *watersheds excluded in our analysis*

Reasons for exclusion:
*4F* = Removed to have equal representation of comparable treatments; there are 2 watersheds with the 4-year fire-interval + ungrazed treatment (4B and 4F), and only one watershed with the 4-year fire-interval + grazed treatment (N4D). We removed 4F because 4B is more commonly sampled in our other datasets. We did do a Bray-Curtis Dissimilarity test between 4F and 4B after standardizing for the total number of observations per watershed and found they were ~9% dissimilar/~91% similar regarding small-mammal population.

---

Author: Donald Kaufman

ZIP file: knb-lter-knz.88.9

Data code: CSM01

File(s): 
- CSM011.csv <- The counts of species observed during their sampling periods at each watershed from 1981 to 2013.
- CSM012.csv <- Traits of the individual small mammals trapped, such as the mass, sex, relative age, pregnancy status, etc..

---

Summary of changes:
- During winter 1981-1982, the Konza Prairie management committee shifted treatment boundaries, so our traplines in N00D were encompassed in the new boundaries of N01D. Therefore, we established two new traplines in another treatment unit (N00B) in spring 1982.
- In autumn 1984, four new traplines were established with two traplines in 002C and two in 002D (24 total sampling lines). 
- Four more traplines were added in autumn 1985 with two in 010D and two in 001A (28 total sampling lines). 
- After 1987, summer sampling was discontinued because of the intensive labor required to close traps in the morning and open traps in late afternoon each day on each trapline in each trapping period.
- In 1988, Konza Prairie management committee changed unburned research treatments to treatments with a 20-year frequency of occurrence of fire and, therefore, 000B and N00B became 020B and N20B, respectively. 
- The treatment units (N01B and N04D) remained unburned from 1968 until spring 1988 when annual burning was initiated on N01B and the 4-year cycle was initiated on N04D.
- Spring fires occurred after our trapping session in these and other treatment units. 
- N20B was not burned in 1988, but it had been burned in 1980. 
- Before the spring sampling period in 1989, the number of traplines sampled was reduced from 28 traplines to 14; the 14 traplines remaining included two traplines in each of seven experimental treatments (001D, 004B, 004F, 020B, N01B, N04D and N20B).
- In addition, a second ungrazed 4-year fire treatment (004F) was continued to help monitor climatic effects on small mammals in prairie experiencing periodic fires
- Data for small mammals captured on traplines that were discontinued (001A, 002C, 002D, 004D, 004G, 010A and 010D) can be found in CSM06
- In May 1992, gates were opened between phase I and phase II of the bison area. N01B, N04D and N20B lie within the phase II area. 
- All sampling periods from autumn 1981 through spring 1992 on these three treatment units occurred on traplines that had not been grazed by bison.

---

### Small-mammals: Cleaning and organization
In this section, I read in the small-mammal data, check the data for errors, rename some columns and entries, choose the watersheds I want to further analyze, and separate the data from 1992 and onwards. 
```{r smammals cleaning}
#Seasonal summaries of small mammals on LTER traplines 
smammals_raw <- read_csv("Datasets_EAGER/Small_mammals/knb-lter-knz.88.9_FourteenTraplines/CSM011.csv")

#Table including the watershed info for all watersheds - this table will be used in subsequent taxa data
watershed_info <- read_excel("Datasets_EAGER/Other/Watershed Info.xlsx")

disturbance <- tibble(Watershed_name = c("N4A", 
                                         "N4B", 
                                         "N4D", 
                                         "N1B", 
                                         "4A", 
                                         "4B",
                                         "4F",
                                         "20B",
                                         "1D", 
                                         "N20B"), 
                     Disturbance = c("4year_Bison_A", 
                                     "4year_Bison_B", 
                                     "4year_Bison_D", 
                                     "1year_Bison_B",
                                     "4year_Ungrazed_A", 
                                     "4year_Ungrazed_B",
                                     "4year_Ungrazed_F",
                                     "20year_Ungrazed_B", 
                                     "1year_Ungrazed_D",
                                     "20year_Bison_B"))

#Separating the watershed/line column into two separate columns and creating a new dataset
smammals_all <- separate(smammals_raw, `WATERSHED/LINE`, into = c("WATERSHED", "LINE"), sep = "-")


#Renaming columns just so that they're not all capitalized
smammals_all <- smammals_all %>% rename("Watershed_name" = "WATERSHED", 
                                "Datacode" = "DATACODE",
                                "Rectype" = "RECTYPE", 
                                "Recyear" = "RECYEAR", 
                                "Season" = "SEASON", 
                                "Line" = "LINE")

#Shortening the names of the watersheds
smammals_all$Watershed_name <- dplyr::recode(smammals_all$Watershed_name,
                                       "004F" = "4F",
                                       "004B" = "4B",
                                       "001D" = "1D",
                                       "020B" = "20B",
                                       "N20B" = "N20B",
                                       "N01B" = "N1B",
                                       "N04D" = "N4D")

#Pivoting the table so that each species per year and watershed is a different row
smammals <- pivot_longer(smammals_all, cols = 8:21, 
                              names_to = "Species", 
                              values_to = "Count")

#Renaming the species into their full names
smammals$Species <- dplyr::recode(smammals$Species,
                                     "Pm" = "Peromyscus_maniculatus",
                                     "Rmeg" = "Reithrodontomys_megalotis",
                                     "Sh" = "Sigmodon_hispidus",
                                     "Bh" = "Blarina_hylophaga",
                                     "Rmon" = "Reithrodontomys_montanus",
                                     "St" = "Spermophilus_tridecemlineatus",
                                     "Mo" = "Microtus_ochrogaster",
                                     "Pl" = "Peromyscus_leucopus",
                                     "Ch" = "Chaetodipus_hispidus",
                                     "Mm" = "Mus_musculus",
                                     "Nf" = "Neotoma_floridana",
                                     "Sc" = "Synaptomys_cooperi",
                                     "Zh" = "Zapus_hudsonius",
                                     "Cp" = "Cryptotis_parva")

#Separate the dataset from 1992 onwards since bison weren't introduced until then.
smammals <- smammals %>% subset(.$Recyear >= 1992)


#Since I likely won't differentiate the data based on the trap lines, I am summing the data based on just watershed
smammals <- smammals %>% group_by(Recyear, Watershed_name, Species) %>% 
  reframe(Count = sum(Count))


# Removing the 4F watershed to make sampling between all fire/grazing treatments equal (the 4 year fire interval with no grazing combination of disturbances has two watersheds represented, while all other combinations have just one).
smammals <- smammals %>% subset(Watershed_name != "4F")

#Creating a table with the small mammal common names, to join to the main dataset and make referencing easier in plots
smammals_commonnames <- tibble(Species = c("Blarina_hylophaga", "Chaetodipus_hispidus", "Cryptotis_parva", 
                                           "Microtus_ochrogaster", "Mus_musculus", "Neotoma_floridana", 
                                           "Peromyscus_leucopus", "Peromyscus_maniculatus", 
                                           "Reithrodontomys_megalotis", "Reithrodontomys_montanus", 
                                           "Sigmodon_hispidus", "Spermophilus_tridecemlineatus", 
                                           "Synaptomys_cooperi", "Zapus_hudsonius"), 
                               Common_name = c("Elliot's short-tailed shrew", "Hispid pocket mouse", 
                                               "North American least shrew", "Prairie vole", 
                                               "House mouse", "Eastern woodrat", "White-footed mouse", 
                                               "Deer mouse", "Western harvest mouse", "Plains harvest mouse", 
                                               "Hispid cotton rat", "Thirteen-lined ground squirrel", 
                                               "Southern bog lemming", "Meadow jumping mouse"))

smammals <- left_join(smammals, smammals_commonnames, by = "Species")

```

### Small-mammals: Presence/Absence & Classification
For this section, I am reorganizing the data to be able to format it into a presence/absence matrix. This matrix will then be ran through the getTrends function to get the classifications for each species at each watershed.
```{r smammals pa}
#Combining the species and watershed variables so that each species per watershed per year is a unique identifier
smammals<- smammals %>% unite("Species.watershed", Species:Watershed_name, sep = ".")

#Pivoting the table so that each year is a column and each row is the 'species.watershed' variable
smammals_years_wide <- smammals %>% 
  pivot_wider(names_from = "Recyear", values_from = "Count")

#Creating a separate species.watershed dataframe to add back to the dataset after standardization
smammals_env <- smammals_years_wide[, 1:2]

#Standardizing by presence/absence
decostand_smammals_pa <- decostand(smammals_years_wide[, -(1:2)], "pa", na.rm = TRUE )

#Transforming the presence/absence data into a matrix so I can feed it to the function
smammals_pa_matrix <- as.matrix(decostand_smammals_pa)

#Applying the getTrends function to each row of the presence/absence matrix
smammals_trends <- apply(smammals_pa_matrix, 1, FUN = getTrends)
smammals_trends2.0 <- apply(smammals_pa_matrix, 1, FUN = getTrends2.0)
smammals_trends2.5 <- apply(smammals_pa_matrix, 1, FUN = getTrends2.5)
smammals_trends3.0 <- apply(smammals_pa_matrix, 1, FUN = getTrends3.0)


#Creating a table with the species.watershed and the Trends info. I excluded the bsline info. ADD INFO ABOUT WHAT THIS IS TAKING FROM 
smammals_classification <- tibble((smammals_env), do.call(rbind,lapply(smammals_trends,(function(v){v[c(1,2,3,4,5,6,7,8,9)]}))),
do.call(rbind,lapply(smammals_trends2.0,(function(v){v[c(9)]}))),
do.call(rbind,lapply(smammals_trends2.5,(function(v){v[c(9)]}))),
do.call(rbind,lapply(smammals_trends3.0,(function(v){v[c(9)]}))))

#Adding in the presence/absence per year data back in 
smammals_class <- smammals_classification %>% add_column(decostand_smammals_pa, .before = "chi_pval")

#Separating the species and watershed variable names for graphing later
smammals_class <- smammals_class %>% separate(Species.watershed, c("Genus", "Spp", "Watershed_name")) %>% unite("Species", Genus:Spp, sep = "_")

smammals_class <- left_join(smammals_class, disturbance, by = "Watershed_name")

#Pivoting longer so that each row is now a year, species, watershed, etc.
smammals_class_long <- smammals_class %>% pivot_longer(cols = "1992":"2013", 
                                                 names_to = "Recyear", 
                                                 values_to = "Presence")



```

### Small-mammals: Exploration plots
This section is dedicated for exploratory plots to just get some inital visuals for the data. 
```{r smammals plots}

#Joining the watershed_info dataset with the actual small mammal dataset



#Making variables factors
# smammals_class_long <- smammals_class_long %>% mutate(Fire_interval = factor(Fire_interval),
#                     Burn_season = factor(Burn_season),
#                     Grazing = factor(Grazing),
#                     Watershed_name = factor(Watershed_name))


smammals_graphing <- smammals_class_long %>% dplyr::select(Recyear, Species, Common_name, category, category2.0, category2.5, category3.0, Presence, Watershed_name, Disturbance)

# smammals_graphing <- smammals_graphing %>% unite("Disturbance treatment", 
#                                                      Fire_interval:Grazing, sep = "_", remove = FALSE)

#Making the zeroes in the presence column into NAs for plotting (that way they don't show up on the graph)
smammals_graphing$Presence[smammals_class_long$Presence == 0] <- NA

#Making sure the Recyear is coded as numeric 
smammals_graphing <- smammals_graphing %>% mutate(Recyear = as.numeric(Recyear))

#Reordering the fire intervals for plotting
smammals_graphing$Disturbance <- factor(smammals_graphing$Disturbance,
                                           levels = c("1year_Ungrazed_D", "1year_Bison_B", 
                                                      "4year_Ungrazed_B",  "4year_Bison_D",
                                                      "20year_Ungrazed_B", "20year_Bison_B"))

# smammals_graphing$Fire_interval <- factor(smammals_graphing$Fire_interval,
#                                            levels = c("1_year", "4_years", "20_years"))
#Reordering the grazing for plotting
# smammals_graphing$Grazing <- factor(smammals_graphing$Grazing,
#                                      levels = c("Ungrazed", "Bison"))
#Reordering the watersheds for plotting
smammals_graphing$Watershed_name <- factor(smammals_graphing$Watershed_name,
                                        levels = c("1D", "N1B", "4B", "N4D", "20B", "N20B"))

smammals_graphing$category <- factor(smammals_graphing$category,
                                        levels = c("No_change-absent", "No_change-present", "Increasing", "Recurrent", "Random"))

smammals_graphing$category2.0 <- factor(smammals_graphing$category2.0,
                                        levels = c("No_change-absent", "No_change-present", "Increasing", "Recurrent", "Random"))

smammals_graphing$category2.5 <- factor(smammals_graphing$category2.5,
                                        levels = c("No_change-absent", "No_change-present", "Increasing", "Recurrent", "Random"))

smammals_graphing$category3.0 <- factor(smammals_graphing$category3.0,
                                        levels = c("No_change-absent", "No_change-present", "Increasing", "Recurrent", "Random"))

smammals_class_graphing <- smammals_classification %>% pivot_longer(cols = "category":"category3.0",
                                                                    names_to = "function_type",
                                                                    values_to = "classification")

smammals_class_graphing <- smammals_class_graphing %>% group_by(function_type, classification) %>% dplyr::summarise(total_count=n(),.groups = 'drop')

smammals_class_graphing <- smammals_class_graphing %>% mutate(Proportion = (total_count/84))

smammals_class_graphing3.0 <- smammals_class_graphing %>% subset(function_type == "category3.0")

smammals_class_graphing2.5 <- smammals_class_graphing %>% subset(function_type == "category2.5")

smammals_class_graphing %>% ggplot(aes(x = classification, y = total_count, color = function_type, group = function_type)) + geom_point() + geom_line()


smammals_class_graphing3.0$classification <- factor(smammals_class_graphing3.0$classification,
                                        levels = c("No_change-absent", 
                                                   "No_change-present", 
                                                   "Recurrent", "Random", "Increasing"))

smammals_class_graphing2.5$classification <- factor(smammals_class_graphing3.0$classification,
                                        levels = c("No_change-absent", 
                                                   "No_change-present", 
                                                   "Recurrent", "Random", "Increasing"))

smammals_idk <- smammals_class %>% group_by(Disturbance, category3.0) %>% dplyr::summarise(total_count=n(),.groups = 'drop') %>% mutate(Proportion = (total_count/14))

smammals_idk <- smammals_class %>% group_by(Disturbance, category2.5) %>% dplyr::summarise(total_count=n(),.groups = 'drop') %>% mutate(Proportion = (total_count/14))

smammals_idk$category3.0 <- factor(smammals_idk$category3.0,
                                        levels = c("No_change-absent",
                                                   "No_change-present", 
                                                   "Recurrent", "Random", "Increasing"))

smammals_graphing$category3.0 <- factor(smammals_graphing$category3.0,
                                        levels = c("No_change-absent",
                                                   "No_change-present", 
                                                   "Recurrent", "Random", "Increasing"))

smammals_idk$category3.0 <- factor(smammals_idk$category3.0,
                                        levels = c("No_change-absent",
                                                   "No_change-present", 
                                                   "Recurrent", "Random", "Increasing"))

smammals_idk$Disturbance<- factor(smammals_idk$Disturbance,
                                        levels = c("1year_Ungrazed_D", "4year_Ungrazed_B", "20year_Ungrazed_B",  "1year_Bison_B", "4year_Bison_D", "20year_Bison_B"))

unique(smammals_idk$Disturbance)

smammals_idk %>% ggplot(aes(x = category3.0, y = Proportion, fill = category3.0)) + 
  geom_col() + 
  scale_fill_manual(values = c("lightgray","#000000", "#CC79A7", "#0072B2", "#009E73")) +
  facet_wrap(.~Disturbance) +
  theme_bw() +
  theme(text = element_text(size=14), 
        axis.text.x = element_text(angle=90, hjust=1)) +
  labs(title= "Proportion of Small Mammals Species in Each Incidence Classification for Each Watershed", 
       x = "Classification", 
       y = "Proportion of Species", 
       fill = "Classification")

smammals_idk %>% ggplot(aes(x = Proportion, y = category2.5, fill = category3.0)) + 
  geom_violin() + 
  scale_fill_manual(values = c("gray","black", "darkorchid", "dodgerblue2", "darkolivegreen4")) +
  theme(text = element_text(size=14))+
  labs(title= "Proportion of Small Mammals Species in Each Incidence Classification for Each Watershed", 
       x = "Classification", 
       y = "Proportion of Species", 
       fill = "Classification")

smammals_class_graphing3.0 %>% ggplot(aes(x = classification, y = Proportion, fill = classification)) + geom_col() + scale_fill_manual(values = c("lightgray","#000000", "#CC79A7", "#0072B2", "#009E73")) +
  theme_bw() +
  theme(text = element_text(size=14), 
        axis.text.x = element_text(angle=45, hjust=1)) +
  labs(title= "Proportion of Small Mammals Species in Each Incidence Classification", 
       x = "Classification", 
       y = "Proportion of Species", 
       fill = "Classifcation")

smammals_class_graphing2.5 %>% ggplot(aes(x = classification, y = Proportion, fill = classification)) + geom_col() + scale_fill_manual(values = c("gray","black", "darkorchid", "dodgerblue2", "darkolivegreen4")) +
  theme(text = element_text(size=14), 
        axis.text.x = element_text(angle=45, hjust=1)) +
  labs(title= "Proportion of Small Mammals Species in Each Incidence Classification", 
       x = "Classification", 
       y = "Proportion of Species", 
       fill = "Classifcation")


smammals_graphing_3.0 <- smammals_graphing %>% subset()


smammals_idk <- smammals_classification %>% pivot_longer(cols=c("chi_fearly", "chi_flate"), names_to =  "Early_late", values_to = "Proportion")

smammals_idk %>% ggplot(aes(x = Proportion, fill = Early_late)) + geom_density(alpha = 0.5) + facet_wrap(category~.) + labs(title="Difference in Early and Late Proportions for the Small Mammal Dataset") + scale_fill_manual(values = c("lightgreen", "red"))


#Creating a graph to look at the classification by species and presence/absence by year
smammals_graphing %>% ggplot(aes(x = Recyear, y = Presence, fill = category)) + 
  geom_tile(width = .6, height = .6) + 
  facet_grid(Species~`Disturbance treatment`, switch = "y") +
  theme(text = element_text(size=9),
        axis.text.x = element_text(angle=45, hjust=1, size =9),
        axis.text.y = element_text(size=12),
        strip.text.y.left = element_text(angle = 0, size = 9),
        strip.text.x.top = element_text(size = 9)) +
  geom_vline(xintercept = 2002.5, linetype= 2) +
  coord_fixed(ratio = 5) +
  labs(x = "Year", y = "Presence") +
  scale_fill_manual(values = c("NA", "black", "#009E73", "#CC79A7", "#0072B2")) +
  labs(title = "Small mammal classifcations with original getTrends function")

smammals_graphing %>% ggplot(aes(x = Recyear, y = Presence, fill = category2.0)) + 
  geom_tile(width = .6, height = .6) + 
  facet_grid(Species~`Disturbance treatment`, switch = "y") +
  theme(text = element_text(size=9),
        axis.text.x = element_text(angle=45, hjust=1, size =9),
        axis.text.y = element_text(size=12),
        strip.text.y.left = element_text(angle = 0, size = 9),
        strip.text.x.top = element_text(size = 9)) +
  geom_vline(xintercept = 2002.5, linetype= 2) +
  coord_fixed(ratio = 5) +
  labs(x = "Year", y = "Presence") +
  scale_fill_manual(values = c("lightgrey","black", "darkolivegreen4", "darkorchid", "dodgerblue2")) +
  labs(title = "Small mammal classifcations with getTrends2.0 function")

smammals_graphing %>% ggplot(aes(x = Recyear, y = Presence, fill = category2.5)) + 
  geom_tile(width = .6, height = .6) + 
  facet_grid(Species~Disturbance, switch = "y") +
  theme(text = element_text(size=9),
        axis.text.x = element_text(angle=45, hjust=1, size =9),
        axis.text.y = element_text(size=12),
        strip.text.y.left = element_text(angle = 0, size = 9),
        strip.text.x.top = element_text(size = 9)) +
  geom_vline(xintercept = 2002.5, linetype= 2) +
  coord_fixed(ratio = 5) +
  labs(x = "Year", y = "Presence") +
  scale_fill_manual(values = c("lightgrey","black", "darkolivegreen4", "darkorchid", "dodgerblue2")) +
  labs(title = "Small mammal classifcations with getTrends2.5 function")

smammals_graphing %>% ggplot(aes(x = Recyear, y = Presence, fill = category3.0)) + 
  geom_tile(width = .6, height = .6) + 
  facet_grid(Common_name~Disturbance, switch = "y") +
  theme(text = element_text(size=9),
        axis.text.x = element_text(angle=45, hjust=1, size =9),
        axis.text.y = element_text(size=12),
        strip.text.y.left = element_text(angle = 0, size = 9),
        strip.text.x.top = element_text(size = 9)) +
  geom_vline(xintercept = 2002.5, linetype= 2) +
  coord_fixed(ratio = 5) +
  labs(x = "Year", y = "Presence") +
  scale_fill_manual(values = c("lightgray","black", "#CC79A7", "#0072B2","#009E73")) +
  labs(title = "Small Mammal Classifcation by Species",
       fill = "Classification")


smammals_rm <- smammals_graphing %>% filter(Species == "Reithrodontomys_megalotis")

smammals_rm %>% ggplot(aes(x = Recyear, y = Presence, fill = category3.0)) + 
  geom_tile(width = 0.6, height = 0.6) + 
  facet_grid(Common_name~`Disturbance treatment`, switch = "y") +
  theme(text = element_text(size=10),
        axis.text.x = element_text(angle=45, hjust=1, size =12),
        axis.text.y = element_text(size=12),
        strip.text.y.left = element_text(angle = 0, size = 10),
        strip.text.x.top = element_text(size = 10)) +
  geom_vline(xintercept = 2002.5, linetype= 2) +
  coord_fixed(ratio = 5) +
  labs(x = "Year", y = "Presence") +
  scale_fill_manual(values = c("black", "dodgerblue2"))

smammals_pm <- smammals_graphing %>% filter(Species == "Peromyscus_maniculatus")

smammals_pm %>% ggplot(aes(x = Recyear, y = Presence, fill = category3.0)) + 
  geom_tile(width = 0.6, height = 0.6) + 
  facet_grid(Common_name~`Disturbance treatment`, switch = "y") +
  theme(text = element_text(size=10),
        axis.text.x = element_text(angle=45, hjust=1, size =12),
        axis.text.y = element_text(size=12),
        strip.text.y.left = element_text(angle = 0, size = 10),
        strip.text.x.top = element_text(size = 10)) +
  geom_vline(xintercept = 2002.5, linetype= 2) +
  coord_fixed(ratio = 5) +
  labs(x = "Year", y = "Presence") +
  scale_fill_manual(values = c("black", "dodgerblue2"))

smammals_pl <- smammals_graphing %>% filter(Species == "Peromyscus_leucopus")

smammals_pl %>% ggplot(aes(x = Recyear, y = Presence, fill = category3.0)) + 
  geom_tile(width = 0.6, height = 0.6) + 
  facet_grid(Common_name~`Disturbance treatment`, switch = "y") +
  theme(text = element_text(size=10),
        axis.text.x = element_text(angle=45, hjust=1, size =12),
        axis.text.y = element_text(size=12),
        strip.text.y.left = element_text(angle = 0, size = 10),
        strip.text.x.top = element_text(size = 10)) +
  geom_vline(xintercept = 2002.5, linetype= 2) +
  coord_fixed(ratio = 5) +
  labs(x = "Year", y = "Presence") +
  scale_fill_manual(values = c("black", "dodgerblue2"))


smammals_bh <- smammals_graphing %>% filter(Species == "Blarina_hylophaga")

smammals_bh %>% ggplot(aes(x = Recyear, y = Presence, fill = category3.0)) + 
  geom_tile(width = 0.6, height = 0.6) + 
  facet_grid(Common_name~`Disturbance treatment`, switch = "y") +
  theme(text = element_text(size=10),
        axis.text.x = element_text(angle=45, hjust=1, size =12),
        axis.text.y = element_text(size=12),
        strip.text.y.left = element_text(angle = 0, size = 10),
        strip.text.x.top = element_text(size = 10)) +
  geom_vline(xintercept = 2002.5, linetype= 2) +
  coord_fixed(ratio = 5) +
  labs(x = "Year", y = "Presence",
       fill = "Classification") +
  scale_fill_manual(values = c("darkorchid", "dodgerblue2"))


smammals_bh <- smammals_graphing %>% filter(Species == "Blarina_hylophaga")

smammals_bh %>% ggplot(aes(x = Recyear, y = Presence, fill = category3.0)) + 
  geom_tile(width = 0.6, height = 0.6) + 
  facet_grid(Common_name~`Disturbance treatment`, switch = "y") +
  theme(text = element_text(size=10),
        axis.text.x = element_text(angle=45, hjust=1, size =12),
        axis.text.y = element_text(size=12),
        strip.text.y.left = element_text(angle = 0, size = 10),
        strip.text.x.top = element_text(size = 10)) +
  geom_vline(xintercept = 2002.5, linetype= 2) +
  coord_fixed(ratio = 5) +
  labs(x = "Year", y = "Presence",
       fill = "Classification") +
  scale_fill_manual(values = c("darkorchid", "dodgerblue2"))

smammals_st <- smammals_graphing %>% filter(Species == "Spermophilus_tridecemlineatus")

smammals_st %>% ggplot(aes(x = Recyear, y = Presence, fill = category3.0)) + 
  geom_tile(width = 0.6, height = 0.6) + 
  facet_grid(Common_name~`Disturbance treatment`, switch = "y") +
  theme(text = element_text(size=10),
        axis.text.x = element_text(angle=45, hjust=1, size =12),
        axis.text.y = element_text(size=12),
        strip.text.y.left = element_text(angle = 0, size = 10),
        strip.text.x.top = element_text(size = 10)) +
  geom_vline(xintercept = 2002.5, linetype= 2) +
  coord_fixed(ratio = 5) +
  labs(x = "Year", y = "Presence",
       fill = "Classification") +
  scale_fill_manual(values = c("darkorchid", "dodgerblue2"))




smammals_nf <- smammals_graphing %>% filter(Species == "Neotoma_floridana")
smammals_nf$category3.0 <- factor(smammals_nf$category3.0,
                                  levels = c("No_change-absent",
                                                   "No_change-present", 
                                                   "Recurrent", "Random", "Increasing"))

smammals_nf %>% ggplot(aes(x = Recyear, y = Presence, fill = category3.0)) + 
  geom_tile(width = 0.6, height = 0.6) + 
  facet_grid(Common_name~Disturbance, switch = "y") +
  theme(text = element_text(size=10),
        axis.text.x = element_text(angle=45, hjust=1, size =12),
        axis.text.y = element_text(size=12),
        strip.text.y.left = element_text(angle = 0, size = 10),
        strip.text.x.top = element_text(size = 10)) +
  geom_vline(xintercept = 2002.5, linetype= 2) +
  coord_fixed(ratio = 5) +
  labs(x = "Year", y = "Presence",
       fill = "Classification") +
  scale_fill_manual(values = c("NA", "#CC79A7", "#0072B2","#009E73"))




smammals_class_graphing %>% ggplot(aes(x = classification, y = total_count, color = function_type, group = function_type)) + geom_point() + geom_line()

smammals_class_graping %>% ggplot(aes(x = classification, y = total_count)) + 
  stat_summary(fun.data=mean_sdl, fun.args = list(mult=1), 
        geom="errorbar", color="black", width=0.2) + +
  theme_bw() +
  ylim(-.15, 1.15) +
  theme(axis.text.x = element_text(angle=45, hjust=1))

```


## Birds (1992 - 2009) {.tabset}
This section is dedicated to cleaning and analyzing the bird-sampling data set. 

Data was collected from 1981 to 2009, but we are only looking at data collected between 1992 to 2009 because bison weren't introduced to the bison plots until 1992.

Censuses are conducted two times during the year: during the first two weeks of January as a measure of wintering populations, and during the first two weeks of June as a measure of breeding populations.

---

Watersheds included in the raw dataset: 
1D, 4A, 4B, *4D*, 20B, *20C*, N1B, N4B, N4D, N20B, *R1B*, *R20A*, *LA*, *SA*, *GA*
*italicized* = *watersheds excluded in our analysis* 

Reasons for exclusion:
*4D* = This watershed turned into area SA in 1990 and was dropped from the dataset. **NEED TO DOUBLE CHECK**
*20C* = Removed to have equal representation of comparable treatments; there are 2 watersheds with the 20-year fire-interval + ungrazed treatment (20B and 20C), and only one watershed with the 20-year fire-interval + grazed treatment (N20B). We removed 20C because 20B is more commonly sampled in our other datasets. We did complete a Bray-Curtis Dissimilarity test between 20B and 20C after standardizing for the total number of observations per watershed and found they were ~23% dissimilar/ ~77% similar.
*R1B* = This watershed doesn't fit into the disturbance framework we are assessing; this watershed was burned every 20 years till 2000 and is now burned yearly.
*R20A* = Similarly to watershed R1B, this doesn't fit into the disturbance framework we are assessing; this watershed was burned yearly up till 2000 and is now burned every 20 years.
*LA, SA, GA* = These are not watersheds. They are gallery forest and forest edge areas located in lower King's Creek, north fork, and upper Shane's Creek at Konza. Since they are forest locations and don't fit into the disturbance framework we are assessing, we dropped them.

---


Data author: Alice Boyle

ZIP file: knb-lter-knz.26.12

Data code: CBP01

File(s): CBP011.csv <- The counts of species observed during their sampling periods at each watershed from 1981 to 2009.

---

Summary of changes up to 1993 (this is all that was included in the metadata): 
- 1981: Transects were as presently located except no transect in N20B and there were transects in  N20C (now N01A), N20D (now part of N01B), N01C (now N02B), N01D (now part of N01B), and N04C (now N04B). 
- 1982: Transects in N20C (N01A) and N01C (N02B) were dropped, N20D was maintained in what is now N01B. N01D became the second transect in what is now N01B, and N04C transect was maintained in what is now N04B. N20B was added. 
- 1990: 004d became SA and transect was dropped.

---

### Birds: Cleaning and organizing
```{r birds cleaning}
#Read in and view bird data
birds_raw <- read_csv("Datasets_EAGER/Birds/knb-lter-knz.26.12/CBP011.csv", show_col_types = FALSE)

unique(birds_raw$WATERSHED)

#Changing classifications and names of columns
birds_all <- birds_raw %>% mutate(RECMONTH = factor(RECMONTH),
                          RECDAY = factor(RECDAY),
                          SEASON = factor(SEASON),
                          TRANSNUM = factor(TRANSNUM),
                          SPECNAME = factor(SPECNAME),
                          AOUCODE = factor(AOUCODE),
                          COMMONNAME = factor(COMMONNAME),
                          DISTANCE = as.numeric(DISTANCE),
                          COUNT = as.numeric(COUNT),
                          SEX = factor(SEX),
                          STATUS = factor(STATUS),
                          COMMENTS = as.character(COMMENTS))

#Renaming the columns so they're not all capitalized
birds_all <- birds_all %>% rename("Watershed_name" = "WATERSHED",
                          "Datacode" = "DATACODE",
                          "Recyear" = "RECYEAR",
                          "Recmonth" = "RECMONTH",
                          "Recday" = "RECDAY",
                          "Season" = "SEASON",
                          "Transect" = "TRANSNUM",
                          "Observation_number" = "OBSNUM",
                          "Species" = "SPECNAME",
                          "AOU_code" = "AOUCODE",
                          "Common_name" = "COMMONNAME",
                          "Distance" = "DISTANCE",
                          "Count" = "COUNT",
                          "Sex" = "SEX",
                          "Status" = "STATUS",
                          "Comments" = "COMMENTS",
                          "Time" = "TIME",
                          "Duration" = "DURATION",
                          "Observer" = "OBSERVER")

#Renaming the watersheds to make the names shorter
birds_all$Watershed_name <- dplyr::recode(birds_all$Watershed_name,
                                       "N04D" = "N4D",
                                       "N04B" = "N4B",
                                       "004B" = "4B",
                                       "004A" = "4A",
                                       "004D" = "4D",
                                       "N01B" = "N1B",
                                       "001D" = "1D",
                                       "R20A" = "R20A",
                                       "R01B" = "R1B",
                                       "020C" = "20C",
                                       "020B" = "20B",
                                       "L00A" = "LA",
                                       "S00A" = "SA",
                                       "G00A" = "GA",
                                       "N20B" = "N20B")


#I need to separate the dataset from 1992 onwards. 
birds <- birds_all %>% subset(.$Recyear >= 1992)


#Selecting only the watersheds I want for further analysis
birds <- birds %>% subset(Watershed_name %in% c("1D", "4A", "4B", 
                                                "20B", "N1B", "N4B", 
                                                "N4D", "N20B"))

##This transect is being removed to not duplicate the number of observations at a single watershed; watershed N1B has two transects (6, 10) and all other watersheds just have one transect.
###I did do a Bray-Curtis dissimilarity test on the two different transects to make sure they were similar enough, and it looks like they are about 23% dissimilar (~77% similar)
birds <-  birds %>% subset(Transect != "10")

#Checking the lengths of the species (the 'species' variable has a lot more entries, but they are duplicates with naming variations when looking at the matching common names. So I'll use the AOU code instead.)
length(unique(birds$Species))
length(unique(birds$AOU_code))

#Also removing observations that are unspecified
birds <-  subset(birds, !(AOU_code %in% c("NONE", "VOID", "UNSP", "UNEM", "RSTO")))

#Renaming this one all lowercase entry since all other entries are all uppercase
birds$AOU_code <- dplyr::recode(birds$AOU_code,
                                "eawp" = "EAWP")

length(unique(birds$AOU_code))
sort(unique(birds$AOU_code))

```

### Birds: Presence/Absence & Classification
```{r birds pa}

#Selecting the columns I want for further analysis 
birds_group <- birds %>% group_by(Recyear, Watershed_name, AOU_code) %>% 
  reframe(Count = sum(Count))


#Pivoting the the dataset wider, so that each species is its own column and each row is a year and watershed. This is to populate the dataset with NA's (which will become zeroes) for each species in each year. If species weren't observed, they weren't recorded, but we still want that to count as an absence and it needs to represented in the dataset.
birds_wide <- birds_group %>% 
  pivot_wider(names_from = "AOU_code", values_from = "Count", 
              values_fn = function(x) paste(sum(x)))

#Creating a dataset with species and watershed as rows and years as columns. This is the format I need for the getTrends function
birds_years_wide <- birds_wide %>% pivot_longer(cols = -c(1:2), 
                                                names_to = "Species", 
                                                values_to = "Count") %>% 
  pivot_wider(names_from = factor("Recyear"), 
              values_from = "Count")

#Combining the variables of species and watershed to create a unique identifier for each row 
birds_years_wide <- birds_years_wide %>% unite("Species.watershed", Species:Watershed_name, sep = ".")


#Creating a separate species.watershed dataframe to add back to the dataset after standardization
birds_env <- birds_years_wide[, 1]

#Standardizing by presence/absence
decostand_birds_pa <- decostand(birds_years_wide[, -c(1)], "pa", na.rm = FALSE)
#Making all NA's zeroes; NA's are entries in which no data was collected, thus are absent/0
decostand_birds_pa[is.na(decostand_birds_pa)] <- 0


# Transforming the presence/absence data into a matrix so I can feed it to the function
birds_pa_matrix <- as.matrix(decostand_birds_pa)

# Applying the getTrends function to each row of the presence/absence matrix
birds_trends <- apply(birds_pa_matrix, 1, getTrends)
birds_trends2.0 <- apply(birds_pa_matrix, 1, getTrends2.0)
birds_trends2.5 <- apply(birds_pa_matrix, 1, getTrends2.5)
birds_trends3.0 <- apply(birds_pa_matrix, 1, getTrends3.0)

#Creating a table with the species.watershed and the Trends info. I excluded the bsline info. ADD INFO ABOUT WHAT THIS IS TAKING FROM 
birds_classification <- tibble((birds_env), do.call(rbind,lapply(birds_trends,(function(v){v[c(1,2,3,4,5,6,7,8,9)]}))),
do.call(rbind,lapply(birds_trends2.0,(function(v){v[c(9)]}))),
do.call(rbind,lapply(birds_trends2.5,(function(v){v[c(9)]}))),
do.call(rbind,lapply(birds_trends3.0,(function(v){v[c(9)]}))))

#Creating a table with the species.watershed and the Trends info. I excluded the bsline info.

#Adding in the presence/absence per year data back in 
birds_class <- birds_classification %>% add_column(decostand_birds_pa, .before = "chi_pval")

#Separating the species and watershed variable names for graphing later
birds_class <- birds_class %>% separate(Species.watershed, c("AOU_code", "Watershed_name"))
birds_class <- left_join(birds_class, disturbance, by = "Watershed_name")

for(i in 1:nrow(birds_class)){
   if (birds_class$AOU_code[i] == "EATO" & birds_class$Watershed_name[i] == "20B") {birds_class$category3.0[i] <- "Increasing"}
  if (birds_class$AOU_code[i] == "EATO" & birds_class$Watershed_name[i] == "N20B") {birds_class$category3.0[i] <- "Increasing"}
  if (birds_class$AOU_code[i] == "BGGN" & birds_class$Watershed_name[i] == "N4D") {birds_class$category3.0[i] <- "Increasing"}
   if (birds_class$AOU_code[i] == "EAKI" & birds_class$Watershed_name[i] == "N20B") {birds_class$category3.0[i] <- "Decreasing"}
  
}

birds_class3.0 <- birds_class %>% dplyr::select(AOU_code, Watershed_name, category3.0)

birds_class3.0_increasing <- birds_class3.0 %>% subset(category3.0 == "Increasing")

unique(birds_class3.0_increasing$AOU_code)

birds_class3.0_decreasing <- birds_class3.0 %>% subset(category3.0 == "Decreasing")
unique(birds_class3.0_decreasing$AOU_code)

#Pivoting longer so that each row is now a year, species, watershed, etc.
birds_class_long <- birds_class %>% pivot_longer(cols = "1992":"2009", 
                                                 names_to = "Recyear", 
                                                 values_to = "Presence")


```

### Birds: Exploration Plots
```{r birds plots}

#Joining the watershed_info dataset with the actual birds dataset
# birds_class_long <- left_join(birds_class_long, disturbance, by = "Watershed_name")

#Converting some of the variables into factors
# birds_class_long <- birds_class_long %>% mutate(Fire_interval = factor(Fire_interval),
#                                   Burn_season = factor(Burn_season),
#                                   Grazing = factor(Grazing))

birds_graphing <- birds_class_long %>% dplyr::select(Recyear, AOU_code, category, category2.0, category2.5, category3.0, Presence, Watershed_name, Disturbance)

#Making all presence = "0" inti NA's so they don't show up in theb graph
birds_graphing$Presence[birds_graphing$Presence == 0] <- NA

#Making the years numeric instead of characters
birds_graphing <- birds_graphing %>% mutate(Recyear = as.character(Recyear))
birds_graphing <- birds_graphing %>% mutate(Recyear = as.numeric(Recyear))


#Changing the order of the watersheds so that the grazing and non-grazing watersheds of the same burn interval are next to each other
birds_graphing$Watershed_name <- factor(birds_graphing$Watershed_name,
                                levels = c("1D", "N1B", "4A", 
                                           "4B", "N4B", "N4D", 
                                           "20B", "N20B"))



#Making the zeroes in the presence column into NAs for plotting (that way they don't show up on the graph)

#Making sure the Recyear is coded as numeric 
birds_graphing <- birds_graphing %>% mutate(Recyear = as.numeric(Recyear))

#Reordering the fire intervals for plotting

# 
# birds_graphing$Fire_interval <- factor(birds_graphing$Fire_interval,
#                                            levels = c("1_year", "4_years", "20_years"))
#Reordering the grazing for plotting
# birds_graphing$Grazing <- factor(birds_graphing$Grazing,
#                                      levels = c("Ungrazed", "Bison"))
#Reordering the watersheds for plotting

birds_graphing$category <- factor(birds_graphing$category,
                                        levels = c("No_change-absent", "No_change-present", "Increasing", "Decreasing", "Recurrent", "Random"))

birds_graphing$category2.0 <- factor(birds_graphing$category2.0,
                                        levels = c("No_change-absent", "No_change-present", "Increasing", "Decreasing", "Recurrent", "Random"))

birds_graphing$category2.5 <- factor(birds_graphing$category2.5,
                                        levels = c("No_change-absent", "No_change-present", "Increasing", "Decreasing", "Recurrent", "Random"))

birds_graphing$category3.0 <- factor(birds_graphing$category3.0,
                                        levels = c("No_change-absent", "No_change-present", "Increasing", "Decreasing", "Recurrent", "Random"))

birds_class_graphing <- birds_classification %>% pivot_longer(cols = "category":"category3.0",
                                                                    names_to = "function_type",
                                                                    values_to = "classification")

birds_class_graphing <- birds_class_graphing %>% group_by(function_type, classification) %>% dplyr::summarise(total_count=n(),.groups = 'drop') %>% mutate(Proportion = (total_count/648))

birds_class_graphing3.0 <- birds_class_graphing %>% subset(function_type == "category3.0")

birds_class_graphing3.0$classification <- factor(birds_class_graphing3.0$classification,
                                        levels = c("No_change-absent", 
                                                   "No_change-present", 
                                                   "Recurrent", "Random", "Increasing", "Decreasing"))


birds_class_graphing %>% ggplot(aes(x = classification, y = total_count, color = function_type, group = function_type)) + geom_point() + geom_line()

birds_idk <- birds_class %>% group_by(Disturbance, category3.0) %>% dplyr::summarise(total_count=n(),.groups = 'drop') %>% mutate(Proportion = (total_count/81))

birds_idk$category3.0 <- factor(birds_idk$category3.0,
                                        levels = c("No_change-absent",
                                                   "No_change-present", 
                                                   "Recurrent", "Random", "Increasing", "Decreasing"))

# 
# birds_idk <- birds_classification %>% pivot_longer(cols=c("chi_fearly", "chi_flate"), names_to =  "Early_late", values_to = "Proportion")
# 
# birds_idk %>% ggplot(aes(x = Proportion, fill = Early_late)) + geom_density(alpha = 0.5) + facet_wrap(category~.) + labs(title="Difference in Early and Late Proportions for the Bird Dataset") + scale_fill_manual(values = c("lightgreen", "red"))
birds_idk$Disturbance <- factor(birds_idk$Disturbance,
                                levels = c("1year_Ungrazed_D", "4year_Ungrazed_A", "4year_Ungrazed_B", "20year_Ungrazed_B", "1year_Bison_B", "4year_Bison_B", "4year_Bison_D", "20year_Bison_B"))

birds_idk %>% ggplot(aes(x = category3.0, y = Proportion, fill = category3.0)) + geom_col() + 
  scale_fill_manual(values = c("lightgray","#000000", "#CC79A7", "#0072B2", "#009E73", "#D55E00")) +
  theme_bw() +
  facet_wrap(.~Disturbance, nrow=2, ncol=4) +
  theme(text = element_text(size=14), 
        axis.text.x = element_text(angle=90, hjust=1)) +
  labs(title= "Proportion of Bird Species in Each Incidence Classification for Each Watershed", 
       x = "Classification", 
       y = "Proportion of Species", 
       fill = "Classification")

birds_class_graphing3.0 %>% ggplot(aes(x = classification, y = Proportion, fill = classification)) + geom_col() + scale_fill_manual(values = c("lightgray","#000000", "#CC79A7", "#0072B2", "#009E73", "#D55E00")) +
  theme_bw() +
  theme(text = element_text(size=14), 
        axis.text.x = element_text(angle=45, hjust=1)) +
  labs(title= "Proportion of Birds Species in Each Incidence Classification", 
       x = "Classification", 
       y = "Proportion of Species", 
       fill = "Classifcation")


#Creating a graph to look at the classification by species and presence/absence by year
birds_graphing %>% ggplot(aes(x = Recyear, y = Presence, fill = category)) + geom_tile(width = .6, height = .6) + 
  facet_grid(AOU_code~Disturbance, switch = "y") +
  theme(text = element_text(size=9),
        axis.text.x = element_text(angle=45, hjust=1, size =9),
        axis.text.y = element_text(size=12),
        strip.text.y.left = element_text(angle = 0, size = 9),
        strip.text.x.top = element_text(size = 9)) +
  labs(x = "Year", y = "Presence") +
  scale_fill_manual(values = c("NA", "black", "darkolivegreen4", "firebrick", "darkorchid", "dodgerblue2")) +
  labs(title = "Bird classifcations with original getTrends function")


birds_graphing_directed <- birds_graphing %>% subset(AOU_code %in% c("INBU", "BARS", "EATO", "BGGN", "RNEP", "RWBL", "FISP", "EAKI"))

birds_graphing_directed$Disturbance <- factor(birds_graphing_directed$Disturbance, 
                                              levels = c("1year_Ungrazed_D", "1year_Bison_B", "4year_Ungrazed_A", "4year_Ungrazed_B", "4year_Bison_B", "4year_Bison_D", "20year_Ungrazed_B", "20year_Bison_B"))

birds_graphing_directed$category3.0 <- factor(birds_graphing_directed$category3.0,
                                                levels = c("No_change-absent", "No_change-present", "Recurrent", "Random", "Increasing", "Decreasing"))


birds_graphing_increasing <- birds_graphing_directed %>% subset(AOU_code %in% c("INBU", "BARS", "EATO", "BGGN"))

birds_graphing_decreasing <- birds_graphing_directed %>% subset(AOU_code %in% c("RNEP", "RWBL", "FISP", "EAKI"))

birds_graphing_increasing$category3.0 <- factor(birds_graphing_increasing$category3.0,
                                                levels = c("No_change-absent", "No_change-present", "Recurrent", "Random", "Increasing"))

birds_graphing_decreasing$category3.0 <- factor(birds_graphing_decreasing$category3.0,
                                                levels = c("No_change-absent", "No_change-present", "Recurrent", "Random", "Decreasing"))

birds_graphing_directed %>% ggplot(aes(x = Recyear, y = Presence, fill = category3.0)) + geom_tile(width = .6, height = .6) + 
  facet_grid(AOU_code~Disturbance, switch = "y") +
  theme(text = element_text(size=9),
        axis.text.x = element_text(angle=45, hjust=1, size =9),
        axis.text.y = element_text(size=12),
        strip.text.y.left = element_text(angle = 0, size = 9),
        strip.text.x.top = element_text(size = 9)) +
  labs(x = "Year", y = "Presence") +
  coord_fixed(ratio = 5) +
  geom_vline(xintercept = 2000.5, linetype= 2)+
  scale_fill_manual(values = c("gray","#000000", "#CC79A7", "#0072B2","#009E73", "#D55E00")) +
  labs(title = "Bird classifcations with getTrends3.0 function", 
       fill = "Classification")

birds_graphing_increasing %>% ggplot(aes(x = Recyear, y = Presence, fill = category3.0)) + geom_tile(width = .6, height = .6) + 
  facet_grid(AOU_code~Disturbance, switch = "y") +
  theme(text = element_text(size=9),
        axis.text.x = element_text(angle=45, hjust=1, size =9),
        axis.text.y = element_text(size=12),
        strip.text.y.left = element_text(angle = 0, size = 9),
        strip.text.x.top = element_text(size = 9)) +
  labs(x = "Year", y = "Presence") +
  coord_fixed(ratio = 5) +
  geom_vline(xintercept = 2000.5, linetype= 2)+
  scale_fill_manual(values = c("gray", "#0072B2", "#009E73")) +
  labs(title = "Bird classifcations with getTrends3.0 function", 
       fill = "Classification")

birds_graphing_decreasing %>% ggplot(aes(x = Recyear, y = Presence, fill = category3.0)) + geom_tile(width = .6, height = .6) + 
  facet_grid(AOU_code~Disturbance, switch = "y") +
  theme(text = element_text(size=9),
        axis.text.x = element_text(angle=45, hjust=1, size =9),
        axis.text.y = element_text(size=12),
        strip.text.y.left = element_text(angle = 0, size = 9),
        strip.text.x.top = element_text(size = 9)) +
  labs(x = "Year", y = "Presence") +
  coord_fixed(ratio = 5) +
  geom_vline(xintercept = 2000.5, linetype= 2)+
  scale_fill_manual(values = c("gray","#000000", "#CC79A7", "#0072B2", "#D55E00")) +
  labs(title = "Bird classifcations with getTrends3.0 function", 
       fill = "Classification")


birds_graphing %>% ggplot(aes(x = Recyear, y = Presence, fill = category)) + 
  geom_tile(width = .6, height = .6) + 
  facet_grid(AOU_code~Disturbance, switch = "y") +
  theme(text = element_text(size=7),
        axis.text.x = element_text(angle=45, hjust=1, size =7),
        axis.text.y = element_text(size=5),
        strip.text.y.left = element_text(angle = 0, size = 3),
        strip.text.x.top = element_text(size = 7)) +
  scale_fill_manual(values = c("NA", "black", "dodgerblue2", "darkorchid", "darkolivegreen4", "firebrick3")) +
  labs(x = "Year", y = "Presence", fill = "Classification")




```


## Grasshoppers (2002 - 2020) {.tabset}
This section is dedicated to cleaning the grasshopper sweeping dataset. 

Data was collected from 1982 to 2020, but we are only looking at data from 2002 to 2020 because sampling at the bison plots was suspended from 1985 - 2002.

---

Watersheds included in the raw dataset: 
*B*, *NB*, 1D, *2C*, *2D*, 4B, *4D*, 4F, *4G*, *10D*, 20B, *N1A*, N1B, N4A, N4D, *N20A*, N20B, *SpB*, *SuB*
*italicized* = *watersheds excluded in our analysis*

Reasons for exclusion
*B* = Although not stated in the metadata for this dataset, it is mentioned in the metadata of the small-mammal dataset that this watershed was converted into watershed 20B in 1988.
*NB* = Again, though not mentioned in the metadata for this dataset, the small-mammal metadata mentions that this watershed was converted into watershed N20B in 1988.
*2C* = This watershed doesn't have a grazed counterpart, and thus doesn't have a fair comparison in terms of disturbance treatment.
*2D* = This watershed also doesn't have a grazed counterpart, and thus doesn't have a fair comparison in terms of disturbance treatment.
*4D* = This watershed was converted into watershed SpB (or, according to the Birds dataset, it was converted into area SA -- a forest area)
*4G* = This watershed was only temporarily added in 1986 and eventually became watershed WB instead, which is a watershed that is burned annually in the Winter.
*10D* = This watershed was converted into watershed SuB, which is a watershed that is burned every 2 years in the Summer.
*N1A* = Removed to have equal representation of comparable treatments; there are 2 watersheds with the 1-year fire-interval + grazed treatment (N1A and N1B), and only one watershed with the 1-year fire-interval + ungrazed treatment (1D). We removed N1A because N1B is more commonly sampled in our other datasets. We did do a Bray-Curtis Dissimilarity test between N1A and N1B after standardizing for the total number of observations per watershed and found they were ~16% dissimilar/ ~84% similar regarding grasshopper population.
*N20A* = Similarly to N1A, we removed this watershed to have equal representation of comparable treatments; there are 2 watersheds with the 20-year fire-interval + grazed treatment (N20A and N20B), and only one watershed with the 20-year fire-interval + ungrazed treatment (20B). We removed N20A because N20B is more commonly sampled in our other datasets. We did do a Bray-Curtis Dissimilarity test between N20A and N20B after standardizing for the total number of observations per watershed and found they were ~16% dissimilar/ ~84% similar regarding grasshopper population.
*SpB* = Not included because it doesn't fit into the disturbance framework we are assessing. This watershed is an experimental plot that is burned annually in the Spring and exists to compare how burning in different seasons can affect ecological processes. 
*SuB* = Not included because it doesn't fit into the disturbance framework we are assessing. This watershed is an experimental plot that is burned annually in the Summer and exists to compare how burning in different seasons can affect ecological processes.

---

Author: Anthony Joern

ZIP file: knb-lter-knz.29.20

Data code: CGR02

File(s): 
- CGR021.csv <- Environmental data that was taken from the grasshopper sampling sites. Information includes wind speed, air temperature, and cloud cover.
- CGR022.csv <- The species count data we will use for our classification and analysis. 
- CGR023.csv <- Additional information on the individual grasshoppers caught, including the instar stage and sex. 

---

Summary of changes: 
- 1982-1987: Sites were sampled at various earlier dates in addition to the late July-early August.
- 1985:Sweeping was restricted to all sites being sampled (twice, on different dates) in late July and early August.  Additional watersheds (002D, 004D (now 0SpB)), 004F AND 010D (now 0SuB) were added to the sampling regime for early August to provide more long-term data on the influence of fire frequency on grasshoppers. Sampling on watersheds to be grazed (N01B, N04D, and N20B) was discontinued. 
- 1986: Watershed 004G (now 00WB) was temporarily added. Sampling in June and early July was reduced to watersheds 001D, 004D, 010D and 020B only; too few grasshoppers are collected by sweeping in the first half of the summer for all watersheds to merit sampling. 
- 1987: Sampling in June and early July was restricted to sites 001D, 002C, 004B and 004F. 
- 1994: Fire regime changed for 004D (became 0SpB) and 010D (became 0SuB). In the years when 0SuB is burned the sweeps are done 2 weeks earlier than normal. The summer burn is conducted on the first water appropriate day in late July to early August. 
- 1996: Wildfire in February, burned 004F, 0SuB, 001D and 002D. 
- 1998: 0SuB done earlier than other sites (mid-July) under the mistaken idea that the summer burns were to occur this year. 
- 2002: Grazed (bison) transects were added in N01A, N01B, N04A, N04D, N20A and N02B. An older version of the methods manual indicates that 3 lowland (Tully) sites were once done. Locations were: 
001D A: T-28; 
004B A: G-28; B: S-28; B: F-28; 
020B A: N-29; B: N-29 
- 2011: WindMate 200 replaced previous machine used for checking wind speeds. The previous machine had limit of detection of 5mph. WindMate 200 specifications: Temperature -20 oC to 158 oF accuracy +1.8 oC to 89 mph accuracy +3%. 
- 2013: Beginning with this year, Oecanthinae spp., Gryllidae spp., Tettigoniidae spp., are being added to our list. These are not new species to Konza. We are adding them to the official listing because they are related and ecologically similar. 
- 2016: In years when SuB is burned, pre-burn and post-burn sweeps will be done. Timing for pre-burn will be mid-July and timing for post-burn will be mid-September. 
- 2018: March 14. 004B  A was burned in a wildfire. A third sweep, C, will be done in the vicinity of pab011 FC until 2021 when 004b is scheduled to burn per normal schedule.

---

### Grasshoppers: Cleaning and organizing
```{r grasshoppers cleaning}

grasshoppers_raw <- read_csv("Datasets_EAGER/Grasshoppers/knb-lter-knz.29.20/CGR022.csv", show_col_types = FALSE) #This dataset is the grasshopper species counts from each set of sweeps
grasshopper_families <- read_excel("Datasets_EAGER/Grasshoppers/Grasshopper_families.xlsx") #Dataset I created that records the families and suborders for each grasshopper genus in the dataset; I am going to only look at grasshoppers from the suborder Caelifera because those from the suborder Ensifera (family/genus: Oecanthinae, Gryllidae, and Tettigoniidae) were not counted until 2013.

#Changing the classifcations of the some of the variables for later analysis and creating a new dataset
grasshoppers_all <- grasshoppers_raw %>% mutate(WATERSHED = factor(WATERSHED),
                                                SPECIES = factor(SPECIES),
                                                SPCODE = factor(SPCODE),
                                                RECYEAR = as.numeric(RECYEAR))

#Checking the number of unique names for the species to check for misspellings
sort(unique(grasshoppers_all$SPECIES))
##There are capitalizations in some but not others and there are some unknowns. I'll have to rename many of these to have them be consistent.

#Recoding some of the species to make it consistent
grasshoppers_all$SPECIES <- dplyr::recode(grasshoppers_all$SPECIES,
                                "ageneotett deorum" = "Ageneotettix deorum",
                                "arphia conspersa" = "Arphia conspersa",
                                "arphia simplex" = "Arphia simplex",
                                "arphia species" = "Arphia spp.",
                                "arphia spp." = "Arphia spp.",
                                "arphia xanthopte" = "Arphia xanthoptera",
                                "boopedon auriventr" = "Boopedon auriventris",
                                "boopedon gracile" = "Boopedon gracile",
                                "boopedon nubilum" = "Boopedon nubilum",
                                "brachystol magna" = "Brachystola magna", 
                                "campylacan olivacea" = "Campylacantha olivacea",
                                "chortophag viridifas" = "Chortophaga viridifasciata",
                                "encoptolop sordidus" = "Encoptolophus sordidus",
                                "encoptolop spp." = "Encoptolophus spp.",
                                "Encoptolphus spp." = "Encoptolophus spp.",
                                "encoptolop subgracil" = "Encoptolophus subgracilis",
                                "eritettix simplex" = "Eritettix simplex",
                                "hadrotetti trifascia" = "Hadrotettix trifasciatus",
                                "hesperotet species" = "Hesperotettix spp.",
                                "hesperotet speciosus" = "Hesperotettix speciosus",
                                "hesperotet spp." = "Hesperotettix spp.",
                                "hesperotet viridis" = "Hesperotettix viridis",
                                "hippiscus rugosus" = "Hippiscus rugosus",
                                "hypochlora alba" = "Hypochlora alba",
                                "melanoplus angustipe" = "Melanoplus angustipennis",
                                "melanoplus bivittatu" = "Melanoplus bivittatus",
                                "melanoplus confusus" = "Melanoplus confusus",
                                "melanoplus different" = "Melanoplus differentialis",
                                "melanoplus femurrubr" = "Melanoplus femurrubrum",
                                "melanoplus foedus" = "Melanoplus foedus",
                                "melanoplus keeleri" = "Melanoplus keeleri",
                                "melanoplus occidenta" = "Melanoplus occidentalis",
                                "melanoplus packardii" = "Melanoplus packardii",
                                "melanoplus sanguinip" = "Melanoplus sanguinipes",
                                "melanoplus scudderi" = "Melanoplus scudderi",
                                "melanoplus species" = "Melanoplus spp.",
                                "melanoplus spp." = "Melanoplus spp.",
                                "mermiria bivitatta" = "Mermiria bivittata",
                                "mermiria bivittata" = "Mermiria bivittata",
                                "mermiria picta" = "Mermiria picta",
                                "mermiria species" = "Mermiria spp.",
                                "mermiria spp." = "Mermiria spp.",
                                "oedipodinae" = "Oedipodinae spp.",
                                "opeia obscura" = "Opeia obscura",
                                "orphulella speciosa" = "Orphulella speciosa",
                                "orphullela speciosa" = "Orphulella speciosa",
                                "paratylota brunneri" = "Paratylotropidia brunneri",
                                "paratylotr brunneri" = "Paratylotropidia brunneri",
                                "pardalopho haldemani" = "Pardalophora haldemani",
                                "pardalopho apiculata" = "Pardalophora apiculata",
                                "pardalopho species" = "Pardalophora spp.",
                                "pardalopho spp." = "Pardalophora spp.",
                                "phoetaliot nebrascen" = "Phoetaliotes nebrascensis",
                                "pseudopoma brachypte" = "Pseudopomala brachyptera",
                                "Pseuodopomala brachyptera" = "Pseudopomala brachyptera",
                                "psoloessa delicatul" = "Psoloessa delicatula",
                                "schistocer lineata" = "Schistocerca lineata",
                                "schistocer obscura" = "Schistocerca obscura",
                                "syrbula admirabil" = "Syrbula admirabilis",
                                "unknown" = "Unknown",
                                "xanthippus corallipe" = "Xanthippus corallipes")

###After some exploration, I found that Hippiscus rugosa and Hippiscus ocelote are the same thing, so I will change everything to Hippiscus ocelote.
grasshoppers_all$SPECIES <- dplyr::recode(grasshoppers_all$SPECIES,
                                      "Hippiscus rugosus" = "Hippiscus ocelote")


#Checking the watershed names to look for misspellings 
sort(unique(grasshoppers_all$WATERSHED))
##There are weird capitalizations for these too... I'll have to go through and clean and also consolidate based on the metadata

#Renaming watersheds to make it consistent
grasshoppers_all$WATERSHED <- dplyr::recode(grasshoppers_all$WATERSHED,
                                  "001d" = "1D",
                                  "004b" = "4B",
                                  "000b" = "B",
                                  "n04a" = "N4A",
                                  "n01b" = "N1B",
                                  "n04d" = "N4D",
                                  "n00b" = "NB",
                                  "002d" = "2D", 
                                  "004d" = "4D",
                                  "004f" = "4F",
                                  "010d" = "10D",
                                  "004g" = "4G",
                                  "002c" = "2C",
                                  "0sub" = "SuB",
                                  "020b" = "20B",
                                  "0spb" = "SpB",
                                  "n20a" = "N20A",
                                  "n20b" = "N20B",
                                  "n01a" = "N1A",
                                  "N20B" = "N20B",
                                  "002D" = "2D",
                                  "N01B" = "N1B",
                                  "001D" = "1D",
                                  "N04D" = "N4D",
                                  "004F" = "4F",
                                  "002C" = "2C",
                                  "020B" = "20B",
                                  "0SUB" = "SuB",
                                  "0SPB" = "SpB",
                                  "004B" = "4B",
                                  "N01A" = "N1A",
                                  "N04A" = "N4A",
                                  "N20A" = "N20A")

##Then consolidating watersheds based on the metadata
grasshoppers_all$WATERSHED <- dplyr::recode(grasshoppers_all$WATERSHED,
                                   "B" = "20B",
                                   "NB" = "N20B",
                                   "2D" = "SpB",
                                   "4D" = "SpB",
                                   "10D" = "SuB",
                                   "4G" = "WB")

###Also, some of the species names aren't correctly matched with their spp code, so I will fix that
 for(i in 1:nrow(grasshoppers_all)){
   if (grasshoppers_all$SPECIES[i] == "Oecanthinae spp."){grasshoppers_all$SPCODE[i] <- "56"}
   if (grasshoppers_all$SPECIES[i] == "Tettigoniidae spp."){grasshoppers_all$SPCODE[i] <- "59"}
   if (grasshoppers_all$SPECIES[i] == "Gryllidae spp."){grasshoppers_all$SPCODE[i] <- "58"}
   if (grasshoppers_all$SPECIES[i] == "Melanoplus femurrubrum"){grasshoppers_all$SPCODE[i] <- "12"}
 }


##Since the bison grazed plots weren't sampled until 2002, I am removing all data pre-2002
grasshoppers <- grasshoppers_all %>% subset(.$RECYEAR >= 2002)

#Renaming the columns so they're not all capitalized
grasshoppers <- grasshoppers %>% rename("Watershed_name" = "WATERSHED",
                              "Recyear" = "RECYEAR",
                              "Recmonth" = "RECMONTH",
                              "Recday" = "RECDAY",
                              "Species" = "SPECIES",
                              "Total" = "TOTAL",
                              "Soil_type" = "SOILTYPE",
                              "Repsite" = "REPSITE",
                              "Spp_code" = "SPCODE")


#Only selecting the watersheds I will use for further analysis
grasshoppers <- grasshoppers %>%
  subset(Watershed_name %in% c("1D", "20B", "4B", 
                               "4F", "N1B", "N4A", 
                               "N4D", "N20B")) 

#Separating the genus and spp and creating new columns. This is to add in the family and suborder info and also to easily remove entries that are not identified down to species.
grasshoppers <- grasshoppers %>% separate(Species, c("Genus", "Spp"), sep = " ", remove = FALSE)

##This is where I am adding in the other dataset that has the family and suborder info and then only selecting those from the suborder Caelifera since suborder Ensifera are katydids and crickets and most were not counted until 2013
grasshoppers <- left_join(grasshoppers, grasshopper_families, by = "Genus")
grasshoppers <- grasshoppers %>% subset(Suborder == "Caelifera")

##Removing unknowns from the dataset
grasshoppers <- grasshoppers %>% subset(Genus != "Unknown")

##Removing the entries that aren't identified to species 
grasshoppers <- grasshoppers %>% subset(Spp != "spp.")

length(unique(grasshoppers$Spp_code))
```

### Grasshoppers: Presence/Absence & Classification
```{r grasshoppers pa}

#Selecting the columns I want for further analysis 
grasshoppers_group <- grasshoppers %>% 
  group_by(Recyear, Species, Watershed_name) %>% 
  reframe(Count = sum(Total))


#Pivoting the the dataset wider, so that each species is its own column and each row is a year and watershed. This is to populate the dataset with NA's (which will become zeroes) for each species in each year. If species weren't observed, they weren't recorded, but we still want that to count as an absence, so it needs to represented in the dataset.
grasshoppers_wide <- grasshoppers_group %>% 
  pivot_wider(names_from = "Species", values_from = "Count", 
              values_fn = function(x) paste(sum(x)))

#Creating a dataset with species and watershed as rows and years as columns. This is the format I need for the getTrends function
grasshoppers_years_wide <- grasshoppers_wide %>% pivot_longer(cols = -c(1:2), 
                                                names_to = "Species", 
                                                values_to = "Count") %>% 
  pivot_wider(names_from = factor("Recyear"), 
              values_from = "Count")

#Combining the species and watershed variables to create a unique identifier for each row
grasshoppers_years_wide <- grasshoppers_years_wide %>% 
  unite("Species.watershed", Species:Watershed_name, sep = ".")

#Creating a separate species.watershed dataframe to add back to the dataset after standardization
grasshoppers_env <- grasshoppers_years_wide[, 1]


#Standardizing by presence/absence
decostand_grasshoppers_pa <- decostand(grasshoppers_years_wide[, -c(1)], "pa", na.rm = FALSE)
#Making all NA's zeroes; NA's are entries in which no data was collected, thus are absent/0
decostand_grasshoppers_pa[is.na(decostand_grasshoppers_pa)] <- 0



#Transforming the presence/absence data into a matrix so I can feed it to the function
grasshoppers_pa_matrix <- as.matrix(decostand_grasshoppers_pa)

#Applying the getTrends function to each row of the presence/absence matrix
grasshoppers_trends <- apply(grasshoppers_pa_matrix, 1, getTrends)
grasshoppers_trends2.0 <- apply(grasshoppers_pa_matrix, 1, FUN = getTrends2.0)
grasshoppers_trends2.5 <- apply(grasshoppers_pa_matrix, 1, FUN = getTrends2.5)
grasshoppers_trends3.0 <- apply(grasshoppers_pa_matrix, 1, FUN = getTrends3.0)


#Creating a table with the species.watershed and the Trends info. I excluded the bsline info.
grasshoppers_classification <- tibble((grasshoppers_env), do.call(rbind,lapply(grasshoppers_trends,(function(v){v[c(1,2,3,4,5,6,7,8,9)]}))),
do.call(rbind,lapply(grasshoppers_trends2.0,(function(v){v[c(9)]}))),
do.call(rbind,lapply(grasshoppers_trends2.5,(function(v){v[c(9)]}))),
do.call(rbind,lapply(grasshoppers_trends3.0,(function(v){v[c(9)]}))))



#Adding in the presence/absence per year data back in 
grasshoppers_class <- grasshoppers_classification %>% add_column(decostand_grasshoppers_pa, .before = "chi_pval")

#Separating the species and watershed variable names for graphing later
grasshoppers_class <- grasshoppers_class %>% separate(Species.watershed, c("Genus", "Spp", "Watershed_name")) %>% unite("Species", Genus:Spp, sep = "_")

grasshoppers_class <- left_join(grasshoppers_class, disturbance, by = "Watershed_name")
#Pivoting longer so that each row is now a year, species, watershed, etc.
grasshoppers_class_long <- grasshoppers_class %>% pivot_longer(cols = "2002":"2020", 
                                                 names_to = "Recyear", 
                                                 values_to = "Presence")

```

### Grasshoppers: Exploration Plots
```{r grasshoppers plots}

grasshoppers_graphing <- grasshoppers_class_long

#Making all presence = "0" inti NA's so they don't show up in the graph
grasshoppers_graphing$Presence[grasshoppers_graphing$Presence == 0] <- NA

#Making the years numeric instead of characters
grasshoppers_graphing <- grasshoppers_graphing %>% mutate(Recyear = as.character(Recyear))
grasshoppers_graphing <- grasshoppers_graphing %>% mutate(Recyear = as.numeric(Recyear))

#Changing the order of the watersheds so that the grazing and non-grazing watersheds of the same burn interval are next to each other
grasshoppers_graphing$Watershed_name <- factor(grasshoppers_graphing$Watershed_name,
                                levels = c("1D", "N1B", "4B", 
                                           "4F", "N4A", "N4D", 
                                           "20B", "N20B"))


grasshoppers_graphing$category <- factor(grasshoppers_graphing$category, 
                               levels = c("No_change-absent", "No_change-present", 
                                          "Random", "Recurrent", "Increasing", 
                                          "Decreasing"))

grasshoppers_class_graphing <- grasshoppers_classification %>% pivot_longer(cols = "category":"category3.0",
                                                                    names_to = "function_type",
                                                                    values_to = "classification")


grasshoppers_class_graphing <- grasshoppers_class_graphing %>% group_by(function_type, classification) %>% dplyr::summarise(total_count=n(),.groups = 'drop')

grasshoppers_class_graphing <- grasshoppers_class_graphing %>% mutate(Proportion = (total_count/352))
grasshoppers_class_graphing3.0 <- grasshoppers_class_graphing %>% subset(function_type == "category3.0")

grasshoppers_class_graphing3.0$classification <- factor(grasshoppers_class_graphing3.0$classification,
                                        levels = c("No_change-absent", 
                                                   "No_change-present", 
                                                   "Recurrent", "Random", "Increasing", "Decreasing"))

grasshoppers_idk <- grasshoppers_class %>% group_by(Disturbance, category3.0) %>% dplyr::summarise(total_count=n(),.groups = 'drop') %>% mutate(Proportion = (total_count/44))

grasshoppers_idk$category3.0 <- factor(grasshoppers_idk$category3.0,
                                        levels = c("No_change-absent",
                                                   "No_change-present", 
                                                   "Recurrent", "Random", "Decreasing"))

grasshoppers_idk$Disturbance <- factor(grasshoppers_idk$Disturbance,
                                levels = c("1year_Ungrazed_D", "4year_Ungrazed_B", "4year_Ungrazed_F", "20year_Ungrazed_B", "1year_Bison_B", "4year_Bison_A", "4year_Bison_D", "20year_Bison_B"))


grasshoppers_idk %>% ggplot(aes(x = category3.0, y = Proportion, fill = category3.0)) + geom_col() + 
  scale_fill_manual(values = c("lightgray","#000000", "#CC79A7", "#0072B2", "#D55E00")) +
  theme_bw() +
  facet_wrap(.~Disturbance, nrow=2, ncol =4) +
  theme(text = element_text(size=14), 
        axis.text.x = element_text(angle=90, hjust=1)) +
  labs(title= "Proportion of Grasshopper Species in Each Incidence Classification for Each Watershed", 
       x = "Classification", 
       y = "Proportion of Species", 
       fill = "Classification")

grasshoppers_class_graphing3.0 %>% ggplot(aes(x = classification, y = Proportion, fill = classification)) + geom_col() + scale_fill_manual(values = c("lightgray","#000000", "#CC79A7", "#0072B2", "#D55E00")) +
  theme_bw() +
  theme(text = element_text(size=14), 
        axis.text.x = element_text(angle=45, hjust=1)) +
  labs(title= "Proportion of Grasshoppers Species in Each Incidence Classification", 
       x = "Classification", 
       y = "Proportion of Species", 
       fill = "Classifcation")

grasshoppers_graphing %>% ggplot(aes(x = Recyear, y = Presence, fill = category)) + 
  geom_tile(width = .6, height = .6) + 
  facet_grid(Species~Watershed_name, switch = "y") +
  theme(text = element_text(size=7),
        axis.text.x = element_text(angle=45, hjust=1, size =7),
        axis.text.y = element_text(size=5),
        strip.text.y.left = element_text(angle = 0, size = 3),
        strip.text.x.top = element_text(size = 7)) +
   geom_vline(xintercept = 2011.5, linetype= 2) +
  scale_fill_manual(values = c("NA", "black", "dodgerblue2", "darkorchid", "firebrick3")) +
  labs(x = "Year", y = "Presence", fill = "Classification")

grasshoppers_melansang <- grasshoppers_graphing %>% subset(Species == "Melanoplus_sanguinipes")

grasshoppers_melansang$Disturbance <- factor(grasshoppers_melansang$Disturbance,
                                levels = c("1year_Ungrazed_D", "1year_Bison_B", "4year_Ungrazed_B", "4year_Ungrazed_F", "4year_Bison_A", "4year_Bison_D", "20year_Ungrazed_B", "20year_Bison_B"))
grasshoppers_melansang$category3.0 <- factor(grasshoppers_melansang$category3.0, levels = c("No_change-absent","No_change-present", "Recurrent", "Random", "Decreasing"))

grasshoppers_melansang %>% ggplot(aes(x = Recyear, y = Presence, fill = category3.0)) + 
  geom_tile(width = .6, height = .6) + 
  facet_grid(Species~Disturbance, switch = "y") +
  theme(text = element_text(size=9),
        axis.text.x = element_text(angle=45, hjust=1, size =9),
        axis.text.y = element_text(size=12),
        strip.text.y.left = element_text(angle = 0, size = 9),
        strip.text.x.top = element_text(size = 9)) +
   geom_vline(xintercept = 2011.5, linetype= 2) +
  scale_fill_manual(values = c("#CC79A7", "#0072B2", "#D55E00")) +
  coord_fixed(ratio=5) +
  labs(x = "Year", y = "Presence", fill = "Classification")


```

## Plants (1992 - 2022) {.tabset}
This section is dedicated to cleaning and analyzing the plant species composition/cover dataset. 

Data was collected from 1983 to 2022, but we are only looking at data collected between 1992 to 2022 because bison weren't introduced to the bison plots until 1992.

---

Watersheds included in the raw dataset: *1A*, *1C*, 1D, *2C*, *2D*, 4A, 4B, *4F*, *20A*, 20B, *20D*, *N1A*, N1B, *N2A*, *N2B*, N4A, N4D, *N20A*, N20B, *R1A*, *R1B*, *SpA*, *SpB*, *SuA*, *SuB*, *FA*, *WA*, *WB*

*italicized* = watersheds we excluded in our analysis
Reasons:
*1A* = Not sampled in enough years; only sampled in 4 years
*1C* = Also no sampled in enough years; sampled in 17 years, mostly before 1992
*2C* = Does not have an adequate counterpart for comparison. The grazing counterpart for these watersheds were only sampled 3 times.  
*2D* = This watershed was converted into watershed SpB, which is a watershed that is burned annually in the Spring. **NEED TO DOUBLE CHECK THIS**
*4F* = Not sampled in enough years; only sampled in 8 years
*20A* = Not sampled in enough years; only sampled in 4 years
*20D* = Not sampled in enough years; only sampled in 8 years
*N1A* = Removed to have equal representation of comparable treatments; there are 2 watersheds with the 1-year fire-interval + grazed treatment (N1A and N1B), and only one watershed with the 1-year fire-interval + ungrazed treatment (1D). We removed N1A because it was sampled from 1993 onwards, while N1B was sampled from 1992 onwards. We did do a Bray-Curtis Dissimilarity test between N1A and N1B after standardizing for the total number of observations and converting the cover numbers into more discrete numbers based on the half-point in their percent cover range and found they were ~39% dissimilar/ ~61% similar regarding plant population.
*N2A* = Not sampled in enough years; only sampled in 3 years.
*N2B* = Not sampled in enough years; only sampled in 3 years.
*N20A* = Removed to have equal representation of comparable treatments; there are 2 watersheds with the 20-year fire-interval + grazed treatment (N20A and N20B), and only one watershed with the 20-year fire-interval + ungrazed treatment (20B). We removed N20A because it was sampled from 1993 onwards, while N20B was sampled from 1992 onwards. We did do a Bray-Curtis Dissimilarity test between N20A and N20B after standardizing for the total number of observations and converting the cover numbers into more discrete numbers based on the half-point in their percent cover range and found they were ~35% dissimilar/ ~65% similar regarding plant population.
*R1A* = This watershed doesn't fit into the disturbance framework we are assessing; this watershed was burned every 20 years till 2000 and is now burned yearly.
*R1B* = This watershed doesn't fit into the disturbance framework we are assessing; this watershed was burned every 20 years till 2000 and is now burned yearly.
*SpA* = Not included because it doesn't fit into the disturbance framework we are assessing. This watershed is an experimental plot that is burned annually in the Spring and exists to compare how burning in different seasons can affect ecological processes.
*SpB* =  Not included because it doesn't fit into the disturbance framework we are assessing. This watershed is an experimental plot that is burned annually in the Spring and exists to compare how burning in different seasons can affect ecological processes.
*SuA* =  Not included because it doesn't fit into the disturbance framework we are assessing. This watershed is an experimental plot that is burned every 2 years in the Summer and exists to compare how burning in different seasons can affect ecological processes.
*SuB* =  Not included because it doesn't fit into the disturbance framework we are assessing. This watershed is an experimental plot that is burned every 2 years in the Summer and exists to compare how burning in different seasons can affect ecological processes.
*FA* =  Not included because it doesn't fit into the disturbance framework we are assessing. This watershed is an experimental plot that is burned annually in the Fall and exists to compare how burning in different seasons can affect ecological processes.
*WA* = Not included because it doesn't fit into the disturbance framework we are assessing. This watershed is an experimental plot that is burned annually in the Winter and exists to compare how burning in different seasons can affect ecological processes.
*WB* = Not included because it doesn't fit into the disturbance framework we are assessing. This watershed is an experimental plot that is burned annually in the Winter and exists to compare how burning in different seasons can affect ecological processes.

---

Author: David Hartnett, Scott Collins, Zak Ratajczak

ZIP file: knb.lter.knz.69.21

Data code: PVC02

File(s): PVC021.csv

Summary of changes:
- Pasture c01b was called Texas Hog (thp) in 2009. 
- Vegetation species composition from 1983: The transects were permanently laid out in the current format of 4 transects (A-D), each with 5 plots. 
- Transect E only occurred on watershed N20B florence in 1986 and 1987. This transect is the same as the current transect D for this watershed and soil type. 
- The old transect D was abandoned in 1987 prior to bison reintroduction. 
- Seven cover classes were used to estimate species canopy coverage. 1 - 0-1% cover; 2 - 2-5% cover; 3 - 5-25% cover; 4 - 25-50% cover; 5 - 50-75%; 6 - 75-95% cover; 7 - 95-100% cover. -(Note: for the watershed r20b, no data were collected in the transect A and B in the fall of 2011 due to wildfire occurred.) 
- Transect 'E' occurred only on the N20b florence site in 1986 and 1987 and was renamed the new 'transect' in 1988. 
- The old 'D' transect was sampled from 1983 to 1987 and then abandoned when the bison fence was constructed. 
- Thus, plots d1-d5 from 1983-1987 are NOT the same d1-d5 plots in subsequent years.

---

### Plants: Cleaning and organizing
```{r plants cleaning}
plants_raw <- read_csv("Datasets_EAGER/Plants/knb-lter-knz.69.21_SpeciesComposition/PVC021.csv")
plant_traits <- read_excel("Datasets_EAGER/Plants/Plant-Traits.xlsx")
plant_traits <- plant_traits[, 1:8]

plant_traits$growth_form <- dplyr::recode(plant_traits$growth_form,
                                          "p" = "perennial",
                                          "a" = "annual", 
                                          "b" = "biennial")
plant_traits$life_form <- dplyr::recode(plant_traits$life_form,
                                        "g" = "grass",
                                        "s" = "sedge",
                                        "m" = "monocot",
                                        "f" = "forb",
                                        "w" = "woody",
                                        "c" = "cryptogram",
                                        "o" = "other")

plant_traits$origin <- dplyr::recode(plant_traits$origin,
                                     "n" = "native",
                                     "i" = "introduced")

plant_traits <- plant_traits %>% rename("SpeCode" = "Konza_species_code") %>% mutate(SpeCode = factor(SpeCode))




watershed_info <- read_excel("Datasets_EAGER/Other/Watershed Info.xlsx")


unique(plants_raw$WaterShed)

plants_all <- plants_raw %>% mutate(WaterShed = factor(WaterShed),
                                Transect = factor(Transect),
                                Plot = factor(Plot),
                                SpeCode = factor(SpeCode))

#Combining the genus and species column and creating a new column, but also keeping the separate Genus and Spp columns
plants_all <- unite(plants_all, "Genus_spp", AB_genus:AB_species, sep = "_", remove = FALSE)

#Renaming the watersheds to make everything consistent
plants_all$WaterShed <- dplyr::recode(plants_all$WaterShed,
                                "001c" = "1C",
                                "001d" = "1D",
                                "004b" = "4B",
                                "020b" = "20B",
                                "n01b" = "N1B",
                                "n04d" = "N4D",
                                "n20b" = "N20B",
                                "002c" = "2C",
                                "002d" = "2D",
                                "004a" = "4A",
                                "004f" = "4F",
                                "n04a" = "N4A",
                                "n20a" = "N20A",
                                "020d" = "20D",
                                "n01a" = "N1A",
                                "00wb" = "WB",
                                "0spa" = "SpA",
                                "0spb" = "SpB",
                                "00fa" = "FA",
                                "00fb" = "FB",
                                "00wa" = "WA",
                                "0sua" = "SuA",
                                "0sub" = "SuB",
                                "001a" = "1A",
                                "020a" = "20A",
                                "r01a" = "R1A",
                                "r01b" = "R1B",
                                "r20a" = "R20A",
                                "r20b" = "R20B",
                                "n02a" = "N2A",
                                "n02b" = "N2B")

#Renaming some variables so there aren't weird capitalizations in the middle of the words
plants_all <- plants_all %>% rename("Watershed_name" = "WaterShed",
                                    "Recyear" = "RecYear",
                                    "Recmonth" = "RecMonth",
                                    "Recday" = "RecDay")

#Removing data pre-1992 since bison weren't introduced until then
plants <- plants_all %>% subset(.$Recyear >= 1992)

#Selecting only the watersheds and I will use for further analysis
plants <- plants %>%
  subset(Watershed_name %in% c("1D", "4A", "4B", 
                               "20B", "N1B", "N4A", 
                               "N4D", "N20B")) 

#Removing the observations that aren't identified down to species
plants <- subset(plants,!(Genus_spp %in% c("annual_forb", "carex_spp.", 
                                           "cyperu_spp.", "euphor_spp.", 
                                           "symphy_spp.")))

#There is one entry in Genus_spp that is capitalized, so I am changing it match everything else
plants$Genus_spp<- dplyr::recode(plants$Genus_spp,
                                 "Lithos_occid" = "lithos_occid")

plant_codes <- plants %>% dplyr::select(SpeCode, Genus_spp) %>% rename("Species" = "Genus_spp")
plant_codes <- unique(plant_codes)


```

### Plants: Presence/Absence & Classification
```{r plants pa}
#Selecting the columns I want for further analysis 
plants_group <- plants %>% 
  group_by(Recyear, Genus_spp, Watershed_name) %>% 
  reframe(Cover = sum(Cover))

#Pivoting the the dataset wider, so that each species is its own column and each row is a year and watershed. This is to populate the dataset with NA's (which will become zeroes) for each species in each year. If species weren't observed, they weren't recorded, but we still want that to count as an absence, so it needs to represented in the dataset.
plants_wide <- plants_group %>% 
  pivot_wider(names_from = "Genus_spp", values_from = "Cover", 
              values_fn = function(x) paste(sum(x)))


#Creating a dataset with species and watershed as rows and years as columns. This is the format I need for the getTrends function
plants_years_wide <- plants_wide %>% pivot_longer(cols = -c(1:2), 
                                                names_to = "Species", 
                                                values_to = "Cover") %>% 
  pivot_wider(names_from = factor("Recyear"), 
              values_from = "Cover")

#Combining the species and watershed variables to create a unique identifier for each row
plants_years_wide <- plants_years_wide %>% 
  unite("Species.watershed", Species:Watershed_name, sep = ".")

#Creating a separate species.watershed dataframe to add back to the dataset after standardization
plants_env <- plants_years_wide[, 1]


#Standardizing by presence/absence
decostand_plants_pa <- decostand(plants_years_wide[, -c(1)], "pa", na.rm = FALSE)
#Making all NA's zeroes; NA's are entries in which no data was collected, thus are absent/0
decostand_plants_pa[is.na(decostand_plants_pa)] <- 0


#Transforming the presence/absence data into a matrix so I can feed it to the function
plants_pa_matrix <- as.matrix(decostand_plants_pa)

#Applying the getTrends function to each row of the presence/absence matrix
plants_trends <- apply(plants_pa_matrix, 1, FUN = getTrends)
plants_trends2.0 <- apply(plants_pa_matrix, 1, FUN = getTrends2.0)
plants_trends2.5 <- apply(plants_pa_matrix, 1, FUN = getTrends2.5)
plants_trends3.0 <- apply(plants_pa_matrix, 1, FUN = getTrends3.0)

#Creating a table with the species.watershed and the Trends info. I excluded the bsline info.
plants_classification <- tibble((plants_env), do.call(rbind,lapply(plants_trends,(function(v){v[c(1,2,3,4,5,6,7,8,9)]}))),
do.call(rbind,lapply(plants_trends2.0,(function(v){v[c(9)]}))),
do.call(rbind,lapply(plants_trends2.5,(function(v){v[c(9)]}))),
do.call(rbind,lapply(plants_trends3.0,(function(v){v[c(9)]}))))


#Adding in the presence/absence per year data back in 
plants_class <- plants_classification %>% add_column(decostand_plants_pa, .before = "chi_pval")

#Separating the species and watershed variable names for graphing later
plants_class <- plants_class %>% separate(Species.watershed, c("Genus", "Spp", "Watershed_name")) %>% unite("Species", Genus:Spp, sep = "_")

plants_class <- left_join(plants_class, disturbance, by = "Watershed_name")

#Pivoting longer so that each row is now a year, species, watershed, etc.
plants_class_long <- plants_class %>% pivot_longer(cols = "1992":"2022", 
                                                 names_to = "Recyear", 
                                                 values_to = "Presence")

```

### Plants: Exploration Plots

```{r plants exploration plots}

plants_graphing <- plants_class_long

plants_graphing <- left_join(plants_graphing, plant_codes, by = "Species")
plants_graphing <- left_join(plants_graphing, plant_traits, by = "SpeCode")
#Making all presence = "0" inti NA's so they don't show up in the graph
plants_graphing$Presence[plants_graphing$Presence == 0] <- NA

#Making the years numeric instead of characters
plants_graphing <- plants_graphing %>% mutate(Recyear = as.character(Recyear))
plants_graphing <- plants_graphing %>% mutate(Recyear = as.numeric(Recyear))

#Changing the order of the watersheds so that the grazing and non-grazing watersheds of the same burn interval are next to each other
plants_graphing$Watershed_name <- factor(plants_graphing$Watershed_name,
                                levels = c("1D", "N1B", "4B", 
                                           "4F", "N4A", "N4D", 
                                           "20B", "N20B"))


plants_graphing$category <- factor(plants_graphing$category, 
                               levels = c("No_change-absent", "No_change-present", 
                                          "Random", "Recurrent", "Increasing", 
                                          "Decreasing"))

plants_class_graphing <- plants_classification %>% pivot_longer(cols = "category":"category3.0",
                                                                    names_to = "function_type",
                                                                    values_to = "classification")


  
plants_class_graphing <- plants_class_graphing %>% group_by(function_type, classification) %>% dplyr::summarise(total_count=n(),.groups = 'drop')

plants_class_graphing <- plants_class_graphing %>% mutate(Proportion = (total_count/2600))
plants_class_graphing3.0 <- plants_class_graphing %>% subset(function_type == "category3.0")

plants_class_graphing3.0$classification <- factor(plants_class_graphing3.0$classification,
                                        levels = c("No_change-absent", 
                                                   "No_change-present", 
                                                   "Recurrent", "Random", "Increasing", "Decreasing"))

plants_traits_graphing <- left_join(plants_class, plant_codes, by = "Species")
plants_traits_graphing <-  left_join(plants_traits_graphing, plant_traits, by = "SpeCode")
  
plants_lf_graphing <- plants_traits_graphing %>% group_by(life_form, category3.0) %>% dplyr::summarise(total_count=n(),.groups = 'drop')


plants_lf_graphing$category3.0 <- factor(plants_lf_graphing$category3.0,
                                        levels = c("No_change-absent",
                                                   "No_change-present", 
                                                   "Recurrent", "Random", "Increasing", "Decreasing"))

plants_origin_graphing <- plants_traits_graphing %>% group_by(origin, category3.0) %>% dplyr::summarise(total_count=n(),.groups = 'drop')
plants_origin_graphing$category3.0 <- factor(plants_origin_graphing$category3.0,
                                        levels = c("No_change-absent",
                                                   "No_change-present", 
                                                   "Recurrent", "Random", "Increasing", "Decreasing"))

plants_gf_graphing <- plants_traits_graphing %>% group_by(growth_form, Watershed_name, category3.0) %>% dplyr::summarise(total_count=n(),.groups = 'drop')
plants_gf_graphing$category3.0 <- factor(plants_gf_graphing$category3.0,
                                        levels = c("No_change-absent",
                                                   "No_change-present", 
                                                   "Recurrent", "Random", "Increasing", "Decreasing"))

plants_idk <- plants_class %>% group_by(Disturbance, category3.0) %>% dplyr::summarise(total_count=n(),.groups = 'drop') %>% mutate(Proportion = (total_count/325))

plants_idk$category3.0 <- factor(plants_idk$category3.0,
                                        levels = c("No_change-absent",
                                                   "No_change-present", 
                                                   "Recurrent", "Random", "Increasing", "Decreasing"))

plants_idk$Disturbance <- factor(plants_idk$Disturbance,
                                levels = c("1year_Ungrazed_D", "4year_Ungrazed_A", "4year_Ungrazed_B", "20year_Ungrazed_B", "1year_Bison_B", "4year_Bison_A", "4year_Bison_D", "20year_Bison_B"))



plants_idk %>% ggplot(aes(x = category3.0, y = Proportion, fill = category3.0)) + geom_col() + 
  scale_fill_manual(values = c("lightgray","#000000", "#CC79A7", "#0072B2", "#009E73", "#D55E00")) +
  facet_wrap(.~Disturbance, nrow=2, ncol=4) +
  theme_bw() +
  theme(text = element_text(size=14), 
        axis.text.x = element_text(angle=90, hjust=1)) +
  labs(title= "Proportion of Plant Species in Each Incidence Classification for Each Watershed", 
       x = "Classification", 
       y = "Proportion of Species", 
       fill = "Classification")

plants_lf_graphing %>% ggplot(aes(x = category3.0, y = total_count, fill = category3.0)) + geom_col() + 
  scale_fill_manual(values = c("gray","black", "darkorchid", "dodgerblue2", "darkolivegreen4", "firebrick")) +
  facet_wrap(.~life_form) +
  theme(text = element_text(size=14), 
        axis.text.x = element_text(angle=90, hjust=1)) +
  labs(title= "Number of Plant Species in Each Incidence Classification for Each Life Form", 
       x = "Classification", 
       y = "Number of Species", 
       fill = "Classification")

plants_origin_graphing %>% ggplot(aes(x = category3.0, y = total_count, fill = category3.0)) + geom_col() + 
  scale_fill_manual(values = c("gray","black", "darkorchid", "dodgerblue2", "darkolivegreen4", "firebrick")) +
  facet_wrap(.~origin) +
  theme(text = element_text(size=14), 
        axis.text.x = element_text(angle=90, hjust=1)) +
  labs(title= "Number of Plant Species in Each Incidence Classification for Native vs Introduced Species", 
       x = "Classification", 
       y = "Number of Species", 
       fill = "Classification")

plants_gf_graphing %>% ggplot(aes(x = category3.0, y = total_count, fill = category3.0)) + geom_col() + 
  scale_fill_manual(values = c("gray","black", "darkorchid", "dodgerblue2", "darkolivegreen4", "firebrick")) +
  facet_grid(Watershed_name~growth_form) +
  theme(text = element_text(size=14), 
        axis.text.x = element_text(angle=90, hjust=1)) +
  labs(title= "Number of Plant Species in Each Incidence Classification for Each Growth Form", 
       x = "Classification", 
       y = "Number of Species", 
       fill = "Classification")

plants_class_graphing3.0 %>% ggplot(aes(x = classification, y = Proportion, fill = classification)) + geom_col() + scale_fill_manual(values = c("lightgray","#000000", "#CC79A7", "#0072B2", "#009E73", "#D55E00")) +
  theme_bw() +
  theme(text = element_text(size=14), 
        axis.text.x = element_text(angle=45, hjust=1)) +
  labs(title= "Proportion of Grasshoppers Species in Each Incidence Classification", 
       x = "Classification", 
       y = "Proportion of Species", 
       fill = "Classifcation")


plants_graphing_directed <- plants_graphing %>% subset(category3.0 %in% c("Increasing","Decreasing"))
length(unique(plants_graphing_directed$Species))

plants_graphing_increasing <- plants_graphing %>% subset(category3.0 == "Increasing")
length(unique(plants_graphing_increasing$Species))

plants_graphing_decreasing <- plants_graphing %>% subset(category3.0 == "Decreasing")
length(unique(plants_graphing_decreasing$Species))
