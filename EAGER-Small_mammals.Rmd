---
title: "EAGER-Small_mammals"
author: "Maya Parker-Smith"
date: "2023-04-11"
output: html_document
 smart: no
    theme: flatly
    float: yes
    css: "style.css"    
editor_options: 
  chunk_output_type: console
mainfont: Arial
mathfont: Arial
fontsize: 12pt
---

```{r setup, include=FALSE}
## Clear environment 
rm(list=ls())


##Libraries
library(tidyverse)
library(cowplot)
library(bbmle)
library(lmerTest)
library(car)
library(readxl)
library(multcomp)
library(readr)
library(incidence)
library(vegan)
library(goeveg)
library(randtests)
library(reshape2)
```

##Small-mammal trapping
This section is dedicated to cleaning the small-mammal trapping dataset. Data was collected from 1981 to 2013. Watersheds that are supposedly included: 4B, 4F, N4D, N20B, 1D, 20B, N1B.

Author: Donald Kaufman

ZIP file: knb-lter-knz.88.9

Data code: CSM01

File(s): CSM011.csv, CSM012.csv

During winter 1981-1982, the Konza Prairie management committee shifted treatment boundaries, so our traplines in N00D were encompassed in the new boundaries of N01D. Therefore, we established two new traplines in another treatment unit (N00B) in spring 1982.
In autumn 1984, four new traplines were established with two traplines in 002C and two in 002D (24 total sampling lines). 
Four more traplines were added in autumn 1985 with two in 010D and two in 001A (28 total sampling lines). 
After 1987, summer sampling was discontinued because of the intensive labor required to close traps in the morning and open traps in late afternoon each day on each trapline in each trapping period.
In 1988, Konza Prairie management committee changed unburned research treatments to treatments with a 20-year frequency of occurrence of fire and, therefore, 000B and N00B became 020B and N20B, respectively. 
The treatment units (N01B and N04D) remained unburned from 1968 until spring 1988 when annual burning was initiated on N01B and the 4-year cycle was initiated on N04D.
Spring fires occurred after our trapping session in these and other treatment units. 
N20B was not burned in 1988, but it had been burned in 1980. 
Before the spring sampling period in 1989, the number of traplines sampled was reduced from 28 traplines to 14; the 14 traplines remaining included two traplines in each of seven experimental treatments (001D, 004B, 004F, 020B, N01B, N04D and N20B).
In addition, a second ungrazed 4-year fire treatment (004F) was continued to help monitor climatic effects on small mammals in prairie experiencing periodic fires
Data for small mammals captured on traplines that were discontinued (001A, 002C, 002D, 004D, 004G, 010A and 010D) can be found in CSM06
In May 1992, gates were opened between phase I and phase II of the bison area. N01B, N04D and N20B lie within the phase II area. 
All sampling periods from autumn 1981 through spring 1992 on these three treatment units occurred on traplines that had not been grazed by bison.


```{r}
#Seasonal summaries of small mammals on LTER traplines 
smallmammals_raw <- read_csv("Datasets_EAGER/Small_mammals/knb-lter-knz.88.9_FourteenTraplines/CSM011.csv")

#Table including the watershed info for all watersheds
watershed_info <- read_excel("Datasets_EAGER/Other/Watershed Info.xlsx")


#Making some the columns "factors" for later manipulation and analysis
smallmammals <- smallmammals_raw %>% mutate(SEASON = factor(SEASON),
                                          `WATERSHED/LINE` = factor(`WATERSHED/LINE`)) 



#Separating the watershed/line column into two separate columns
smallmammals <- separate(smallmammals, 
                                      `WATERSHED/LINE`, 
                                      into = c("WATERSHED", "LINE"), 
                                      sep = "-")


#Renaming columns just so that they're not all capitalized
smallmammals <- smallmammals %>% rename("Watershed_name" = "WATERSHED",
                                        "Datacode" = "DATACODE",
                                        "Rectype" = "RECTYPE",
                                        "Recyear" = "RECYEAR",
                                        "Season" = "SEASON",
                                        "Line" = "LINE")

#Shortening the names of the watersheds
smallmammals$Watershed_name <- dplyr::recode(smallmammals$Watershed_name,
                                       "004F" = "4F",
                                       "004B" = "4B",
                                       "001D" = "1D",
                                       "020B" = "20B",
                                       "N20B" = "N20B",
                                       "N01B" = "N1B",
                                       "N04D" = "N4D")



#Pivoting the table so that each species is a column and each species per year is a different row
smallmammals_long <- pivot_longer(smallmammals, 
                                          cols = 8:21, names_to = "Species", 
                                          values_to = "Count")

#Renaming the species into their full names
smallmammals_long$Species <- dplyr::recode(smallmammals_long$Species,
                                     "Pm" = "Peromyscus_maniculatus",
                                     "Rmeg" = "Reithrodontomys_megalotis",
                                     "Sh" = "Sigmodon_hispidus",
                                     "Bh" = "Blarina_hylophaga",
                                     "Rmon" = "Reithrodontomys_montanus",
                                     "St" = "Spermophilus_tridecemlineatus",
                                     "Mo" = "Microtus_ochrogaster",
                                     "Pl" = "Peromyscus_leucopus",
                                     "Ch" = "Chaetodipus_hispidus",
                                     "Mm" = "Mus_musculus",
                                     "Nf" = "Neotoma_floridana",
                                     "Sc" = "Synaptomys_cooperi",
                                     "Zh" = "Zapus_hudsonius",
                                     "Cp" = "Cryptotis_parva")



#Joining the watershed_info dataset with the actual small mammal dataset
smallmammals_long1 <- left_join(smallmammals_long, watershed_info, by = "Watershed_name")


#Making variables factors
smallmammals_long1 <- smallmammals_long1 %>% mutate(Fire_interval = factor(Fire_interval),
                                                    Burn_season = factor(Burn_season),
                                                    Grazing = factor(Grazing),
                                                    Watershed_name = factor(Watershed_name),
                                                    Line = factor(Line))


#Changing the order of the fire_interval and grazing treatments for graphing reasons later on
smallmammals_long1$Fire_interval <- factor(smallmammals_long1$Fire_interval, 
                                           levels = c("1_year", "4_years", "20_years"))

smallmammals_long1$Grazing <- factor(smallmammals_long1$Grazing,
                                     levels = c("Ungrazed", "Bison"))

#Separate the dataset from 1992 onwards. 
smallmammals_long1 <- smallmammals_long1 %>% subset(.$Recyear >= 1992)


#Since likely won't differentiate the data based on the traplines, I am summing the data based on just watershed
smallmammals_long1 <- smallmammals_long1 %>% group_by(Recyear, Watershed_name, 
                                                      Species, Fire_interval, Grazing) %>% 
  reframe(Count = sum(Count))

#Removing the 4F watershed to make sampling between all fire/grazing treatments equal (the 4 year fire interval with no grazing combination of disturbances has two watersheds represented, while all other combinations have just one).
####smallmammals_long1 <- smallmammals_long1 %>% subset(Watershed_name != "4F")

```



```{r}
#Making dissimilarity matrices for the watersheds - abundance

#Selecting only necessary columns, 
smallmammals2 <- smallmammals_long1 %>% 
  group_by(Watershed_name, Fire_interval, Grazing, Species) %>% 
  reframe(Total = sum(Count))

#Pivoting the the dataset wider 
smallmammals2_wide <- smallmammals2 %>% 
  pivot_wider(names_from = "Species", values_from = "Total", 
              values_fn = function(x) paste(sum(x)))


smallmammals2_wide <- smallmammals2 %>% 
  pivot_wider(names_from = "Species", values_from = "Total", 
              values_fn = function(x) paste(sum(x)))

#Making an environment dataset with the classifying variables
smallmammals2_wide_env <- smallmammals2_wide[, c(1:3)]

#Removing the classifying variables for the dissimilarity analysis
smallmammals2_wide1 <- smallmammals2_wide[, -c(1:3)]



#Making the values numeric instead of characters
smallmammals2_wide1 <- smallmammals2_wide1 %>% mutate_if(is.character, as.numeric)

#Standardizing for the total abundance by watershed
decostand_tot_smallmammals <- decostand(smallmammals2_wide1, method = "total")

#Creating the dissimilarity matrix
diss_matrix <- vegdist(decostand_tot_smallmammals, method = "bray")

```


```{r}

#Selecting only necessary columns and creating a new dataset
smallmammals_short <- smallmammals_long1 


#Pivoting the the dataset wider, so that each species is its own column
smallmammals_wide <- smallmammals_short %>% 
  pivot_wider(names_from = "Species", values_from = "Count", 
              values_fn = function(x) paste(sum(x)))

#Making an environment table to add back onto the presence/absence data later
smallmammals_env <- smallmammals_wide[, 1:4]

#Standardizing by presence/absence
decostand_pa_smallmammals <- decostand(smallmammals_wide[, -c(1:4)], "pa", na.rm = TRUE )


#Checking the stress of this presence/absence data
dimcheckMDS(decostand_pa_smallmammals, distance = "jaccard", k=5)


#Adding the presence/absence dataset back with the enviornment dataset
smallmammals_wide2 <- decostand_pa_smallmammals %>% add_column(smallmammals_env, .before = "Blarina_hylophaga")

#Pivoting the presence/absence back to a longer format
smallmammals_long2 <- smallmammals_wide2 %>% pivot_longer(cols = 5:18, 
                                                          names_to = "Species", 
                                                          values_to = "Presence")

#Making sure the species are coded as factors
smallmammals_long2 <- smallmammals_long2 %>% mutate(Species = factor(Species))

```



```{r}

#Creating another dataset by species and years to calculate persistence
smallmammals_years_wide <- smallmammals_long2 %>% 
  pivot_wider(names_from = "Recyear", values_from = "Presence")

#Making NA's zeroes... MIGHT HAVE TO UNDO THIS
smallmammals_years_wide2 <-smallmammals_years_wide %>% 
  mutate_all(~replace(., is.na(.), 0))

#Summing the persistence of all years into a new column
smallmammals_years_wide2 <- smallmammals_years_wide2 %>% 
  mutate(Total_Persistence = rowSums(smallmammals_years_wide2[, 5:26]))


smallmammals_years_wide2 <- smallmammals_years_wide2 %>% 
  mutate(Persistence = (.$Total_Persistence/22))

#Just getting a table to show the species persistence by fire-interval, grazing, and years total
Persistence_table <- smallmammals_years_wide2 %>% 
  group_by(Fire_interval, Grazing, Species) %>% 
  dplyr::reframe(Persistence = sum(Persistence))



#Plotting persistence in a simple bar graph
smallmammals_years_wide2 %>% ggplot(aes(x = Species, y = Persistence, fill = Species)) + 
  geom_col() +  
  facet_grid(Grazing~Fire_interval) +
  theme(text = element_text(size=10))+
  theme(axis.text.x = element_text(angle=45, hjust=1, size = 10)) 


```



```{r}

smallmammals_long2 %>% ggplot(aes(x = Recyear, y = factor(Presence), fill = factor(Presence))) + 
  geom_tile(width = .9, height = .9) + 
  facet_grid(Species~Grazing~Fire_interval, switch = "y") +
  theme(text = element_text(size=10),
        axis.text.x = element_text(angle=45, hjust=1, size =7),
        axis.text.y = element_text(size=7),
        strip.text.y.left = element_text(angle = 0)) +
  scale_fill_manual(values = c("white", "black")) 


smallmammals_long5 %>% ggplot(aes(x = Recyear, y = factor(Presence), fill = factor(Presence))) + 
  geom_tile(width = .9, height = .9) + 
  facet_grid(Species~Grazing~Fire_interval, switch = "y") +
  theme(text = element_text(size=10),
        axis.text.x = element_text(angle=45, hjust=1, size =7),
        axis.text.y = element_text(size=7),
        strip.text.y.left = element_text(angle = 0)) +
  scale_fill_manual(values = c("NA", "black")) +
  geom_vline(xintercept = 2002.5) +
  labs(x = "Year", y = "Presence", fill = "Presence")

smallmammals_long5 <- smallmammals_long2
smallmammals_long5 <- smallmammals_long5 %>% mutate(Recyear = as.numeric(Recyear))


```

```{r}

#Alright this section is for trying the contingency table and chi-square and Wald-Wolfowitz runs test. But I dunno what I'm doing so I am just hoping for the best now. 

#Species incidence classification is determined by combined results from a contingency table with a chi-squared test and a runs test (Figs 3-4; ,8). Species present in all years are assigned “no change” and their sequential incidences are not tested. The following steps will be completed on each sample-based rarefaction run of each assemblage, and values will be compared to ensure that classification is robust to sampling error.
#Looking at the amount of time data was collected for each watershed, in each year, and in each month.

#Okay so what am I exactly trying to figure out... So I want to see how species occurrence changes throughout time. So I wonder if I use the persistence numbers to tie into incidence. Hmmmmm... a chi-square test tests whether two variables are independent of each other. So what does that mean for what I am doing? Looking at the project proposal, it looks like I am going through each individal species (so not comparing species yet), then 


#Okay so I think I need to make a contingency table by splitting the time series into early/late and presence/absence 

#Making a new dataset just in case
smallmammals_cont <- smallmammals_long2 

#Adding empty columns onto new dataset
smallmammals_cont <- smallmammals_cont %>% mutate(Presence_cont = NA,
                                                  Early_late = NA,
                                                  Presence = factor(Presence))


smallmammals_cont <- smallmammals_cont %>% group_by(Species) %>% mutate(id=cur_group_id()) 


#Filling presence contingency column based on presence/absence
 for(j in 1:nrow(smallmammals_cont)){
   if (smallmammals_cont[j,6] == "1"){smallmammals_cont[j,7] <- "Present"}
   if (smallmammals_cont[j,6] == "0"){smallmammals_cont[j,7] <- "Absent"}
 } 

#Filling early/late contingency based on year
for(i in 1:nrow(smallmammals_cont)){
   if (smallmammals_cont[i,1] < 2003){smallmammals_cont[i,8] <- "Early"}
   if (smallmammals_cont[i,1] >= 2003){smallmammals_cont[i,8] <- "Late"}
}

smallmammals_cont <- smallmammals_cont %>% mutate(Presence_cont = factor(Presence_cont),
                                                  Early_late = factor(Early_late))
# list <- list()
#   
# for(i in 1:length(unique(smallmammals_cont$id))){
#   filtered <- subset(smallmammals_cont,id==i) 
#   list[[i]] <- filtered
#   if (smallmammals_cont[i,2] == "1D"){table(smallmammals_cont$Presence_cont, smallmammals_cont$Early_late)}
#   
# }
# list[[1]]
# 
# 
# for (i in 1:length(smallmammals_cont)){
#   smallmammals_cont %>% 
#   group_by(across((id)))%>%
#     group_by(across(Watershed_name)) %>%
#     dplyr::count(.$Presence_cont, .$Early_late)
# }
# 
view(smallmammals_cont)

summary_tbl2 <- smallmammals_cont %>%
  group_by(Species, Watershed_name)%>%
    dplyr::count(Presence_cont, Early_late)

summary_tbl2 <- summary_tbl2 %>% unite("Species_Watershed", Species:Watershed_name, sep = "_") 
summary_tbl2 <- summary_tbl2 %>% mutate(Species_Watershed = factor(Species_Watershed))

contabs <- xtabs(n ~ Presence_cont + Early_late + Species_Watershed, summary_tbl2)
chisqtests <- apply(contabs, 3, chisq.test)
chisq_p.values <- tibble(names(chisqtests), do.call(rbind,lapply(chisqtests,function(v){v$p.value})))


chisq_p.values <- chisq_p.values %>% rename("chisq_p.values" = "do.call(...)",
                                            "Species_watershed" = "names(chisqtests)")


```


```{r}
#Okay now I am going to try and figure out the slopes for the species so I can determine if things are increasing or decreasing?


smallmammals_long4 <- smallmammals_long2 %>% 
  group_by(Recyear, Species, Watershed_name) %>% reframe(Presence = Presence) %>%
  unite("Species_Watershed", Species:Watershed_name, sep = "_")

grouped4 <- smallmammals_long4 %>% group_by(Recyear, Species_Watershed) %>% reframe(Presence = Presence)



presence.tabs <- xtabs(Presence ~ Recyear + Species_Watershed, smallmammals_long4)
runstests <- apply(presence.tabs, 2, runs.test)
runstest_p.values <- tibble(names(runstests), do.call(rbind,lapply(runstests,function(v){v$p.value})))
runstest_p.values <- runstest_p.values %>% rename("runstest_p.values" = "do.call(...)",
                                                  "Species_watershed" = "names(runstests)")


merged_p.values <- merge(chisq_p.values,runstest_p.values, by = "Species_watershed", all = TRUE)

chisq_p.values <- chisq_p.values %>% mutate(Incidence_change = NA)




merged_p.values1 <- merged_p.values %>% separate(Species_watershed, into = c("Species", "spp", "Watershed_name")) %>% 
  unite("Species", Species, spp)

merged_p.values1 <- left_join(merged_p.values1, watershed_info, by = "Watershed_name")




merged_p.values2 <- merged_p.values1
merged_p.values2 <- merged_p.values2 %>% mutate(Incidence_change = NA,
                                          Sequential_patterns = NA)

for (k in 1:nrow(merged_p.values2)){
  if (is.nan(merged_p.values2$chisq_p.values[k])) {merged_p.values2$chisq_p.values[k] <- 2}
  if (is.nan(merged_p.values2$runstest_p.values[k])) {merged_p.values2$runstest_p.values[k] <- 2}
}

merged_p.values3 <- merged_p.values2

for (kk in 1:nrow(merged_p.values3)){
  if (merged_p.values3[kk, 3] == 2){merged_p.values3[kk, 9] <- "-"}
  if (merged_p.values3[kk, 3] <= 0.05){merged_p.values3[kk, 9] <- "Significant"}
  if (merged_p.values3[kk, 3] > 0.05 & merged_p.values3[kk, 3] < 2){merged_p.values3[kk, 9] <- "NS"}
  if (merged_p.values3[kk, 4] == 2){merged_p.values3[kk, 10] <- "-"}
  if (merged_p.values3[kk, 4] <= 0.05){merged_p.values3[kk, 10] <- "Significant"}
  if (merged_p.values3[kk, 4] > 0.05 & merged_p.values3[kk, 4] < 2){merged_p.values3[kk, 10] <- "NS"}
}


merged_p.values3 <- merged_p.values3 %>% mutate(Classification = NA)

for (jj in 1:nrow(merged_p.values3)){
  if (merged_p.values3[jj, 9] == "-" & merged_p.values3[jj, 10] == "-"){merged_p.values3[jj, 11] <- "No_change"}
  if (merged_p.values3[jj, 9] == "NS" & merged_p.values3[jj, 10] == "NS"){merged_p.values3[jj, 11] <- "Random"}
  if (merged_p.values3[jj, 9] == "NS" & merged_p.values3[jj, 10] == "Significant"){merged_p.values3[jj, 11] <- "Recurrent"}
  if (merged_p.values3[jj, 9] == "Significant" & merged_p.values3[jj, 10] == "-"){merged_p.values3[jj, 11] <- "Increasing"}
  if (merged_p.values3[jj, 9] == "NS" & merged_p.values3[jj, 10] == "-"){merged_p.values3[jj, 11] <- "Random"}
}
  
for (ii in 1:nrow(merged_p.values3)){
  if (merged_p.values3[ii, 3] == 2) {merged_p.values3$chisq_p.values[ii] <- NA}
  if (merged_p.values3[ii, 4] == 2) {merged_p.values3$runstest_p.values[ii] <- NA}
}

sum(merged_p.values3$Classification == "No_change") / 84
sum(merged_p.values3$Classification == "Random") / 84
sum(merged_p.values3$Classification == "Recurrent") / 84
sum(merged_p.values3$Classification == "Increasing") / 84


merged_p.values_grouped <- merged_p.values3 %>% group_by(Fire_interval, Grazing, Classification) %>%
  dplyr::reframe(Class_count = n())

merged_p.values_grouped <- merged_p.values_grouped %>% mutate(Proportion_count = Class_count/(sum(Class_count)))

merged_p.values_grouped %>% 
  ggplot(aes(x = Classification, y = , group = Classification, fill = Classification)) + 
  geom_tile(width = .9, height = .9) + 
  facet_grid(Grazing~Fire_interval) +
  theme(text = element_text(size=10),
        axis.text.x = element_text(angle=45, hjust=1, size =7),
        axis.text.y = element_text(size=7),
        strip.text.y.left = element_text(angle = 0)) 

sum(merged_p.values_grouped$Class_count)


smallmammals_wclassification <- left_join(smallmammals_long2, merged_p.values3, 
                                          by = c("Species", "Watershed_name", "Fire_interval", "Grazing"))


smallmammals_wclassification1 <- smallmammals_wclassification


for (p in 1:nrow(smallmammals_wclassification1)){
  if (smallmammals_wclassification1[p, 6] == 0) {smallmammals_wclassification1$Presence[[p]] <- NA}
}
  

smallmammals_wclassification1$Fire_interval <- factor(smallmammals_wclassification1$Fire_interval, 
                                           levels = c("1_year", "4_years", "20_years"))

smallmammals_wclassification1$Grazing <- factor(smallmammals_wclassification1$Grazing,
                                     levels = c("Ungrazed", "Bison"))
  

smallmammals_wclassification2 <- smallmammals_wclassification1

smallmammals_wclassification2 <- smallmammals_wclassification2 %>% mutate(Presence = factor(Presence))  
smallmammals_wclassification2 <- smallmammals_wclassification2 %>% mutate(Recyear = as.character(Recyear))
smallmammals_wclassification2 <- smallmammals_wclassification2 %>% mutate(Recyear = as.numeric(Recyear))
  
smallmammals_wclassification2 %>% ggplot(aes(x = Recyear, y = Presence, fill = Classification)) + 
  geom_tile(width = .9, height = .9) + 
  facet_grid(Species~Grazing~Fire_interval, switch = "y") +
  theme(text = element_text(size=10),
        axis.text.x = element_text(angle=45, hjust=1, size =7),
        axis.text.y = element_text(size=7),
        strip.text.y.left = element_text(angle = 0)) +
  geom_vline(xintercept = 2002.5) +
  labs(x = "Year", y = "Presence", title = "Small mammals: incidence classification by species") 


# lm(Count ~ cbind(Recyear, Species_Watershed), abund.tabs)
# 
# 
# lm(Count ~ Recyear, blahyl_1D) %>% summary()
# pkr::Slope(blahyl_1D$Recyear, blahyl_1D$Count)
# 
# 
# apply(abund.tabs, 1, function(x) lm(x[2] ~ x[1]))
# apply(grouped4, 1, function(x) lm(x[3]~x[1])$coefficients)


```








# smallmammals_cont_1D <- smallmammals_cont %>% filter(.$Watershed_name == "1D")
# smallmammals_cont_4B <- smallmammals_cont %>% filter(.$Watershed_name == "4B")
# smallmammals_cont_20B <- smallmammals_cont %>% filter(.$Watershed_name == "20B")
# smallmammals_cont_N1B <- smallmammals_cont %>% filter(.$Watershed_name == "N1B")
# smallmammals_cont_N4D <- smallmammals_cont %>% filter(.$Watershed_name == "N4D")
# smallmammals_cont_N20B <- smallmammals_cont %>% filter(.$Watershed_name == "N20B")
# 
# smallmammals_cont %>% cbind(.$Presence_cont, .$Early_late)
# 
# chahis_1D <- smallmammals_cont_1D %>% 
#   filter(Species == "Chaetodipus_hispidus") %>% 
#   dplyr::add_count(.$Presence_cont,
#                .$Early_late)
# 
# chahis_4B <- smallmammals_cont_4B %>% 
#   filter(Species == "Chaetodipus_hispidus") %>%
#   dplyr::add_count(.$Presence_cont,
#                    .$Early_late)
# 
# smallmammals_cont_1D_blahyl <- smallmammals_cont %>% filter(.$Watershed_name == "1D" & .$Species == "Blarina_hylophaga")
# smallmammals_cont_1D_chahis <- smallmammals_cont %>% filter(.$Watershed_name == "1D" & .$Species == "Chaetodipus_hispidus")
# smallmammals_cont_4B_chahis <- smallmammals_cont %>% filter(.$Watershed_name == "4B" & .$Species == "Chaetodipus_hispidus")
# smallmammals_cont_20B_chahis <- smallmammals_cont %>% filter(.$Watershed_name == "20B" & .$Species == "Chaetodipus_hispidus")
# smallmammals_cont_N1B_chahis <- smallmammals_cont %>% filter(.$Watershed_name == "N1B" & .$Species == "Chaetodipus_hispidus")
# smallmammals_cont_N4D_chahis <- smallmammals_cont %>% filter(.$Watershed_name == "N4D" & .$Species == "Chaetodipus_hispidus")
# smallmammals_cont_N20B_chahis <- smallmammals_cont %>% filter(.$Watershed_name == "N20B" & .$Species == "Chaetodipus_hispidus")
# 
# table(smallmammals_cont_N20B_chahis$Presence_cont, smallmammals_cont_N20B_chahis$Early_late)
# chahis <- smallmammals_cont %>% filter(smallmammals_cont$Species == "Chaetodipus_hispidus")
# blahyl <- smallmammals_cont %>% filter(smallmammals_cont$Species == "Blarina_hylophaga")
# crypar <- smallmammals_cont %>% filter(smallmammals_cont$Species == "Cryptotis_parva")
# micoch <- smallmammals_cont %>% filter(smallmammals_cont$Species == "Microtus_ochrogaster")
# musmus <- smallmammals_cont %>% filter(smallmammals_cont$Species == "Mus_musculus")
# neoflo <- smallmammals_cont %>% filter(smallmammals_cont$Species == "Neotoma_floridana")
# perleu <- smallmammals_cont %>% filter(smallmammals_cont$Species == "Peromyscus_leucopus")
# perman <- smallmammals_cont %>% filter(smallmammals_cont$Species == "Peromyscus_maniculatus")
# reimeg <- smallmammals_cont %>% filter(smallmammals_cont$Species == "Reithrodontomys_megalotis")
# reimon <- smallmammals_cont %>% filter(smallmammals_cont$Species == "Reithrodontomys_montanus")
# sighis <- smallmammals_cont %>% filter(smallmammals_cont$Species == "Sigmodon_hispidus")
# spetri <- smallmammals_cont %>% filter(smallmammals_cont$Species == "Spermophilus_tridecemlineatus")
# syncoo <- smallmammals_cont %>% filter(smallmammals_cont$Species == "Synaptomys_cooperi")
# zaphud <- smallmammals_cont %>% filter(smallmammals_cont$Species == "Zapus_hudsonius")
# 
# 
# table(chahis$Presence_cont, chahis$Early_late)
# chisq.test(chahis$Presence_cont, chahis$Early_late)
# 
# table(blahyl$Presence_cont, blahyl$Early_late)
# chisq.test(blahyl$Presence_cont, blahyl$Early_late)
# 
# table(crypar$Presence_cont, crypar$Early_late)
# chisq.test(crypar$Recyear, crypar$Presence_cont)
# 
# table(micoch$Presence_cont, micoch$Early_late)
# chisq.test(micoch$Presence_cont, micoch$Early_late)
# 
# table(musmus$Presence_cont, musmus$Early_late)
# chisq.test(musmus$Presence_cont, musmus$Early_late)
# 
# table(neoflo$Presence_cont, neoflo$Early_late)
# chisq.test(neoflo$Presence_cont, neoflo$Early_late)
# 
# table(perleu$Presence_cont, perleu$Early_late)
# chisq.test(perleu$Presence_cont, perleu$Early_late)
# 
# table(perman$Presence_cont, perman$Early_late)
# chisq.test(perman$Presence_cont, perman$Early_late)
# 
# table(reimeg$Presence_cont, reimeg$Early_late)
# chisq.test(reimeg$Presence_cont, reimeg$Early_late)
# 
# table(reimon$Presence_cont, reimon$Early_late)
# chisq.test(reimon$Presence_cont, reimon$Early_late)
# 
# table(sighis$Presence_cont, sighis$Early_late)
# chisq.test(sighis$Presence_cont, sighis$Early_late)
# 
# table(spetri$Presence_cont, spetri$Early_late)
# chisq.test(spetri$Presence_cont, spetri$Early_late)
# 
# table(syncoo$Presence_cont, syncoo$Early_late)
# chisq.test(syncoo$Presence_cont, syncoo$Early_late)
# 
# table(zaphud$Presence_cont, zaphud$Early_late)
# chisq.test(zaphud$Presence_cont, zaphud$Early_late)
# 
# 
# dcast(smallmammals_cont, Species ~ Watershed_name, fun.aggregate = count)
# 
# xtabs(cbind(Presence_cont, Early_late)~ Species + Watershed_name + Early_late, smallmammals_cont)
# 
# ConTab_1D <- table(smallmammals_cont_1D$Presence_cont, smallmammals_cont_1D$Early_late)
# ConTab_4B <- table(smallmammals_cont_4B$Presence_cont, smallmammals_cont_4B$Early_late)
# ConTab_20B <- table(smallmammals_cont_20B$Presence_cont, smallmammals_cont_20B$Early_late)
# ConTab_N1B <- table(smallmammals_cont_N1B$Presence_cont, smallmammals_cont_N1B$Early_late)
# ConTab_N4D <- table(smallmammals_cont_N4D$Presence_cont, smallmammals_cont_N4D$Early_late)
# ConTab_N20B <- table(smallmammals_cont_N20B$Presence_cont, smallmammals_cont_N20B$Early_late)
# 
# ConTab_1D_blahyl <- table(smallmammals_cont_1D_blahyl$Presence_cont, smallmammals_cont_1D_blahyl$Early_late)
# 
# chisq.test(smallmammals_cont_N20B_chahis$Presence_cont, smallmammals_cont_N20B_chahis$Early_late)
# 
# 
# 
# 
# 
# runs.test(blahyl_1.ungrazed$Count)
# runs.test(blahyl_presence.1.ungrazed$Presence)
# view(sweetpotato)
# chisq.test(smallmammals_long1$Fire_interval, smallmammals_long$Count)

# view(smallmammals)
# unique(smallmammals$RECTYPE)
# 
# smallmammals_group_count1 <- smallmammals %>%  group_by(Watershed_name) %>% 
#   summarise(total_count=n(),.groups = 'drop')
# 
# smallmammals_group_count2 <- smallmammals %>%  group_by(RECYEAR, WATERSHED) %>% 
#   summarise(total_count=n(),.groups = 'drop')
# 
# smallmammals_group_count2 %>% ggplot(aes(x = RECYEAR, y = total_count, color = WATERSHED)) + geom_jitter(width = 0.2, height = 0.2)
# 
# 
# smallmammals_group_count3 <- smallmammals %>% 
#   group_by(RECYEAR, SEASON, WATERSHED) %>% 
#   summarise(total_count=n(),.groups = 'drop')




```


```{r}



#Grouping by species and then graphing by type
# smallmammals1_grouping <- smallmammals_long1%>% 
#   group_by(Recyear, Fire_interval, Grazing, Watershed_name, Species) %>% 
#   dplyr::reframe(Count = sum(Count))
# 
# 
# smallmammals1_grouping_1 <- smallmammals1_grouping %>%
#   dplyr::reframe(Mean_count = mean(Count), .by = c(Recyear, Watershed_name))
# 
# 
# 
# smallmammals1_grouping_1 %>% ggplot(aes(x = RECYEAR, y = Mean_count, group = Type)) + 
#   geom_line(aes(color = Type)) + geom_point(aes(color = Type)) + 
#   theme(text = element_text(size=10),
#         axis.text.x = element_text(angle=45, hjust=1))


```
